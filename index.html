<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GF">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Gerenciador Financeiro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 800px;
            margin: 18px 3px;        /* ‚Üê primeiro valor = topo/fundo, segundo = lados */
            background: white;
            border-radius: 20px;
            padding: 27px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 22px;
            font-weight: bold;
        }

        .mes-atual {
            color: #333;
            margin-bottom: 12px;
            font-size: 17px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .conta {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .conta.pago {
            opacity: 0.7;
            border-left-color: #28a745;
        }

        .conta.recebimento {
            border-left-color: #28a745;
        }

        .conta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .conta-nome {
            font-size: 15px;
            font-weight: bold;
            color: #333;
        }

        .conta-valor {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .conta.pago .conta-valor {
            color: #28a745;
        }

        .conta.recebimento .conta-valor {
            color: #28a745;
        }

        .pessoa {
            padding: 6px 0;
            color: #555;
            border-bottom: 1px dashed #ddd;
            font-size: 13px;
        }

        .pessoa:last-child {
            border-bottom: none;
        }

        .pessoa.pago {
            text-decoration: line-through;
            color: #999;
        }

        .info-conta {
            margin-top: 8px;
            color: #666;
            font-size: 12px;
        }

        .limite {
            color: #28a745;
            font-weight: bold;
        }

        .acoes {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .btn-pequeno {
            padding: 4px 3px;
            font-size: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-editar {
            background: #ffc107;
            color: #333;
        }

        .btn-editar:hover {
            background: #e0a800;
        }

        .btn-excluir {
            background: #dc3545;
            color: white;
        }

        .btn-excluir:hover {
            background: #c82333;
        }

        .btn-pagar {
            background: #28a745;
            color: white;
        }

        .btn-pagar:hover {
            background: #218838;
        }

        .total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 12px;
            text-align: center;
        }

        .total h2 {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .total-valor {
            font-size: 20px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.ativo {
            display: flex;
        }

        .modal-conteudo {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-grupo {
            margin-bottom: 14px;
        }

        .form-grupo label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 13px;
        }

        .form-grupo input, .form-grupo select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: border 0.3s;
        }

        .form-grupo input:focus, .form-grupo select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-grupo textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-grupo textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: border 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .pessoas-lista {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .pessoa-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .btn-remover {
            background: #dc3545;
            color: white;
            border: none;
            padding: 3px 7px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-editar-pessoa {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 3px 7px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-right: 4px;
        }

        .btn-adicionar-pessoa {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            font-size: 12px;
        }

        .form-acoes {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .form-acoes button {
            flex: 1;
        }

        .btn-cancelar {
            background: #6c757d;
            color: white;
        }

        .btn-cancelar:hover {
            background: #5a6268;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-pago {
            background: #28a745;
            color: white;
        }

        .badge-pendente {
            background: #ffc107;
            color: #333;
        }
        .btn-backup {
            position: fixed;
            top: 23px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #E6EE9C 60%);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 7px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 1000;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-backup:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .menu-backup {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 999;
            min-width: 180px;
        }

        .menu-backup.ativo {
            display: flex;
        }

        .menu-backup-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-backup-btn-salvar {
            background: #28a745;
            color: white;
        }

        .menu-backup-btn-salvar:hover {
            background: #218838;
        }

        .menu-backup-btn-carregar {
            background: #ffc107;
            color: #333;
        }

        .menu-backup-btn-carregar:hover {
            background: #e0a800;
        }

        .input-file-hidden {
            display: none;
        }
        .modal-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-menu.ativo {
            display: flex;
        }

        .modal-menu-conteudo {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-menu-titulo {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .menu-opcoes {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .menu-btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .menu-btn-adicionar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .menu-btn-adicionar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .menu-btn-editar {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
            color: #333;
        }

        .menu-btn-editar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        .menu-btn-cancelar {
            background: #6c757d;
            color: white;
        }

        .menu-btn-cancelar:hover {
            background: #5a6268;
        }

        .lista-compras {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .compra-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .compra-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .compra-nome {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .compra-valor {
            font-weight: bold;
            color: #667eea;
            font-size: 15px;
        }

        .compra-info {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .compra-acoes {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        .modal-form {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-form.ativo {
            display: flex;
        }

        .modal-form-conteudo {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 450px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-form-titulo {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-grupo-modal {
            margin-bottom: 16px;
        }

        .form-grupo-modal label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 13px;
        }

        .form-grupo-modal input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-grupo-modal input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-acoes-modal {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .form-acoes-modal button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-salvar-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-salvar-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-cancelar-modal {
            background: #6c757d;
            color: white;
        }

        .btn-cancelar-modal:hover {
            background: #5a6268;
        }
        .modal-pendencias {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-pendencias.ativo {
            display: flex;
        }

        .modal-pendencias-conteudo {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-pendencias-titulo {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-pendencias-subtitulo {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }

        .pendencia-mes {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .pendencia-mes-titulo {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pendencia-pessoa {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #dc3545;
        }

        .pendencia-pessoa-nome {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pendencia-compra {
            padding: 8px 0 8px 16px;
            border-left: 2px solid #e0e0e0;
            margin-left: 8px;
        }

        .pendencia-compra-nome {
            font-size: 13px;
            color: #555;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pendencia-compra-valor {
            font-size: 15px;
            font-weight: bold;
            color: #dc3545;
        }

        .pendencia-compra-info {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }

        .pendencia-total {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .pendencia-total-titulo {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .pendencia-total-valor {
            font-size: 24px;
            font-weight: bold;
        }

        .modal-pendencias-fechar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-pendencias-fechar:hover {
            background: #5a6268;
        }
        .modal-detalhes {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-detalhes.ativo {
            display: flex;
        }

        .modal-detalhes-conteudo {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 420px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-detalhes-header {
            margin-bottom: 20px;
        }

        .modal-detalhes-titulo {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-detalhes-subtitulo {
            font-size: 14px;
            color: #666;
        }

        .modal-detalhes-resumo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .modal-detalhes-resumo-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .modal-detalhes-resumo-valor {
            font-size: 22px;
            font-weight: bold;
        }

        .modal-detalhes-secao {
            margin-bottom: 16px;
        }

        .modal-detalhes-secao-titulo {
            font-size: 15px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detalhes-compra-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .detalhes-compra-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .detalhes-compra-card.recebimento {
            border-left-color: #28a745;
        }

        .detalhes-compra-nome {
            font-size: 15px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detalhes-compra-badge {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .detalhes-compra-badge.recebimento {
            background: #28a745;
        }

        .detalhes-compra-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .detalhes-compra-info-item {
            font-size: 12px;
            color: #666;
        }

        .detalhes-compra-info-label {
            font-weight: 600;
            color: #555;
        }

        .detalhes-compra-info-valor {
            color: #667eea;
            font-weight: bold;
        }

        .detalhes-compra-info-valor.recebimento {
            color: #28a745;
        }

        .modal-detalhes-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
        }

        .modal-detalhes-total.recebimento {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .modal-detalhes-total-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .modal-detalhes-total-valor {
            font-size: 20px;
            font-weight: bold;
        }

        .modal-detalhes-fechar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-detalhes-fechar:hover {
            background: #5a6268;
        }
        .modal-valor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-valor.ativo {
            display: flex;
        }

        .modal-valor-conteudo {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-valor-header {
            margin-bottom: 20px;
        }

        .modal-valor-titulo {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-valor-subtitulo {
            font-size: 14px;
            color: #666;
        }

        .modal-valor-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #667eea;
        }

        .modal-valor-card.recebimento {
            border-left-color: #28a745;
        }

        .modal-valor-card-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .modal-valor-card-valor {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .modal-valor-card-valor.recebimento {
            color: #28a745;
        }

        .modal-valor-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .modal-valor-info.recebimento {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .modal-valor-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .modal-valor-info-row:last-child {
            border-bottom: none;
        }

        .modal-valor-info-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .modal-valor-info-valor {
            font-size: 16px;
            font-weight: bold;
        }

        .modal-valor-destaque {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 14px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .modal-valor-destaque.alerta {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .modal-valor-destaque-texto {
            font-size: 14px;
            color: #1976D2;
            line-height: 1.6;
        }

        .modal-valor-destaque.alerta .modal-valor-destaque-texto {
            color: #856404;
        }

        .modal-valor-fechar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-valor-fechar:hover {
            background: #5a6268;
        }
        .modal-resumo {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-resumo.ativo {
            display: flex;
        }

        .modal-resumo-conteudo {
            background: white;
            border-radius: 16px;
            padding: 20px;          /* ‚Üê ESPA√áAMENTO INTERNO (espa√ßo entre borda e conte√∫do) */
            max-width: 420px;       /* ‚Üê LARGURA M√ÅXIMA do container */
            width: 90%;             /* ‚Üê largura em % (adapta em telas pequenas) */
            max-height: 90vh;       /* ‚Üê ALTURA M√ÅXIMA (80% da altura da tela) */
            overflow-y: auto;       /* ‚Üê permite rolar se passar da altura */
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-resumo-titulo {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .resumo-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .resumo-card.recebimentos {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .resumo-card.saldo-positivo {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .resumo-card.saldo-negativo {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .resumo-card-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .resumo-card-valor {
            font-size: 24px;
            font-weight: bold;
        }

        .resumo-divisor {
            border: none;
            border-top: 2px dashed #e0e0e0;
            margin: 20px 0;
        }

        .resumo-saldo {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }

        .resumo-saldo-header {
            text-align: center;
            margin-bottom: 12px;
        }

        .resumo-saldo-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
        }

        .resumo-saldo-valor {
            font-size: 28px;
            font-weight: bold;
        }

        .resumo-saldo-valor.positivo {
            color: #28a745;
        }

        .resumo-saldo-valor.negativo {
            color: #dc3545;
        }

        .resumo-saldo-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            margin-top: 8px;
        }

        .resumo-saldo-badge.positivo {
            background: #d4edda;
            color: #155724;
        }

        .resumo-saldo-badge.negativo {
            background: #f8d7da;
            color: #721c24;
        }

        .resumo-detalhes {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }

        .resumo-detalhes-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 14px;
        }

        .resumo-detalhes-label {
            color: #666;
        }

        .resumo-detalhes-valor {
            font-weight: bold;
            color: #333;
        }

        .resumo-icone-grande {
            font-size: 36px;
            text-align: center;
            margin: 12px 0;
        }

        .modal-resumo-fechar {
            position: fixed;
            bottom: 80px;           /* ‚Üê ALTURA (dist√¢ncia da parte inferior) */
            right: 35px;            /* ‚Üê dist√¢ncia da direita */
            background: #6c757d;  /* ‚Üê COR DE FUNDO do bot√£o X */
            color: white;           /* ‚Üê COR DO X (branco) */
            border: none;
            padding: 0;             /* ‚Üê PADDING (espa√ßamento interno) */
            border-radius: 6px;     /* ‚Üê arredondamento das bordas */
            cursor: pointer;
            width: 40px;            /* ‚Üê LARGURA do bot√£o */
            height: 40px;           /* ‚Üê ALTURA do bot√£o */
            font-size: 18px;        /* ‚Üê tamanho do X */
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            z-index: 3001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.85;          /* ‚Üê TRANSPAR√äNCIA (0 = invis√≠vel, 1 = opaco) */
        }

        .modal-resumo-fechar:hover {
            background: #c82333;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }

        .resumo-info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            font-size: 13px;
            color: #1976D2;
        }

        .pendencia-sem-resultado {
            text-align: center;
            padding: 40px 20px;
            color: #28a745;
        }

        .pendencia-sem-resultado-icone {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .pendencia-sem-resultado-texto {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .pendencia-sem-resultado-sub {
            font-size: 14px;
            color: #666;
        }
        .modal-limpar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal-limpar.ativo {
            display: flex;
        }

        .modal-limpar-conteudo {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            min-height: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-limpar-titulo {
            font-size: 20px;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-limpar-texto {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-limpar-aviso {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #856404;
        }

        .modal-limpar-acoes {
            display: flex;
            gap: 10px;
        }

        .modal-limpar-acoes button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-limpar-confirmar {
            background: #dc3545;
            color: white;
        }

        .btn-limpar-confirmar:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-limpar-cancelar {
            background: #6c757d;
            color: white;
        }

        .btn-limpar-cancelar:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
    <button class="btn-backup" onclick="toggleMenuBackup()" title="Backup">üíæ</button>
        <div class="menu-backup" id="menuBackup">
            <button class="menu-backup-btn menu-backup-btn-salvar" onclick="salvarBackup()">
                üíæ Salvar Backup
            </button>
            <button class="menu-backup-btn menu-backup-btn-carregar" onclick="document.getElementById('inputCarregarBackup').click()">
                üìÇ Carregar Backup
            </button>
            <input type="file" id="inputCarregarBackup" class="input-file-hidden" accept=".json" onchange="carregarBackup(event)">
        </div>
        <h1 id="tituloGastos" ontouchstart="iniciarLongPressLimpar(event)" ontouchend="cancelarLongPressLimpar()" ontouchmove="cancelarLongPressLimpar()" onmousedown="iniciarLongPressLimpar(event)" onmouseup="cancelarLongPressLimpar()" onmouseleave="cancelarLongPressLimpar()" style="cursor: pointer; user-select: none;" title="Mantenha pressionado para limpar dados">üí∞ Gastos do M√™s</h1>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 8px;">
            <button class="btn" onclick="voltarMes()" style="padding: 4px 8px; font-size: 11px; margin-bottom: 0; min-width: 50px;">‚óÄ Ant</button>
            <p class="mes-atual" id="mesAtual" style="margin: 0; text-align: center; flex: 1;"></p>
            <button class="btn" onclick="avancarMes()" style="padding: 4px 8px; font-size: 11px; margin-bottom: 0; min-width: 50px;">Prox ‚ñ∂</button>
        </div>
        
        <button class="btn" onclick="abrirModal()">‚ûï Adicionar Conta</button>
        
        <div id="listaContas"></div>
        
        <div class="total" style="cursor: pointer;" onclick="mostrarDetalhesTotal()" title="Clique para ver detalhes">
            <h2>Total Gastos:</h2>
            <div class="total-valor" id="totalValor">R$ 0,00</div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-conteudo">
            <h2 id="modalTitulo">Adicionar Conta</h2>
            <form id="formConta" onsubmit="salvarConta(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-grupo" style="grid-column: 1 / -1;">
                        <label>Nome da Conta:</label>
                        <input type="text" id="nomeConta" required>
                    </div>

                    <div class="form-grupo">
                        <label>Tipo de Transa√ß√£o:</label>
                        <select id="tipoTransacao" onchange="atualizarFormulario()">
                            <option value="pagamento">Pagamento</option>
                            <option value="recebimento">Recebimento</option>
                        </select>
                    </div>

                    <div class="form-grupo">
                        <label>Tipo:</label>
                        <select id="tipoConta" onchange="atualizarFormulario()">
                            <option value="cartao">Cart√£o de Cr√©dito</option>
                            <option value="boleto">Boleto/Conta</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                </div>

                <div id="camposCartao">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div class="form-grupo">
                            <label>Limite Total:</label>
                            <input type="number" id="limiteTotal" step="0.01">
                        </div>

                        <div class="form-grupo">
                            <label>Dia Fecha:</label>
                            <input type="number" id="diaFechamento" min="1" max="31">
                        </div>

                        <div class="form-grupo">
                            <label>Dia Venc:</label>
                            <input type="number" id="diaVencimento" min="1" max="31">
                        </div>
                    </div>
                </div>

                <div class="form-grupo">
                    <label>Nome da Compra/Descri√ß√£o:</label>
                    <input type="text" id="nomeCompra" placeholder="Ex: Fone de ouvido, Conta de luz...">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-grupo">
                        <label id="labelMeuValor">Meu Valor (opcional):</label>
                        <input type="number" id="meuValor" step="0.01" placeholder="0.00 (opcional)">
                    </div>

                    <div class="form-grupo">
                        <label>Parcelas:</label>
                        <input type="number" id="numeroParcelas" min="1" placeholder="1 ou vazio">
                    </div>
                </div>

                <div class="form-grupo">
                    <div class="checkbox-group">
                        <input type="checkbox" id="compraEmAndamento" onchange="toggleParcelasEmAndamento()">
                        <label for="compraEmAndamento" style="font-size: 12px;">Compra em andamento</label>
                    </div>
                </div>

                <div class="form-grupo" id="grupoParcelasNormal" style="display: none;">
                    <!-- Grupo vazio, apenas para compatibilidade com a fun√ß√£o toggle -->
                </div>

                <div class="form-grupo" id="grupoParcelasAndamento" style="display: none;">
                    <label>J√° pagas:</label>
                    <input type="number" id="parcelasJaPagas" min="0" placeholder="0">
                </div>

                <div class="form-grupo">
                    <div class="checkbox-group">
                        <input type="checkbox" id="contaRecorrente" onchange="toggleContaRecorrente()">
                        <label for="contaRecorrente" style="font-size: 12px;">Conta recorrente (√°gua, luz, plano...)</label>
                    </div>
                </div>
<div class="form-grupo" id="grupoObservacoes">
                    <label>Observa√ß√µes:</label>
                    <textarea id="observacoes" placeholder="Ex: Pagamento quinzenal, PIX, etc...&#10;Pressione Enter para nova linha" rows="3" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; resize: vertical; transition: border 0.3s;"></textarea>
                </div>
                <div class="form-grupo">
                    <label>Outras Pessoas/Parcelas:</label>
                    <div class="pessoas-lista" id="pessoasLista"></div>
                    <button type="button" class="btn-adicionar-pessoa" onclick="adicionarPessoa()">+ Adicionar Pessoa/Parcela</button>
                </div>

                <div class="form-grupo">
                    <div class="checkbox-group">
                        <input type="checkbox" id="contaPaga">
                        <label for="contaPaga">Marcar como pago</label>
                    </div>
                </div>

                <div class="form-acoes">
                    <button type="button" class="btn btn-cancelar" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="btn">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-form" id="modalForm">
        <div class="modal-form-conteudo">
            <h3 class="modal-form-titulo" id="modalFormTitulo"></h3>
            <div id="modalFormConteudo"></div>
        </div>
    </div>
    <div class="modal-valor" id="modalValor">
        <div class="modal-valor-conteudo">
            <div class="modal-valor-header">
                <h3 class="modal-valor-titulo" id="modalValorTitulo"></h3>
                <p class="modal-valor-subtitulo" id="modalValorSubtitulo"></p>
            </div>
            <div id="modalValorConteudo"></div>
            <button class="modal-valor-fechar" onclick="fecharModalValor()">‚úï Fechar</button>
        </div>
    </div>
    <div class="modal-resumo" id="modalResumo">
        <div class="modal-resumo-conteudo">
            <h3 class="modal-resumo-titulo">üìä Resumo Financeiro do M√™s</h3>
            <div id="modalResumoConteudo"></div>
            <button class="modal-resumo-fechar" onclick="fecharModalResumo()">‚úï</button>
        </div>
    </div>
    <div class="modal-detalhes" id="modalDetalhes">
        <div class="modal-detalhes-conteudo">
            <div class="modal-detalhes-header">
                <h3 class="modal-detalhes-titulo" id="modalDetalhesTitulo"></h3>
                <p class="modal-detalhes-subtitulo" id="modalDetalhesSubtitulo"></p>
            </div>
            <div id="modalDetalhesConteudo"></div>
            <button class="modal-detalhes-fechar" onclick="fecharModalDetalhes()">‚úï Fechar</button>
        </div>
    </div>
    <div class="modal-pendencias" id="modalPendencias">
        <div class="modal-pendencias-conteudo">
            <h3 class="modal-pendencias-titulo" id="modalPendenciasTitulo"></h3>
            <p class="modal-pendencias-subtitulo" id="modalPendenciasSubtitulo"></p>
            <div id="modalPendenciasConteudo"></div>
            <button class="modal-pendencias-fechar" onclick="fecharModalPendencias()">‚úï Fechar</button>
        </div>
    </div>
    <!-- PAINEL DE DEBUG -->
    <div id="painelDebug" style="position: fixed; top: 80px; left: 10px; width: 350px; max-height: 450px; background: white; border: 3px solid #667eea; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 5000; display: none; flex-direction: column;">
        <div id="debugHeader" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none;">
            <span style="font-weight: bold; font-size: 14px;">üêõ LOG DE DEBUG</span>
            <button onclick="fecharDebug()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úï</button>
        </div>
        <div id="debugConteudo" style="padding: 12px; overflow-y: auto; max-height: 350px; font-family: 'Courier New', monospace; font-size: 11px; background: #f8f9fa;">
            <p style="color: #999; text-align: center; padding: 20px;">Nenhum log registrado ainda...</p>
        </div>
        <div style="padding: 10px; border-top: 2px solid #e0e0e0; display: flex; gap: 8px;">
            <button onclick="copiarLog()" style="flex: 1; background: #28a745; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">üìã Copiar Log</button>
            <button onclick="limparLog()" style="flex: 1; background: #dc3545; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">üóëÔ∏è Limpar</button>
        </div>
    </div>

    <!-- BOT√ÉO FLUTUANTE DE DEBUG -->
    <button id="btnDebug" onclick="toggleDebug()" style="position: fixed; top: 23px; left: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 14px; border-radius: 50px; cursor: pointer; font-size: 13px; font-weight: bold; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); z-index: 4999; transition: all 0.3s; display: none;">  <!-- o "display: none" √© respons√°vel por desativar o sistema Debug, para reativar √© s√≥ remov√™-lo -->
        üêõ DEBUG
    </button>
    <div class="modal-limpar" id="modalLimpar">
        <div class="modal-limpar-conteudo">
            <h3 class="modal-limpar-titulo">‚ö†Ô∏è LIMPAR DADOS</h3>
            <p class="modal-limpar-texto">
                Voc√™ est√° prestes a <strong>APAGAR TODOS OS DADOS</strong> do Gestor Financeiro.
            </p>
            <div class="modal-limpar-aviso">
                <strong>‚ö†Ô∏è ESCOLHA O TIPO DE LIMPEZA:</strong>
            </div>
            <div style="margin-bottom: 16px;">
                <button class="btn-limpar-confirmar" onclick="limparApenasCache()" style="width: 100%; margin-bottom: 10px; background: #ffc107; color: #333;">
                    üßπ Limpar Apenas Cache/Configura√ß√µes
                </button>
                <p style="font-size: 11px; color: #666; margin: -6px 0 16px 0; text-align: center;">
                    Remove apenas cache e configura√ß√µes antigas.<br>
                    <strong>Mant√©m todos os dados financeiros</strong>
                </p>
                
                <button class="btn-limpar-confirmar" onclick="confirmarLimpezaTotal()" style="width: 100%;">
                    üóëÔ∏è Limpar TUDO (Dados + Cache)
                </button>
                <p style="font-size: 11px; color: #dc3545; margin: 10px 0 0 0; text-align: center;">
                    <strong>‚ö†Ô∏è Apaga TODOS os dados!</strong> N√£o pode ser desfeito.
                </p>
            </div>
            <div class="modal-limpar-acoes">
                <button class="btn-limpar-cancelar" onclick="fecharModalLimpar()" style="width: 100%;">‚úï Cancelar</button>
            </div>
        </div>
    </div>
<div class="modal-menu" id="modalMenu">
        <div class="modal-menu-conteudo">
            <h3 class="modal-menu-titulo" id="modalMenuTitulo"></h3>
            <div id="modalMenuConteudo"></div>
        </div>
    </div>
    <script>
        let contas = [];
        let contaEditando = null;
        let pessoasTemp = [];
        const VERSAO_ATUAL = '2.0'; // Aumente este n√∫mero quando fizer altera√ß√µes importantes
        let longPressTimer = null;
        let debugLogs = [];
        let debugAtivo = false;
        let longPressTimerLimpar = null;
        let mesAtual = new Date();
        let todasContas = {}; // Armazena contas de todos os meses
        let historicoLimitePago = {}; // Armazena valores j√° pagos por cart√£o
        let dataUltimaAtualizacao = null;
        
        function toggleParcelasEmAndamento() {
            const checkbox = document.getElementById('compraEmAndamento');
            const grupoAndamento = document.getElementById('grupoParcelasAndamento');
            
            if (checkbox.checked) {
                grupoAndamento.style.display = 'block';
            } else {
                grupoAndamento.style.display = 'none';
            }
        }

        
        function toggleContaRecorrente() {
            const checkbox = document.getElementById('contaRecorrente');
            const camposParcelas = document.getElementById('numeroParcelas');
            const checkboxAndamento = document.getElementById('compraEmAndamento');
            
            if (checkbox.checked) {
                camposParcelas.value = '';
                camposParcelas.disabled = true;
                camposParcelas.placeholder = 'Recorrente';
                checkboxAndamento.checked = false;
                checkboxAndamento.disabled = true;
                toggleParcelasEmAndamento();
            } else {
                camposParcelas.disabled = false;
                camposParcelas.placeholder = '1 ou vazio';
                checkboxAndamento.disabled = false;
            }
        }
        function toggleParcelasEmAndamentoForm() {
            const checkbox = document.getElementById('compraEmAndamentoForm');
            const grupoAndamento = document.getElementById('grupoParcelasAndamentoForm');
            
            if (checkbox.checked) {
                grupoAndamento.style.display = 'block';
            } else {
                grupoAndamento.style.display = 'none';
            }
        }

        function toggleContaRecorrenteForm() {
            const checkbox = document.getElementById('contaRecorrenteForm');
            const camposParcelas = document.getElementById('numParcelasForm');
            const checkboxAndamento = document.getElementById('compraEmAndamentoForm');
            
            if (checkbox.checked) {
                camposParcelas.value = '';
                camposParcelas.disabled = true;
                camposParcelas.placeholder = 'Recorrente';
                checkboxAndamento.checked = false;
                checkboxAndamento.disabled = true;
                toggleParcelasEmAndamentoForm();
            } else {
                camposParcelas.disabled = false;
                camposParcelas.placeholder = '1 ou vazio';
                checkboxAndamento.disabled = false;
            }
        }
        function toggleParcelasEmAndamentoAddForm() {
            const checkbox = document.getElementById('compraEmAndamentoAddForm');
            const grupoAndamento = document.getElementById('grupoParcelasAndamentoAddForm');
            
            if (checkbox.checked) {
                grupoAndamento.style.display = 'block';
            } else {
                grupoAndamento.style.display = 'none';
            }
        }

        function toggleContaRecorrenteAddForm() {
            const checkbox = document.getElementById('contaRecorrenteAddForm');
            const camposParcelas = document.getElementById('numParcelasAddForm');
            const checkboxAndamento = document.getElementById('compraEmAndamentoAddForm');
            
            if (checkbox.checked) {
                camposParcelas.value = '';
                camposParcelas.disabled = true;
                camposParcelas.placeholder = 'Recorrente';
                checkboxAndamento.checked = false;
                checkboxAndamento.disabled = true;
                toggleParcelasEmAndamentoAddForm();
            } else {
                camposParcelas.disabled = false;
                camposParcelas.placeholder = '1 ou vazio';
                checkboxAndamento.disabled = false;
            }
        }
        
        function toggleParcelasEmAndamentoEditTemp() {
            const checkbox = document.getElementById('compraEmAndamentoEditTemp');
            const grupoAndamento = document.getElementById('grupoParcelasAndamentoEditTemp');
            
            if (checkbox.checked) {
                grupoAndamento.style.display = 'block';
            } else {
                grupoAndamento.style.display = 'none';
            }
        }
        
        function toggleContaRecorrenteEditTemp() {
            const checkbox = document.getElementById('contaRecorrenteEditTemp');
            const camposParcelas = document.getElementById('numParcelasEditTemp');
            const checkboxAndamento = document.getElementById('compraEmAndamentoEditTemp');
            
            if (checkbox.checked) {
                camposParcelas.value = '';
                camposParcelas.disabled = true;
                camposParcelas.placeholder = 'Recorrente';
                checkboxAndamento.checked = false;
                checkboxAndamento.disabled = true;
                toggleParcelasEmAndamentoEditTemp();
            } else {
                camposParcelas.disabled = false;
                camposParcelas.placeholder = '1 ou vazio';
                checkboxAndamento.disabled = false;
            }
        }
        
        function toggleParcelasEmAndamentoEditCompraForm() {
            const checkbox = document.getElementById('compraEmAndamentoEditCompraForm');
            const grupoAndamento = document.getElementById('grupoParcelasAndamentoEditCompraForm');
            
            if (checkbox.checked) {
                grupoAndamento.style.display = 'block';
            } else {
                grupoAndamento.style.display = 'none';
            }
        }
        
        function toggleContaRecorrenteEditCompraForm() {
            const checkbox = document.getElementById('contaRecorrenteEditCompraForm');
            const camposParcelas = document.getElementById('numParcelasEditForm');
            const checkboxAndamento = document.getElementById('compraEmAndamentoEditCompraForm');
            
            if (checkbox.checked) {
                camposParcelas.value = '';
                camposParcelas.disabled = true;
                camposParcelas.placeholder = 'Recorrente';
                checkboxAndamento.checked = false;
                checkboxAndamento.disabled = true;
                toggleParcelasEmAndamentoEditCompraForm();
            } else {
                camposParcelas.disabled = false;
                camposParcelas.placeholder = '1 ou vazio';
                checkboxAndamento.disabled = false;
            }
        }

function voltarMes() {
            adicionarLog(`‚¨ÖÔ∏è VOLTANDO M√äS`, 'importante');
            
            // Salvar estado atual antes de voltar
            const chaveAtual = getChaveMes();
            adicionarLog(`   Salvando m√™s atual: ${chaveAtual}`, 'info');
            
            if (contas.length > 0) {
                todasContas[chaveAtual] = JSON.parse(JSON.stringify(contas));
                localStorage.setItem('todasContas', JSON.stringify(todasContas));
                adicionarLog(`   ‚úÖ ${contas.length} contas salvas`, 'success');
            }
            
            mesAtual.setMonth(mesAtual.getMonth() - 1);
            const novaMesChave = getChaveMes();
            adicionarLog(`   Novo m√™s: ${novaMesChave}`, 'info');
            
            // Salvar o novo m√™s atual
            localStorage.setItem('mesAtualSalvo', JSON.stringify({
                ano: mesAtual.getFullYear(),
                mes: mesAtual.getMonth()
            }));
            
            // FOR√áAR recarga completa do localStorage
            const dadosAtualizados = localStorage.getItem('todasContas');
            if (dadosAtualizados) {
                todasContas = JSON.parse(dadosAtualizados);
                adicionarLog(`   üì• Dados recarregados do localStorage`, 'info');
            }
            
            atualizarVisualizacao();
            adicionarLog(`‚úÖ Visualiza√ß√£o atualizada`, 'success');
        }
        
        function avancarMes() {
            // Salvar estado atual antes de avan√ßar
            const chaveAtual = getChaveMes();
            if (contas.length > 0) {
                todasContas[chaveAtual] = JSON.parse(JSON.stringify(contas));
                localStorage.setItem('todasContas', JSON.stringify(todasContas));
            }
            
            mesAtual.setMonth(mesAtual.getMonth() + 1);
            
            // Salvar o novo m√™s atual
            localStorage.setItem('mesAtualSalvo', JSON.stringify({
                ano: mesAtual.getFullYear(),
                mes: mesAtual.getMonth()
            }));
            
            // FOR√áAR recarga completa do localStorage
            const dadosAtualizados = localStorage.getItem('todasContas');
            if (dadosAtualizados) {
                todasContas = JSON.parse(dadosAtualizados);
            }
            
            atualizarVisualizacao();
        }

        function inicializar() {
            // Verificar vers√£o e fazer migra√ß√£o se necess√°rio
            verificarEMigrarVersao();
            
            carregarTodasContas();
            const dataArmazenada = localStorage.getItem('dataUltimaAtualizacao');
            if (dataArmazenada) {
                dataUltimaAtualizacao = dataArmazenada;
            }
            
            // Carregar o m√™s salvo anteriormente
            const mesAtualSalvo = localStorage.getItem('mesAtualSalvo');
            if (mesAtualSalvo) {
                try {
                    const dadosMes = JSON.parse(mesAtualSalvo);
                    mesAtual = new Date(dadosMes.ano, dadosMes.mes);
                } catch (e) {
                    // Se houver erro, manter o m√™s atual
                    mesAtual = new Date();
                }
            }
            
            atualizarVisualizacao();
        }
        
        function atualizarVisualizacao() {
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('mesAtual').textContent = `${meses[mesAtual.getMonth()]} de ${mesAtual.getFullYear()}`;
            
            carregarContasMesAtual();
            renderizarContas();
        }

        function getChaveMes() {
            return `${mesAtual.getFullYear()}-${String(mesAtual.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function carregarTodasContas() {
            const dados = localStorage.getItem('todasContas');
            if (dados) {
                try {
                    const dadosCarregados = JSON.parse(dados);
                    
                    // Validar estrutura b√°sica dos dados
                    if (typeof dadosCarregados === 'object' && dadosCarregados !== null) {
                        todasContas = dadosCarregados;
                        
                        // Limpar dados corrompidos ou inv√°lidos
                        Object.keys(todasContas).forEach(chaveMes => {
                            if (!Array.isArray(todasContas[chaveMes])) {
                                delete todasContas[chaveMes];
                            } else {
                                // Validar cada conta
                                todasContas[chaveMes] = todasContas[chaveMes].filter(conta => {
                                    return conta && 
                                           typeof conta === 'object' && 
                                           conta.nome && 
                                           Array.isArray(conta.pessoas);
                                });
                                
                                // Remover m√™s se ficou vazio
                                if (todasContas[chaveMes].length === 0) {
                                    delete todasContas[chaveMes];
                                }
                            }
                        });
                    } else {
                        todasContas = {};
                    }
                } catch (e) {
                    console.error('Erro ao carregar dados. Iniciando limpo.', e);
                    todasContas = {};
                }
            }
        }
        function calcularValorJaPago(nomeConta) {
            const chaveAtual = getChaveMes();
            const [anoAtual, mesAtual] = chaveAtual.split('-').map(Number);
            
            let totalPago = 0;
            
            // Percorre todos os meses anteriores
            Object.keys(todasContas).forEach(chaveMes => {
                const [ano, mes] = chaveMes.split('-').map(Number);
                const dataMes = new Date(ano, mes - 1);
                const dataAtualMes = new Date(anoAtual, mesAtual - 1);
                
                // Se for m√™s anterior
                if (dataMes < dataAtualMes) {
                    const contasMes = todasContas[chaveMes];
                    const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                    
                    if (contaEncontrada) {
                        contaEncontrada.pessoas.forEach(pessoa => {
                            if (pessoa.pago) {
                                if (pessoa.compras && pessoa.compras.length > 0) {
                                    // Se tem compras detalhadas, soma o valor das parcelas
                                    pessoa.compras.forEach(compra => {
                                        totalPago += compra.valorParcela || 0;
                                    });
                                } else {
                                    // Se n√£o tem compras, usa o valor direto da pessoa
                                    totalPago += pessoa.valor || 0;
                                }
                            }
                        });
                    }
                }
            });
            
            return totalPago;
        }
        function carregarContasMesAtual() {
            const chave = getChaveMes();
            const [anoAtual, mesAtualNum] = chave.split('-').map(Number);
            const dataAtualMes = new Date(anoAtual, mesAtualNum - 1);
            
            // FOR√áAR RECARGA COMPLETA do localStorage
            const dadosStorage = localStorage.getItem('todasContas');
            if (dadosStorage) {
                try {
                    todasContas = JSON.parse(dadosStorage);
                } catch (e) {
                    console.error('Erro ao carregar dados:', e);
                    todasContas = {};
                }
            }
            
            // SEMPRE verificar status de recebimentos em tempo
            if (todasContas[chave]) {
                // M√™s existe - carregar e CONSOLIDAR
                const dadosSalvos = JSON.parse(JSON.stringify(todasContas[chave]));
                contas = [];
                
                // Reprocessar cada conta COM CONSOLIDA√á√ÉO
                dadosSalvos.forEach(contaSalva => {
                    if (contaSalva.tipoTransacao === 'recebimento') {
                        // Para recebimentos, verificar em tempo real
                        const pessoasFiltradas = [];
                        
                        contaSalva.pessoas.forEach(pessoaSalva => {
                            // Criar ID √∫nico do recebimento
                            let idRecebimento = '';
                            if (pessoaSalva.compras && pessoaSalva.compras[0]) {
                                idRecebimento = pessoaSalva.compras[0].idUnico || 
                                    (pessoaSalva.compras[0].nome + '_' + pessoaSalva.compras[0].dataCompra);
                            } else {
                                idRecebimento = pessoaSalva.nome + '_' + contaSalva.nome + '_' + (pessoaSalva.valorTotal || pessoaSalva.valor);
                            }
                            
                            let deveManter = false;
                            
                            // RECEBIMENTO PARCELADO
                            if (pessoaSalva.parcelas && pessoaSalva.parcelas !== 'recorrente') {
                                const match = pessoaSalva.parcelas.match(/(\d+)\/(\d+)/);
                                if (match) {
                                    const totalParcelas = parseInt(match[2]);
                                    
                                    // RECARREGAR dados do localStorage
                                    const dadosFrescos = localStorage.getItem('todasContas');
                                    let todasContasFrescas = todasContas;
                                    if (dadosFrescos) {
                                        try {
                                            todasContasFrescas = JSON.parse(dadosFrescos);
                                        } catch (e) {
                                            todasContasFrescas = todasContas;
                                        }
                                    }
                                    
                                    let parcelasPagasTotal = 0;
                                    let pagamentoNesteMes = false;
                                    let pagamentoEmMesAnterior = false;
                                    
                                    // Contar parcelas pagas
                                    Object.keys(todasContasFrescas).forEach(chaveMesCheck => {
                                        const [anoCheck, mesCheck] = chaveMesCheck.split('-').map(Number);
                                        const dataMesCheck = new Date(anoCheck, mesCheck - 1);
                                        
                                        const contasMesCheck = todasContasFrescas[chaveMesCheck];
                                        const contaCheck = contasMesCheck.find(c => c.nome === contaSalva.nome);
                                        
                                        if (contaCheck) {
                                            contaCheck.pessoas.forEach(pCheck => {
                                                let idCheck = '';
                                                if (pCheck.compras && pCheck.compras[0]) {
                                                    idCheck = pCheck.compras[0].idUnico || 
                                                        (pCheck.compras[0].nome + '_' + pCheck.compras[0].dataCompra);
                                                } else {
                                                    idCheck = pCheck.nome + '_' + contaSalva.nome + '_' + (pCheck.valorTotal || pCheck.valor);
                                                }
                                                
                                                if (idCheck === idRecebimento && pCheck.pago) {
                                                    parcelasPagasTotal++;
                                                    
                                                    if (chaveMesCheck === chave) {
                                                        pagamentoNesteMes = true;
                                                    } else if (dataMesCheck < dataAtualMes) {
                                                        pagamentoEmMesAnterior = true;
                                                    }
                                                }
                                            });
                                        }
                                    });
                                    
                                    if (parcelasPagasTotal < totalParcelas) {
                                        deveManter = true;
                                    } else {
                                        if (pagamentoNesteMes) {
                                            deveManter = true;
                                        } else if (pagamentoEmMesAnterior) {
                                            deveManter = false;
                                        } else {
                                            deveManter = true;
                                        }
                                    }
                                }
                            } else {
                                // RECEBIMENTO √öNICO
                                const dadosFrescos = localStorage.getItem('todasContas');
                                let todasContasFrescas = todasContas;
                                if (dadosFrescos) {
                                    try {
                                        todasContasFrescas = JSON.parse(dadosFrescos);
                                    } catch (e) {
                                        todasContasFrescas = todasContas;
                                    }
                                }
                                
                                let foiPagoEmMesAnterior = false;
                                
                                Object.keys(todasContasFrescas).forEach(chaveMesCheck => {
                                    const [anoCheck, mesCheck] = chaveMesCheck.split('-').map(Number);
                                    const dataMesCheck = new Date(anoCheck, mesCheck - 1);
                                    
                                    if (dataMesCheck < dataAtualMes) {
                                        const contasMesCheck = todasContasFrescas[chaveMesCheck];
                                        const contaCheck = contasMesCheck.find(c => c.nome === contaSalva.nome);
                                        
                                        if (contaCheck) {
                                            contaCheck.pessoas.forEach(pCheck => {
                                                let idCheck = '';
                                                if (pCheck.compras && pCheck.compras[0]) {
                                                    idCheck = pCheck.compras[0].idUnico || 
                                                        (pCheck.compras[0].nome + '_' + pCheck.compras[0].dataCompra);
                                                } else {
                                                    idCheck = pCheck.nome + '_' + contaSalva.nome + '_' + (pCheck.valorTotal || pCheck.valor);
                                                }
                                                
                                                if (idCheck === idRecebimento && pCheck.pago) {
                                                    foiPagoEmMesAnterior = true;
                                                }
                                            });
                                        }
                                    }
                                });
                                
                                deveManter = !foiPagoEmMesAnterior;
                            }
                            
                            if (deveManter) {
                                pessoasFiltradas.push(pessoaSalva);
                            }
                        });
                        
                        // CONSOLIDAR pessoas antes de adicionar
                        const pessoasConsolidadas = consolidarPessoasPorNome(pessoasFiltradas);
                        
                        contas.push({
                            ...contaSalva,
                            pessoas: pessoasConsolidadas
                        });
                    } else {
                        // PAGAMENTOS: CONSOLIDAR pessoas
                        const pessoasConsolidadas = consolidarPessoasPorNome(contaSalva.pessoas);
                        
                        contas.push({
                            ...contaSalva,
                            pessoas: pessoasConsolidadas
                        });
                    }
                });
                
            } else {
                // Criar novo m√™s PRESERVANDO A ORDEM das contas
                contas = [];
                const contasMap = new Map();
                
                // PRIMEIRO: Determinar ordem das contas do m√™s mais recente
                let ordemContas = [];
                const chavesOrdenadas = Object.keys(todasContas).sort().reverse();
                
                for (let chaveMesRef of chavesOrdenadas) {
                    if (todasContas[chaveMesRef] && todasContas[chaveMesRef].length > 0) {
                        ordemContas = todasContas[chaveMesRef].map(c => c.nome);
                        break;
                    }
                }
                
                Object.keys(todasContas).sort().forEach(chaveMes => {
                    const [ano, mes] = chaveMes.split('-').map(Number);
                    const dataMes = new Date(ano, mes - 1);
                    
                    if (dataMes < dataAtualMes) {
                        const contasMes = todasContas[chaveMes];
                        const diffMesesDesdeOrigem = (anoAtual - ano) * 12 + (mesAtualNum - mes);
                        
                        contasMes.forEach(conta => {
                            if (!contasMap.has(conta.nome)) {
                                contasMap.set(conta.nome, {
                                    ...conta,
                                    id: Date.now() + Math.random(),
                                    pago: false,
                                    pessoas: []
                                });
                            }
                            
                            const contaAtual = contasMap.get(conta.nome);
                            
                            conta.pessoas.forEach(pessoa => {
                                // RECEBIMENTOS
                                if (conta.tipoTransacao === 'recebimento') {
                                    let idRecebimento = '';
                                    if (pessoa.compras && pessoa.compras[0]) {
                                        idRecebimento = pessoa.compras[0].idUnico || 
                                            (pessoa.compras[0].nome + '_' + pessoa.compras[0].dataCompra);
                                    } else {
                                        idRecebimento = pessoa.nome + '_' + conta.nome + '_' + (pessoa.valorTotal || pessoa.valor);
                                    }
                                    
                                    if (pessoa.parcelas && pessoa.parcelas !== 'recorrente') {
                                        const match = pessoa.parcelas.match(/(\d+)\/(\d+)/);
                                        if (match) {
                                            const parcelaOriginalDoMes = parseInt(match[1]);
                                            const totalParcelas = parseInt(match[2]);
                                            const parcelaNoMesAtual = parcelaOriginalDoMes + diffMesesDesdeOrigem;
                                            
                                            let totalParcelasPagas = 0;
                                            
                                            Object.keys(todasContas).forEach(chaveMesCheck => {
                                                const contasMesCheck = todasContas[chaveMesCheck];
                                                const contaCheck = contasMesCheck.find(c => c.nome === conta.nome);
                                                
                                                if (contaCheck) {
                                                    contaCheck.pessoas.forEach(pCheck => {
                                                        let idCheck = '';
                                                        if (pCheck.compras && pCheck.compras[0]) {
                                                            idCheck = pCheck.compras[0].idUnico || 
                                                                (pCheck.compras[0].nome + '_' + pCheck.compras[0].dataCompra);
                                                        } else {
                                                            idCheck = pCheck.nome + '_' + conta.nome + '_' + (pCheck.valorTotal || pCheck.valor);
                                                        }
                                                        
                                                        if (idCheck === idRecebimento && pCheck.pago) {
                                                            totalParcelasPagas++;
                                                        }
                                                    });
                                                }
                                            });
                                            
                                            if (totalParcelasPagas < totalParcelas) {
                                                const parcelaParaMostrar = Math.min(parcelaNoMesAtual, totalParcelas);
                                                
                                                if (pessoa.compras && pessoa.compras.length > 0) {
                                                    pessoa.compras.forEach(compra => {
                                                        contaAtual.pessoas.push({
                                                            nome: pessoa.nome,
                                                            valor: compra.valorParcela,
                                                            valorTotal: compra.valorTotal,
                                                            parcelas: `${parcelaParaMostrar}/${totalParcelas}`,
                                                            compras: [{
                                                                ...compra,
                                                                parcelas: `${parcelaParaMostrar}/${totalParcelas}`
                                                            }],
                                                            pago: false
                                                        });
                                                    });
                                                } else {
                                                    contaAtual.pessoas.push({
                                                        ...pessoa,
                                                        parcelas: `${parcelaParaMostrar}/${totalParcelas}`,
                                                        pago: false
                                                    });
                                                }
                                            }
                                        }
                                    } else {
                                        let foiPagoEmMesAnterior = false;
                                        
                                        Object.keys(todasContas).forEach(chaveMesCheck => {
                                            const [anoCheck, mesCheck] = chaveMesCheck.split('-').map(Number);
                                            const dataMesCheck = new Date(anoCheck, mesCheck - 1);
                                            
                                            if (dataMesCheck < dataAtualMes) {
                                                const contasMesCheck = todasContas[chaveMesCheck];
                                                const contaCheck = contasMesCheck.find(c => c.nome === conta.nome);
                                                
                                                if (contaCheck) {
                                                    contaCheck.pessoas.forEach(pCheck => {
                                                        let idCheck = '';
                                                        if (pCheck.compras && pCheck.compras[0]) {
                                                            idCheck = pCheck.compras[0].idUnico || 
                                                                (pCheck.compras[0].nome + '_' + pCheck.compras[0].dataCompra);
                                                        } else {
                                                            idCheck = pCheck.nome + '_' + conta.nome + '_' + (pCheck.valorTotal || pCheck.valor);
                                                        }
                                                        
                                                        if (idCheck === idRecebimento && pCheck.pago) {
                                                            foiPagoEmMesAnterior = true;
                                                        }
                                                    });
                                                }
                                            }
                                        });
                                        
                                        if (!foiPagoEmMesAnterior) {
                                            contaAtual.pessoas.push({
                                                ...pessoa,
                                                pago: false
                                            });
                                        }
                                    }
                                } else {
                                    // *** CORRE√á√ÉO CR√çTICA: PAGAMENTOS ***
                                    if (pessoa.parcelas === 'recorrente') {
                                        contaAtual.pessoas.push({
                                            ...pessoa,
                                            pago: false
                                        });
                                    } else if (pessoa.parcelas) {
                                        const match = pessoa.parcelas.match(/(\d+)\/(\d+)/);
                                        if (match) {
                                            const parcelaOriginalDoMes = parseInt(match[1]);
                                            const totalParcelas = parseInt(match[2]);
                                            
                                            // *** USAR _parcelaBase SE EXISTIR ***
                                            let parcelaBase = parcelaOriginalDoMes;
                                            let mesBase = chaveMes;
                                            
                                            // CR√çTICO: Verificar TODAS as compras da pessoa
                                            if (pessoa.compras && pessoa.compras.length > 0) {
                                                pessoa.compras.forEach(compra => {
                                                    // Usar parcela base SE existir
                                                    let compraParcelaBase = parcelaOriginalDoMes;
                                                    let compraMesBase = chaveMes;
                                                    
                                                    if (compra._parcelaBase && compra._mesBase) {
                                                        compraParcelaBase = compra._parcelaBase;
                                                        compraMesBase = compra._mesBase;
                                                    }
                                                    
                                                    // Calcular diferen√ßa de meses desde o m√™s base DA COMPRA
                                                    const [anoBase, mesBase_] = compraMesBase.split('-').map(Number);
                                                    const diffMesesDesdeMesBase = (anoAtual - anoBase) * 12 + (mesAtualNum - mesBase_);
                                                    
                                                    const parcelaNoMesAtual = compraParcelaBase + diffMesesDesdeMesBase;
                                                    
                                                    // Verificar total de parcelas DA COMPRA ESPEC√çFICA
                                                    const compraMatch = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                                    const compraTotalParc = compraMatch ? parseInt(compraMatch[2]) : totalParcelas;
                                                    
                                                    if (parcelaNoMesAtual <= compraTotalParc && parcelaNoMesAtual > 0) {
                                                        contaAtual.pessoas.push({
                                                            nome: pessoa.nome,
                                                            valor: compra.valorParcela,
                                                            valorTotal: compra.valorTotal,
                                                            parcelas: `${parcelaNoMesAtual}/${compraTotalParc}`,
                                                            compras: [{
                                                                ...compra,
                                                                parcelas: `${parcelaNoMesAtual}/${compraTotalParc}`,
                                                                _parcelaBase: compraParcelaBase,
                                                                _mesBase: compraMesBase
                                                            }],
                                                            pago: false
                                                        });
                                                    }
                                                });
                                            } else {
                                                // Sem compras detalhadas - usar l√≥gica antiga
                                                if (pessoa._parcelaBase && pessoa._mesBase) {
                                                    parcelaBase = pessoa._parcelaBase;
                                                    mesBase = pessoa._mesBase;
                                                }
                                                
                                                const [anoBase, mesBase_] = mesBase.split('-').map(Number);
                                                const diffMesesDesdeMesBase = (anoAtual - anoBase) * 12 + (mesAtualNum - mesBase_);
                                                
                                                const parcelaNoMesAtual = parcelaBase + diffMesesDesdeMesBase;
                                                
                                                if (parcelaNoMesAtual <= totalParcelas && parcelaNoMesAtual > 0) {
                                                    contaAtual.pessoas.push({
                                                        ...pessoa,
                                                        parcelas: `${parcelaNoMesAtual}/${totalParcelas}`,
                                                        pago: false
                                                    });
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        });
                    }
                });
                
                // Converter Map para array RESPEITANDO A ORDEM
                if (ordemContas.length > 0) {
                    // Usar ordem do m√™s anterior
                    ordemContas.forEach(nomeConta => {
                        if (contasMap.has(nomeConta)) {
                            const conta = contasMap.get(nomeConta);
                            const pessoasConsolidadas = consolidarPessoasPorNome(conta.pessoas);
                            
                            contas.push({
                                ...conta,
                                pessoas: pessoasConsolidadas
                            });
                            
                            contasMap.delete(nomeConta);
                        }
                    });
                    
                    // Adicionar contas novas que n√£o estavam na ordem
                    contasMap.forEach(conta => {
                        const pessoasConsolidadas = consolidarPessoasPorNome(conta.pessoas);
                        
                        contas.push({
                            ...conta,
                            pessoas: pessoasConsolidadas
                        });
                    });
                } else {
                    // Sem ordem de refer√™ncia, usar ordem do Map
                    contasMap.forEach(conta => {
                        const pessoasConsolidadas = consolidarPessoasPorNome(conta.pessoas);
                        
                        contas.push({
                            ...conta,
                            pessoas: pessoasConsolidadas
                        });
                    });
                }
                
                // CR√çTICO: Salvar o novo m√™s criado
                todasContas[chave] = JSON.parse(JSON.stringify(contas));
                localStorage.setItem('todasContas', JSON.stringify(todasContas));
                
                if (contas.length > 0) {
                    adicionarLog(`   ‚úÖ Novo m√™s ${chave} criado e salvo com ${contas.length} contas`, 'success');
                } else {
                    adicionarLog(`   ‚ÑπÔ∏è Novo m√™s ${chave} criado vazio`, 'info');
                }
            }
        }
function consolidarPessoasPorNome(pessoas) {
            const pessoasMap = new Map();
            
            pessoas.forEach(pessoa => {
                if (!pessoasMap.has(pessoa.nome)) {
                    // Primeira vez que encontra essa pessoa
                    pessoasMap.set(pessoa.nome, {
                        nome: pessoa.nome,
                        valor: 0,
                        valorTotal: 0,
                        parcelas: pessoa.parcelas,
                        compras: [],
                        pago: pessoa.pago
                    });
                }
                
                const pessoaConsolidada = pessoasMap.get(pessoa.nome);
                
                // Consolidar compras
                if (pessoa.compras && pessoa.compras.length > 0) {
                    pessoa.compras.forEach(compra => {
                        const idCompra = compra.idUnico || (compra.nome + '_' + compra.dataCompra);
                        const jaExiste = pessoaConsolidada.compras.some(c => {
                            const idC = c.idUnico || (c.nome + '_' + c.dataCompra);
                            return idC === idCompra;
                        });
                        
                        if (!jaExiste) {
                            pessoaConsolidada.compras.push({...compra});
                        }
                    });
                } else {
                    // Se n√£o tem compras mas tem valor, criar uma compra gen√©rica
                    if (pessoa.valor > 0) {
                        const idGenerico = pessoa.nome + '_' + pessoa.valor + '_' + (pessoa.parcelas || 'unico');
                        const jaExiste = pessoaConsolidada.compras.some(c => {
                            const idC = c.idUnico || (c.nome + '_' + c.dataCompra);
                            return idC === idGenerico;
                        });
                        
                        if (!jaExiste) {
                            pessoaConsolidada.compras.push({
                                nome: 'Valor direto',
                                valorTotal: pessoa.valorTotal || pessoa.valor,
                                valorParcela: pessoa.valor,
                                parcelas: pessoa.parcelas,
                                dataCompra: new Date().toLocaleDateString('pt-BR'),
                                idUnico: idGenerico
                            });
                        }
                    }
                }
                
                // Recalcular valores totais
                pessoaConsolidada.valor = pessoaConsolidada.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0);
                pessoaConsolidada.valorTotal = pessoaConsolidada.compras.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                
                // Manter o status de pago mais recente
                if (pessoa.pago) {
                    pessoaConsolidada.pago = true;
                }
            });
            
            return Array.from(pessoasMap.values());
        }
        function verificarRecebimentoPagoTotalmente(nomeConta, pessoa, mesOrigemChave) {
            const chaveAtual = getChaveMes();
            const [anoAtual, mesAtualNum] = chaveAtual.split('-').map(Number);
            const dataAtualMes = new Date(anoAtual, mesAtualNum - 1);
            
            // Criar identificador √∫nico do recebimento
            let idRecebimento = '';
            if (pessoa.compras && pessoa.compras[0]) {
                idRecebimento = pessoa.compras[0].idUnico || 
                    (pessoa.compras[0].nome + '_' + pessoa.compras[0].dataCompra);
            } else {
                idRecebimento = pessoa.nome + '_' + (pessoa.valorTotal || pessoa.valor);
            }
            
            // Para recebimentos parcelados
            if (pessoa.parcelas && pessoa.parcelas !== 'recorrente') {
                const match = pessoa.parcelas.match(/(\d+)\/(\d+)/);
                if (match) {
                    const totalParcelas = parseInt(match[2]);
                    let parcelasPagas = 0;
                    
                    // Verificar em TODOS os meses quantas parcelas foram pagas
                    Object.keys(todasContas).forEach(chaveMes => {
                        const contasMes = todasContas[chaveMes];
                        const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                        
                        if (contaEncontrada) {
                            contaEncontrada.pessoas.forEach(p => {
                                let idAtual = '';
                                if (p.compras && p.compras[0]) {
                                    idAtual = p.compras[0].idUnico || 
                                        (p.compras[0].nome + '_' + p.compras[0].dataCompra);
                                } else {
                                    idAtual = p.nome + '_' + (p.valorTotal || p.valor);
                                }
                                
                                // Se √© o mesmo recebimento E foi marcado como pago
                                if (idAtual === idRecebimento && p.pago) {
                                    parcelasPagas++;
                                }
                            });
                        }
                    });
                    
                    // Considerado totalmente pago se n√∫mero de parcelas pagas >= total
                    return parcelasPagas >= totalParcelas;
                }
            }
            
            // Para recebimentos √∫nicos (sem parcelas)
            let foiPago = false;
            
            Object.keys(todasContas).forEach(chaveMes => {
                const contasMes = todasContas[chaveMes];
                const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                
                if (contaEncontrada) {
                    contaEncontrada.pessoas.forEach(p => {
                        let idAtual = '';
                        if (p.compras && p.compras[0]) {
                            idAtual = p.compras[0].idUnico || 
                                (p.compras[0].nome + '_' + p.compras[0].dataCompra);
                        } else {
                            idAtual = p.nome + '_' + (p.valorTotal || p.valor);
                        }
                        
                        if (idAtual === idRecebimento && p.pago) {
                            foiPago = true;
                        }
                    });
                }
            });
            
            return foiPago;
        }


        function salvarNoStorage() {
            const chave = getChaveMes();
            
            adicionarLog(`üíæ salvarNoStorage() INICIADA - M√™s: ${chave}`, 'info');
            adicionarLog(`   Contas a salvar: ${contas.length}`, 'info');
            
            // CONSOLIDAR antes de salvar
            const contasConsolidadas = contas.map(conta => {
                const pessoasConsolidadas = consolidarPessoasPorNome(conta.pessoas);
                
                adicionarLog(`   Conta: ${conta.nome} - Pessoas: ${pessoasConsolidadas.length}`, 'info');
                
                return {
                    ...conta,
                    pessoas: pessoasConsolidadas
                };
            });
            
            todasContas[chave] = JSON.parse(JSON.stringify(contasConsolidadas));
            dataUltimaAtualizacao = new Date().toISOString();
            localStorage.setItem('todasContas', JSON.stringify(todasContas));
            localStorage.setItem('dataUltimaAtualizacao', dataUltimaAtualizacao);
            localStorage.setItem('mesAtualSalvo', JSON.stringify({
                ano: mesAtual.getFullYear(),
                mes: mesAtual.getMonth()
            }));
            
            adicionarLog(`‚úÖ salvarNoStorage() CONCLU√çDA`, 'success');
        }
        function iniciarLongPress(contaId, pessoaIndex, event) {
            if (event && event.type === 'touchstart') {
                longPressTimer = setTimeout(() => {
                    menuComprasPessoa(contaId, pessoaIndex);
                    longPressTimer = 'ativo';
                }, 700);
            }
        }

        function cancelarLongPress() {
            if (longPressTimer && longPressTimer !== 'ativo') {
                clearTimeout(longPressTimer);
            }
            setTimeout(() => {
                longPressTimer = null;
            }, 100);
        }

        function menuComprasPessoa(contaId, pessoaIndex) {
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const pessoa = conta.pessoas[pessoaIndex];
            let nomePessoa = pessoa.nome;
            if (pessoa.nome === 'Eu' && conta.tipoTransacao === 'recebimento') {
                nomePessoa = 'Devedor';
            }
            
            const tipoTransacao = conta.tipoTransacao === 'recebimento' ? 'entrada' : 'compra';
            const temCompras = pessoa.compras && pessoa.compras.length > 0;
            
            document.getElementById('modalMenuTitulo').textContent = `${nomePessoa} - ${conta.nome}`;
            
            let conteudo = '<div class="menu-opcoes">';
            conteudo += `<button class="menu-btn menu-btn-adicionar" onclick="fecharModalMenu(); adicionarCompraParaPessoa(${contaId}, ${pessoaIndex})">‚ûï Adicionar Nova ${tipoTransacao === 'entrada' ? 'Entrada' : 'Compra'}</button>`;
            
            if (temCompras) {
                conteudo += `<button class="menu-btn menu-btn-editar" onclick="fecharModalMenu(); editarComprasPessoa(${contaId}, ${pessoaIndex})">‚úèÔ∏è Ver/Editar ${tipoTransacao === 'entrada' ? 'Entradas' : 'Compras'}</button>`;
            }
            
            conteudo += '<button class="menu-btn menu-btn-cancelar" onclick="fecharModalMenu()">‚úï Cancelar</button>';
            conteudo += '</div>';
            
            document.getElementById('modalMenuConteudo').innerHTML = conteudo;
            document.getElementById('modalMenu').classList.add('ativo');
        }

        function fecharModalMenu() {
            document.getElementById('modalMenu').classList.remove('ativo');
        }
        function fecharModalPendencias() {
            document.getElementById('modalPendencias').classList.remove('ativo');
        }
        function fecharModalDetalhes() {
            document.getElementById('modalDetalhes').classList.remove('ativo');
        }
        function fecharModalValor() {
            document.getElementById('modalValor').classList.remove('ativo');
        }
        function fecharModalResumo() {
            document.getElementById('modalResumo').classList.remove('ativo');
        }
        function iniciarLongPressLimpar(event) {
            if (event.type === 'touchstart' || event.type === 'mousedown') {
                longPressTimerLimpar = setTimeout(() => {
                    abrirModalLimpar();
                    longPressTimerLimpar = 'ativo';
                }, 2000); // 2 segundos de press√£o
            }
        }

        function cancelarLongPressLimpar() {
            if (longPressTimerLimpar && longPressTimerLimpar !== 'ativo') {
                clearTimeout(longPressTimerLimpar);
            }
            setTimeout(() => {
                longPressTimerLimpar = null;
            }, 100);
        }

        function abrirModalLimpar() {
            document.getElementById('modalLimpar').classList.add('ativo');
        }

        function fecharModalLimpar() {
            document.getElementById('modalLimpar').classList.remove('ativo');
        }
function verificarEMigrarVersao() {
            const versaoSalva = localStorage.getItem('versaoGestorFinanceiro');
            
            // Se n√£o tem vers√£o salva ou √© diferente da atual
            if (!versaoSalva) {
                // Primeira vez usando o sistema de vers√£o
                console.log('Inicializando sistema de versionamento...');
                localStorage.setItem('versaoGestorFinanceiro', VERSAO_ATUAL);
                return;
            }
            
            if (versaoSalva !== VERSAO_ATUAL) {
                console.log(`Migra√ß√£o detectada: ${versaoSalva} ‚Üí ${VERSAO_ATUAL}`);
                
                // Fazer backup autom√°tico antes da migra√ß√£o
                fazerBackupAutomatico();
                
                // Executar migra√ß√£o
                migrarDados(versaoSalva, VERSAO_ATUAL);
                
                // Atualizar vers√£o
                localStorage.setItem('versaoGestorFinanceiro', VERSAO_ATUAL);
                
                alert(`‚úÖ Sistema atualizado!\n\nVers√£o anterior: ${versaoSalva}\nVers√£o atual: ${VERSAO_ATUAL}\n\nüíæ Um backup autom√°tico foi criado.`);
            }
        }
        
        function migrarDados(versaoAntiga, versaoNova) {
            console.log('Iniciando migra√ß√£o de dados...');
            
            // Limpar cache e configura√ß√µes antigas (N√ÉO toca nos dados financeiros)
            limparCacheAntigo();
            
            // Aqui voc√™ pode adicionar migra√ß√µes espec√≠ficas para cada vers√£o
            // Exemplo:
            // if (versaoAntiga === '1.0' && versaoNova === '2.0') {
            //     migrarDe1Para2();
            // }
            
            console.log('Migra√ß√£o conclu√≠da com sucesso!');
        }
        
        function limparCacheAntigo() {
            // Lista de chaves que podem ser limpas (cache, configura√ß√µes, etc)
            const chavesParaLimpar = [
                'configInterface',
                'preferenciasVisualizacao',
                'cacheTemporario',
                'ultimaBusca',
                'filtrosAtivos'
                // Adicione aqui outras chaves de cache/configura√ß√£o que voc√™ criar no futuro
            ];
            
            chavesParaLimpar.forEach(chave => {
                if (localStorage.getItem(chave)) {
                    localStorage.removeItem(chave);
                    console.log(`Cache removido: ${chave}`);
                }
            });
        }
        
        function fazerBackupAutomatico() {
            try {
                const agora = new Date();
                const dia = String(agora.getDate()).padStart(2, '0');
                const mes = String(agora.getMonth() + 1).padStart(2, '0');
                const ano = agora.getFullYear();
                const hora = String(agora.getHours()).padStart(2, '0');
                const minuto = String(agora.getMinutes()).padStart(2, '0');
                
                const nomeArquivo = `GF_BACKUP_AUTO_${dia}-${mes}-${ano}_${hora}-${minuto}h.json`;
                
                const dadosBackup = {
                    todasContas: todasContas,
                    mesAtualSalvo: {
                        ano: mesAtual.getFullYear(),
                        mes: mesAtual.getMonth()
                    },
                    dataBackup: agora.toISOString(),
                    versao: localStorage.getItem('versaoGestorFinanceiro') || 'desconhecida',
                    tipo: 'backup_automatico'
                };
                
                const blob = new Blob([JSON.stringify(dadosBackup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = nomeArquivo;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('Backup autom√°tico criado:', nomeArquivo);
            } catch (erro) {
                console.error('Erro ao criar backup autom√°tico:', erro);
            }
        }
        function limparApenasCache() {
            const confirmar = confirm(
                'üßπ Limpar Cache e Configura√ß√µes?\n\n' +
                'Isso ir√° remover:\n' +
                '‚Ä¢ Cache antigo\n' +
                '‚Ä¢ Configura√ß√µes de interface\n' +
                '‚Ä¢ Prefer√™ncias antigas\n\n' +
                '‚úÖ SEUS DADOS FINANCEIROS SER√ÉO MANTIDOS!\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmar) return;
            
            // Limpar apenas cache e configura√ß√µes
            limparCacheAntigo();
            
            // For√ßar atualiza√ß√£o da vers√£o
            localStorage.setItem('versaoGestorFinanceiro', VERSAO_ATUAL);
            
            // Fechar modal
            fecharModalLimpar();
            
            // Confirmar limpeza
            alert('‚úÖ Cache limpo com sucesso!\n\nüßπ Cache e configura√ß√µes antigas foram removidos.\nüíæ Seus dados financeiros est√£o intactos!');
            
            // Recarregar p√°gina para aplicar mudan√ßas
            location.reload();
        }
        
        function confirmarLimpezaTotal() {
            const confirmar = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO! LIMPEZA TOTAL\n\n' +
                'Isso ir√° APAGAR:\n' +
                '‚ùå Todas as contas\n' +
                '‚ùå Todos os meses\n' +
                '‚ùå Todo o hist√≥rico\n' +
                '‚ùå Todas as configura√ß√µes\n\n' +
                'üö® ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!\n\n' +
                'Deseja continuar?'
            );
            
            if (!confirmar) {
                fecharModalLimpar();
                return;
            }
            
            // Limpar TUDO do Gestor Financeiro
            localStorage.removeItem('todasContas');
            localStorage.removeItem('dataUltimaAtualizacao');
            localStorage.removeItem('mesAtualSalvo');
            localStorage.removeItem('versaoGestorFinanceiro');
            limparCacheAntigo();
            
            // Resetar vari√°veis
            todasContas = {};
            contas = [];
            mesAtual = new Date();
            dataUltimaAtualizacao = null;
            
            // Fechar modal
            fecharModalLimpar();
            
            // Atualizar visualiza√ß√£o
            atualizarVisualizacao();
            
            // Confirmar limpeza
            alert('‚úÖ Limpeza total conclu√≠da!\n\nüóëÔ∏è Todos os dados do Gestor Financeiro foram apagados.');
}

        function adicionarCompraParaPessoa(contaId, pessoaIndex) {
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const pessoa = conta.pessoas[pessoaIndex];
            const tipoTransacao = conta.tipoTransacao === 'recebimento' ? 'entrada' : 'compra';
            const tipoLabel = tipoTransacao === 'entrada' ? 'Entrada' : 'Compra';
            
            let nomePessoa = pessoa.nome;
            if (pessoa.nome === 'Eu' && conta.tipoTransacao === 'recebimento') {
                nomePessoa = 'Devedor';
            }
            
            document.getElementById('modalFormTitulo').textContent = `Adicionar ${tipoLabel} - ${nomePessoa}`;
            
            let conteudo = '<form id="formAdicionarCompra" onsubmit="salvarNovaCompra(event, ' + contaId + ', ' + pessoaIndex + ')">';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Nome da pessoa/descri√ß√£o:</label>';
            conteudo += `<input type="text" id="nomePessoaAddCompraForm" value="${nomePessoa}" readonly style="background: #f0f0f0;">`;
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += `<label>Nome da ${tipoLabel.toLowerCase()}:</label>`;
            conteudo += '<input type="text" id="nomeCompraAddForm" required>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Tipo:</label>';
            conteudo += '<select id="tipoCompraAddForm">';
            conteudo += '<option value="cartao">Cart√£o de Cr√©dito</option>';
            conteudo += '<option value="boleto">Boleto/Conta</option>';
            conteudo += '<option value="dinheiro">Dinheiro</option>';
            conteudo += '<option value="pix">PIX</option>';
            conteudo += '<option value="outro">Outro</option>';
            conteudo += '</select>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Valor Total:</label>';
            conteudo += '<input type="number" id="valorTotalAddForm" step="0.01" required>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>N√∫mero de Parcelas:</label>';
            conteudo += '<input type="number" id="numParcelasAddForm" min="1" value="1" required>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<div class="checkbox-group">';
            conteudo += '<input type="checkbox" id="compraEmAndamentoAddForm" onchange="toggleParcelasEmAndamentoAddForm()">';
            conteudo += '<label for="compraEmAndamentoAddForm" style="font-size: 12px;">Compra em andamento</label>';
            conteudo += '</div>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal" id="grupoParcelasAndamentoAddForm" style="display: none;">';
            conteudo += '<label>J√° pagas:</label>';
            conteudo += '<input type="number" id="parcelasJaPagasAddForm" min="0" placeholder="0">';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<div class="checkbox-group">';
            conteudo += '<input type="checkbox" id="contaRecorrenteAddForm" onchange="toggleContaRecorrenteAddForm()">';
            conteudo += '<label for="contaRecorrenteAddForm" style="font-size: 12px;">Conta recorrente (√°gua, luz, plano...)</label>';
            conteudo += '</div>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Observa√ß√µes:</label>';
            conteudo += '<textarea id="observacoesAddForm" placeholder="Ex: Pagamento quinzenal, PIX, etc...&#10;Pressione Enter para nova linha" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; resize: vertical; transition: border 0.3s;"></textarea>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-acoes-modal">';
            conteudo += '<button type="button" class="btn-cancelar-modal" onclick="fecharModalForm()">Cancelar</button>';
            conteudo += '<button type="submit" class="btn-salvar-modal">Salvar</button>';
            conteudo += '</div>';
            conteudo += '</form>';
            
            document.getElementById('modalFormConteudo').innerHTML = conteudo;
            document.getElementById('modalForm').classList.add('ativo');
        }

        function salvarNovaCompra(e, contaId, pessoaIndex) {
            e.preventDefault();
            
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const pessoa = conta.pessoas[pessoaIndex];
            
            const nomeCompra = document.getElementById('nomeCompraAddForm').value;
            const valorTotal = parseFloat(document.getElementById('valorTotalAddForm').value);
            const tipoCompra = document.getElementById('tipoCompraAddForm').value;
            const ehRecorrente = document.getElementById('contaRecorrenteAddForm').checked;
            const observacoes = document.getElementById('observacoesAddForm').value;
            
            let numParcelas, parcelaAtual, parcelasTexto, valorParcela;
            
            if (ehRecorrente) {
                numParcelas = 1;
                valorParcela = valorTotal;
                parcelasTexto = 'recorrente';
            } else if (document.getElementById('compraEmAndamentoAddForm').checked) {
                const jaPagas = parseInt(document.getElementById('parcelasJaPagasAddForm').value) || 0;
                numParcelas = parseInt(document.getElementById('numParcelasAddForm').value) || 1;
                parcelaAtual = jaPagas + 1;
                valorParcela = valorTotal / numParcelas;
                parcelasTexto = numParcelas > 1 ? `${parcelaAtual}/${numParcelas}` : '';
            } else {
                numParcelas = parseInt(document.getElementById('numParcelasAddForm').value) || 1;
                valorParcela = valorTotal / numParcelas;
                parcelasTexto = numParcelas > 1 ? `1/${numParcelas}` : '';
            }
            
            const dataCompraAtual = new Date().toISOString();
            const chaveAtual = getChaveMes();
            
            // Determinar parcela base
            let parcelaBase = 1;
            if (document.getElementById('compraEmAndamentoAddForm').checked) {
                const jaPagas = parseInt(document.getElementById('parcelasJaPagasAddForm').value) || 0;
                parcelaBase = jaPagas + 1;
            }
            
            const novaCompra = {
                nome: nomeCompra,
                tipo: tipoCompra,
                valorTotal: valorTotal,
                valorParcela: valorParcela,
                parcelas: parcelasTexto,
                dataCompra: new Date().toLocaleDateString('pt-BR'),
                idUnico: dataCompraAtual + '_' + nomeCompra,
                observacoes: observacoes,
                _parcelaBase: parcelaBase,
                _mesBase: chaveAtual
            };
            
            if (!pessoa.compras) {
                pessoa.compras = [];
            }
            
            pessoa.compras.push(novaCompra);
            pessoa.valor = pessoa.compras.reduce((sum, c) => sum + c.valorParcela, 0);
            
            // Se for compra em andamento, adicionar aos meses anteriores
            const ehCompraEmAndamento = document.getElementById('compraEmAndamentoAddForm').checked;
            const jaPagas = ehCompraEmAndamento ? (parseInt(document.getElementById('parcelasJaPagasAddForm').value) || 0) : 0;
            
            if (ehCompraEmAndamento && jaPagas > 0) {
                adicionarCompraEmAndamentoRetroativa(conta.nome, conta.pessoas, jaPagas);
            }
            
            // Propagar a nova compra para todos os meses com informa√ß√£o de base
            propagarComprasParaTodosMeses(conta.nome, conta.pessoas);
            
            salvarNoStorage();
            renderizarContas();
            fecharModalForm();
            alert('Compra adicionada com sucesso! ‚úÖ');
        }
        function editarComprasPessoa(contaId, pessoaIndex) {
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const pessoa = conta.pessoas[pessoaIndex];
            let nomePessoa = pessoa.nome;
            if (pessoa.nome === 'Eu' && conta.tipoTransacao === 'recebimento') {
                nomePessoa = 'Devedor';
            }
            
            if (!pessoa.compras || pessoa.compras.length === 0) {
                alert('Nenhuma compra registrada.');
                return;
            }
            
            const tipoTransacao = conta.tipoTransacao === 'recebimento' ? 'Entrada' : 'Compra';
            
            document.getElementById('modalMenuTitulo').textContent = `${tipoTransacao}s de ${nomePessoa}`;
            
            let conteudo = '<div class="lista-compras">';
            
            pessoa.compras.forEach((compra, idx) => {
                conteudo += `
                    <div class="compra-item">
                        <div class="compra-item-header">
                            <span class="compra-nome">${compra.nome || 'Sem nome'}</span>
                            <span class="compra-valor">R$ ${compra.valorParcela.toFixed(2)}</span>
                        </div>
                        <div class="compra-info">
                            üìÖ ${compra.dataCompra || 'Data n√£o registrada'}
                            ${compra.parcelas ? ` ‚Ä¢ ${compra.parcelas}` : ''}
                            <br>üí∞ Total: R$ ${compra.valorTotal.toFixed(2)}
                        </div>
                        <div class="compra-acoes">
                            <button class="btn-pequeno btn-editar" onclick="editarCompraEspecifica(${contaId}, ${pessoaIndex}, ${idx})">‚úèÔ∏è Editar</button>
                            <button class="btn-pequeno btn-excluir" onclick="excluirCompraEspecifica(${contaId}, ${pessoaIndex}, ${idx})">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });
            
            conteudo += '</div>';
            conteudo += '<div class="menu-opcoes" style="margin-top: 16px;">';
            conteudo += '<button class="menu-btn menu-btn-cancelar" onclick="fecharModalMenu()">‚úï Fechar</button>';
            conteudo += '</div>';
            
            document.getElementById('modalMenuConteudo').innerHTML = conteudo;
            document.getElementById('modalMenu').classList.add('ativo');
        }

        function editarCompraEspecifica(contaId, pessoaIndex, compraIndex) {
            fecharModalMenu();
            
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const pessoa = conta.pessoas[pessoaIndex];
            
            // Marcar que estamos editando uma conta existente
            contaEditando = conta;
            
            // VERIFICAR se a pessoa j√° est√° em pessoasTemp
            let indexNoPessoasTemp = pessoasTemp.findIndex(p => p.nome === pessoa.nome);
            
            if (indexNoPessoasTemp === -1) {
                // Pessoa N√ÉO est√° em pessoasTemp - adicionar
                pessoasTemp.push({
                    nome: pessoa.nome,
                    valor: pessoa.valor,
                    valorTotal: pessoa.valorTotal,
                    parcelas: pessoa.parcelas,
                    observacoes: pessoa.observacoes,
                    compras: JSON.parse(JSON.stringify(pessoa.compras)), // c√≥pia profunda
                    pago: pessoa.pago,
                    parcelasJaPagas: pessoa.parcelasJaPagas || 0
                });
                indexNoPessoasTemp = pessoasTemp.length - 1;
            }
            
            // Chamar a fun√ß√£o editarPessoa que j√° existe e funciona bem
            editarPessoa(indexNoPessoasTemp);
        }

        function excluirCompraEspecifica(contaId, pessoaIndex, compraIndex) {
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const pessoa = conta.pessoas[pessoaIndex];
            const compra = pessoa.compras[compraIndex];
            
            const confirmar = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO!\n\n' +
                `Deseja excluir "${compra.nome}" de TODOS OS MESES?\n\n` +
                'Esta a√ß√£o remover√° todas as parcelas desta compra em todos os meses.\n\n' +
                'Continuar?'
            );
            
            if (!confirmar) return;
            
            fecharModalMenu();
            
            // Excluir de todos os meses
            excluirCompraDeTodosOsMeses(conta.nome, pessoa.nome, compra.idUnico);
            
            // Excluir do m√™s atual tamb√©m
            pessoa.compras.splice(compraIndex, 1);
            
            // Recalcular o valor total da pessoa
            if (pessoa.compras.length > 0) {
                pessoa.valor = pessoa.compras.reduce((sum, c) => sum + c.valorParcela, 0);
            } else {
                // Se n√£o tem mais compras, remover a pessoa da conta
                conta.pessoas.splice(pessoaIndex, 1);
            }
            
            salvarNoStorage();
            
            // Recarregar do storage para garantir consist√™ncia
            carregarContasMesAtual();
            
            renderizarContas();
            alert('Compra exclu√≠da com sucesso de todos os meses! ‚úÖ');
        }
        function adicionarCompraEmAndamentoRetroativa(nomeConta, pessoasAtualizadas, parcelasJaPagas) {
            const chaveAtual = getChaveMes();
            const [anoAtual, mesAtualNum] = chaveAtual.split('-').map(Number);
            adicionarLog(`üì• INICIANDO adicionarCompraEmAndamentoRetroativa()`, 'importante');
            adicionarLog(`   Conta: ${nomeConta}`, 'info');
            adicionarLog(`   Parcelas j√° pagas: ${parcelasJaPagas}`, 'info');
            adicionarLog(`   Pessoas recebidas: ${pessoasAtualizadas.map(p => p.nome).join(', ')}`, 'info');
            
            // PRIMEIRO: Limpar TODOS os meses anteriores ao atual (at√© 12 meses atr√°s)
            pessoasAtualizadas.forEach(pessoaAtualizada => {
                if (pessoaAtualizada.compras && pessoaAtualizada.compras.length > 0) {
                    pessoaAtualizada.compras.forEach(compra => {
                        // Limpar at√© 12 meses anteriores para garantir limpeza total
                        for (let i = 1; i <= 12; i++) {
                            const dataRetroativa = new Date(anoAtual, mesAtualNum - 1 - i, 1);
                            const anoRetro = dataRetroativa.getFullYear();
                            const mesRetro = dataRetroativa.getMonth() + 1;
                            const chaveRetro = `${anoRetro}-${String(mesRetro).padStart(2, '0')}`;
                            
                            if (todasContas[chaveRetro]) {
                                const contasMesRetro = todasContas[chaveRetro];
                                const contaRetro = contasMesRetro.find(c => c.nome === nomeConta);
                                
                                if (contaRetro) {
                                    const qtdAntes = contaRetro.pessoas.length;
                                    
                                    // Remover esta compra espec√≠fica de todas as pessoas com este nome
                                    contaRetro.pessoas = contaRetro.pessoas.filter(p => {
                                        if (p.nome !== pessoaAtualizada.nome) return true;
                                        
                                        // Se tem compras, filtrar apenas a compra espec√≠fica
                                        if (p.compras && p.compras.length > 0) {
                                            p.compras = p.compras.filter(c => c.idUnico !== compra.idUnico);
                                            
                                            // Se ainda tem compras, recalcular valores e manter
                                            if (p.compras.length > 0) {
                                                p.valor = p.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0);
                                                p.valorTotal = p.compras.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                                                return true;
                                            }
                                        }
                                        
                                        // Se n√£o tem compras ou ficou vazio, remover
                                        return false;
                                    });
                                    
                                    if (contaRetro.pessoas.length < qtdAntes) {
                                        adicionarLog(`   üóëÔ∏è M√™s ${chaveRetro}: ${qtdAntes - contaRetro.pessoas.length} pessoa(s) removida(s)`, 'warning');
                                    }
                                    
                                    // Se a conta ficou sem pessoas, remover a conta tamb√©m
                                    if (contaRetro.pessoas.length === 0) {
                                        const indexConta = contasMesRetro.findIndex(c => c.nome === nomeConta);
                                        if (indexConta !== -1) {
                                            contasMesRetro.splice(indexConta, 1);
                                            adicionarLog(`   üóëÔ∏è M√™s ${chaveRetro}: Conta removida (sem pessoas)`, 'warning');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            });
            
            adicionarLog(`   ‚úÖ Limpeza completa de TODOS os meses retroativos conclu√≠da`, 'success');
            
            // SEGUNDO: Adicionar parcelas retroativas APENAS nos meses necess√°rios
            for (let i = 1; i <= parcelasJaPagas; i++) {
                const dataRetroativa = new Date(anoAtual, mesAtualNum - 1 - i, 1);
                const anoRetro = dataRetroativa.getFullYear();
                const mesRetro = dataRetroativa.getMonth() + 1;
                const chaveRetro = `${anoRetro}-${String(mesRetro).padStart(2, '0')}`;
                
                // Criar estrutura do m√™s se n√£o existir
                if (!todasContas[chaveRetro]) {
                    todasContas[chaveRetro] = [];
                }
                
                adicionarLog(`üìÖ Processando m√™s retroativo: ${chaveRetro}`, 'info');
                
                const contasMesRetro = todasContas[chaveRetro];
                let contaRetro = contasMesRetro.find(c => c.nome === nomeConta);
                
                // Se a conta n√£o existe no m√™s retroativo, criar
                if (!contaRetro) {
                    const contaOriginal = contas.find(c => c.nome === nomeConta);
                    if (contaOriginal) {
                        contaRetro = {
                            ...contaOriginal,
                            id: Date.now() + Math.random(),
                            pessoas: [],
                            pago: false
                        };
                        contasMesRetro.push(contaRetro);
                        adicionarLog(`   ‚ú® Conta criada no m√™s ${chaveRetro}`, 'success');
                    }
                }
                
                if (contaRetro) {
                    pessoasAtualizadas.forEach(pessoaAtualizada => {
                        adicionarLog(`   üë§ Processando pessoa: ${pessoaAtualizada.nome}`, 'info');
                        
                        if (pessoaAtualizada.compras && pessoaAtualizada.compras.length > 0) {
                            pessoaAtualizada.compras.forEach(compra => {
                                const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                
                                if (match) {
                                    const parcelaBase = compra._parcelaBase || parseInt(match[1]);
                                    const totalParcelas = parseInt(match[2]);
                                    
                                    // Calcular qual parcela seria neste m√™s retroativo
                                    const parcelaRetro = parcelaBase - i;
                                    
                                    adicionarLog(`      üìä Parcela calculada: ${parcelaRetro}/${totalParcelas} (base: ${parcelaBase}, retroativo: ${i})`, 'info');
                                    
                                    // Se a parcela retroativa √© v√°lida (maior que 0 e menor/igual ao total)
                                    if (parcelaRetro > 0 && parcelaRetro <= totalParcelas) {
                                        // Verificar se j√° existe EXATAMENTE esta compra neste m√™s
                                        const pessoaJaExiste = contaRetro.pessoas.find(p => p.nome === pessoaAtualizada.nome);
                                        
                                        let compraJaExiste = false;
                                        if (pessoaJaExiste && pessoaJaExiste.compras) {
                                            compraJaExiste = pessoaJaExiste.compras.some(c => 
                                                c.idUnico === compra.idUnico && c.parcelas === `${parcelaRetro}/${totalParcelas}`
                                            );
                                        }
                                        
                                        if (!compraJaExiste) {
                                            if (pessoaJaExiste) {
                                                // Pessoa existe - adicionar compra
                                                pessoaJaExiste.compras.push({
                                                    ...compra,
                                                    parcelas: `${parcelaRetro}/${totalParcelas}`,
                                                    _parcelaBase: parcelaBase,
                                                    _mesBase: compra._mesBase || chaveAtual
                                                });
                                                
                                                // Recalcular valores
                                                pessoaJaExiste.valor = pessoaJaExiste.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0);
                                                pessoaJaExiste.valorTotal = pessoaJaExiste.compras.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                                                
                                                adicionarLog(`      ‚ûï Compra adicionada √† pessoa existente - Parcela ${parcelaRetro}/${totalParcelas}`, 'success');
                                            } else {
                                                // Pessoa n√£o existe - criar nova
                                                contaRetro.pessoas.push({
                                                    nome: pessoaAtualizada.nome,
                                                    valor: compra.valorParcela,
                                                    valorTotal: compra.valorTotal,
                                                    parcelas: `${parcelaRetro}/${totalParcelas}`,
                                                    compras: [{
                                                        ...compra,
                                                        parcelas: `${parcelaRetro}/${totalParcelas}`,
                                                        _parcelaBase: parcelaBase,
                                                        _mesBase: compra._mesBase || chaveAtual
                                                    }],
                                                    pago: true // Marcar como pago pois s√£o parcelas J√Å PAGAS
                                                });
                                                
                                                adicionarLog(`      ‚ú® Nova pessoa criada - Parcela ${parcelaRetro}/${totalParcelas} MARCADA COMO PAGA`, 'success');
                                            }
                                        } else {
                                            adicionarLog(`      ‚è≠Ô∏è Compra j√° existe neste m√™s, pulando...`, 'info');
                                        }
                                    } else {
                                        adicionarLog(`      ‚ö†Ô∏è Parcela ${parcelaRetro} fora do intervalo v√°lido (1-${totalParcelas})`, 'warning');
                                    }
                                }
                            });
                        }
                    });
                    
                    // Verificar se todas as pessoas est√£o pagas para marcar a conta como paga
                    const todasPagas = contaRetro.pessoas.length > 0 && contaRetro.pessoas.every(p => p.pago);
                    if (todasPagas) {
                        contaRetro.pago = true;
                        adicionarLog(`   ‚úÖ Conta ${nomeConta} marcada como paga no m√™s ${chaveRetro}`, 'success');
                    }
                }
            }
            
            adicionarLog(`‚úÖ adicionarCompraEmAndamentoRetroativa() CONCLU√çDA`, 'importante');
            
            // Salvar altera√ß√µes
            localStorage.setItem('todasContas', JSON.stringify(todasContas));
        }
        function propagarEdicaoCompraParaTodosMeses(nomeConta, nomePessoa, compraEditada, parcelaBaseOriginal, mesBaseOriginal) {
            const chaveAtual = getChaveMes();
            
            adicionarLog(`üîÑ propagarEdicaoCompraParaTodosMeses INICIADA`, 'importante');
            adicionarLog(`   Conta: ${nomeConta}, Pessoa: ${nomePessoa}`, 'info');
            adicionarLog(`   Parcela Base: ${parcelaBaseOriginal}, M√™s Base: ${mesBaseOriginal}`, 'info');
            adicionarLog(`   ID da compra: ${compraEditada.idUnico}`, 'info');
            
            // GARANTIR que temos parcela base e m√™s base
            if (!parcelaBaseOriginal || !mesBaseOriginal) {
                adicionarLog(`   ‚ùå ERRO: Faltam informa√ß√µes de parcela base!`, 'error');
                parcelaBaseOriginal = 1;
                mesBaseOriginal = chaveAtual;
            }
            
            // Calcular m√™s base como refer√™ncia
            const [anoBase, mesBase] = mesBaseOriginal.split('-').map(Number);
            
            // DETERMINAR quantos meses precisamos criar
            let mesesNecessarios = 0;
            const match = compraEditada.parcelas ? compraEditada.parcelas.match(/(\d+)\/(\d+)/) : null;
            
            if (match) {
                const totalParcelas = parseInt(match[2]);
                // Quantos meses faltam desde a parcela base at√© o total?
                mesesNecessarios = totalParcelas - parcelaBaseOriginal;
                adicionarLog(`   üìä Total de parcelas: ${totalParcelas}, Parcela base: ${parcelaBaseOriginal}`, 'info');
                adicionarLog(`   üìÖ Meses necess√°rios: ${mesesNecessarios}`, 'info');
            } else if (compraEditada.parcelas === 'recorrente') {
                // Recorrente: criar at√© 12 meses no futuro
                mesesNecessarios = 12;
            }
            
            // CRIAR meses futuros se necess√°rio
            if (mesesNecessarios > 0) {
                for (let i = 0; i <= mesesNecessarios; i++) {
                    const dataFutura = new Date(anoBase, mesBase - 1 + i, 1);
                    const anoFuturo = dataFutura.getFullYear();
                    const mesFuturo = dataFutura.getMonth() + 1;
                    const chaveFutura = `${anoFuturo}-${String(mesFuturo).padStart(2, '0')}`;
                    
                    if (!todasContas[chaveFutura]) {
                        todasContas[chaveFutura] = [];
                        adicionarLog(`   ‚ú® M√™s futuro criado: ${chaveFutura}`, 'success');
                    }
                    
                    // Verificar se a conta existe neste m√™s
                    let contaNoMes = todasContas[chaveFutura].find(c => c.nome === nomeConta);
                    if (!contaNoMes) {
                        // Buscar refer√™ncia da conta no m√™s atual
                        const contaReferencia = contas.find(c => c.nome === nomeConta);
                        if (contaReferencia) {
                            contaNoMes = {
                                ...contaReferencia,
                                id: Date.now() + Math.random(),
                                pessoas: [],
                                pago: false
                            };
                            todasContas[chaveFutura].push(contaNoMes);
                            adicionarLog(`   ‚ú® Conta criada no m√™s ${chaveFutura}`, 'success');
                        }
                    }
                }
            }
            
            adicionarLog(`   üóëÔ∏è FASE 1: Removendo compras antigas de todos os meses`, 'warning');
            
            // Limpar TODAS as ocorr√™ncias antigas desta compra em TODOS os meses primeiro
            let mesesLimpos = 0;
            Object.keys(todasContas).forEach(chaveMes => {
                const contasMes = todasContas[chaveMes];
                const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                
                if (contaEncontrada) {
                    contaEncontrada.pessoas.forEach(pessoaItem => {
                        if (pessoaItem.nome === nomePessoa && pessoaItem.compras) {
                            const qtdAntes = pessoaItem.compras.length;
                            pessoaItem.compras = pessoaItem.compras.filter(c => 
                                c.idUnico !== compraEditada.idUnico
                            );
                            if (qtdAntes !== pessoaItem.compras.length) {
                                mesesLimpos++;
                                adicionarLog(`      M√™s ${chaveMes}: Removida`, 'info');
                            }
                        }
                    });
                }
            });
            
            adicionarLog(`   ‚úÖ ${mesesLimpos} meses limpos`, 'success');
            adicionarLog(`   ‚ûï FASE 2: Adicionando compra editada em todos os meses`, 'warning');
            
            // Agora adicionar a compra editada em todos os meses apropriados
            let mesesAdicionados = 0;
            Object.keys(todasContas).forEach(chaveMes => {
                const [ano, mes] = chaveMes.split('-').map(Number);
                const diffMesesDesdeBase = (ano - anoBase) * 12 + (mes - mesBase);
                
                const contasMes = todasContas[chaveMes];
                const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                
                if (contaEncontrada) {
                    let pessoaEncontrada = contaEncontrada.pessoas.find(p => p.nome === nomePessoa);
                    
                    // Se a pessoa n√£o existe neste m√™s, criar
                    if (!pessoaEncontrada) {
                        pessoaEncontrada = {
                            nome: nomePessoa,
                            valor: 0,
                            valorTotal: 0,
                            compras: [],
                            pago: false
                        };
                        contaEncontrada.pessoas.push(pessoaEncontrada);
                        adicionarLog(`      M√™s ${chaveMes}: Pessoa criada`, 'info');
                    }
                    
                    if (!pessoaEncontrada.compras) {
                        pessoaEncontrada.compras = [];
                    }
                    
                    // Adicionar a compra editada com a parcela correta para este m√™s
                    const match = compraEditada.parcelas ? compraEditada.parcelas.match(/(\d+)\/(\d+)/) : null;
                    
                    if (match) {
                        // Compra parcelada
                        const totalParcelas = parseInt(match[2]);
                        const parcelaParaEsteMes = parcelaBaseOriginal + diffMesesDesdeBase;
                        
                        // S√≥ adicionar se a parcela for v√°lida
                        if (parcelaParaEsteMes > 0 && parcelaParaEsteMes <= totalParcelas) {
                            pessoaEncontrada.compras.push({
                                ...compraEditada,
                                parcelas: `${parcelaParaEsteMes}/${totalParcelas}`,
                                _parcelaBase: parcelaBaseOriginal,
                                _mesBase: mesBaseOriginal
                            });
                            mesesAdicionados++;
                            adicionarLog(`      M√™s ${chaveMes}: Adicionada parcela ${parcelaParaEsteMes}/${totalParcelas}`, 'success');
                        }
                    } else if (compraEditada.parcelas === 'recorrente') {
                        // Compra recorrente
                        pessoaEncontrada.compras.push({
                            ...compraEditada,
                            _parcelaBase: parcelaBaseOriginal,
                            _mesBase: mesBaseOriginal
                        });
                        mesesAdicionados++;
                        adicionarLog(`      M√™s ${chaveMes}: Adicionada (recorrente)`, 'success');
                    } else {
                        // Compra √∫nica - s√≥ no m√™s base
                        if (chaveMes === mesBaseOriginal) {
                            pessoaEncontrada.compras.push({
                                ...compraEditada,
                                _parcelaBase: parcelaBaseOriginal,
                                _mesBase: mesBaseOriginal
                            });
                            mesesAdicionados++;
                            adicionarLog(`      M√™s ${chaveMes}: Adicionada (√∫nica)`, 'success');
                        }
                    }
                    
                    // Recalcular valores da pessoa
                    if (pessoaEncontrada.compras.length > 0) {
                        pessoaEncontrada.valor = pessoaEncontrada.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0);
                        pessoaEncontrada.valorTotal = pessoaEncontrada.compras.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                    } else {
                        // Se n√£o tem mais compras, verificar se pode remover a pessoa
                        const temOutrasCompras = pessoaEncontrada.compras && pessoaEncontrada.compras.length > 0;
                        if (!temOutrasCompras) {
                            contaEncontrada.pessoas = contaEncontrada.pessoas.filter(p => p.nome !== nomePessoa);
                        }
                    }
                }
            });
            
            adicionarLog(`   ‚úÖ ${mesesAdicionados} meses adicionados`, 'success');
            
            // FASE 3: Limpar pessoas com valor zero (meses que n√£o t√™m mais parcelas)
            adicionarLog(`   üßπ FASE 3: Limpando pessoas com valor zero`, 'warning');
            let pessoasRemovidas = 0;
            
            Object.keys(todasContas).forEach(chaveMes => {
                const contasMes = todasContas[chaveMes];
                const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                
                if (contaEncontrada) {
                    const qtdAntes = contaEncontrada.pessoas.length;
                    
                    contaEncontrada.pessoas = contaEncontrada.pessoas.filter(p => {
                        // Manter pessoa se N√ÉO for a pessoa sendo editada
                        if (p.nome !== nomePessoa) return true;
                        
                        // Para a pessoa sendo editada, verificar se tem compras v√°lidas
                        const temCompras = p.compras && p.compras.length > 0;
                        const valorTotal = p.compras ? p.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0) : p.valor;
                        
                        adicionarLog(`      M√™s ${chaveMes}: ${p.nome} - Compras: ${temCompras}, Valor: ${valorTotal}`, 'info');
                        
                        // Manter apenas se tem compras E valor > 0
                        return temCompras && valorTotal > 0;
                    });
                    
                    if (contaEncontrada.pessoas.length < qtdAntes) {
                        pessoasRemovidas++;
                        adicionarLog(`      M√™s ${chaveMes}: ‚ùå Pessoa removida (sem compras v√°lidas)`, 'warning');
                    }
                }
            });
            
            if (pessoasRemovidas > 0) {
                adicionarLog(`   ‚úÖ ${pessoasRemovidas} pessoas com valor zero removidas`, 'success');
            } else {
                adicionarLog(`   ‚ÑπÔ∏è Nenhuma pessoa com valor zero encontrada`, 'info');
            }
            
            adicionarLog(`‚úÖ propagarEdicaoCompraParaTodosMeses CONCLU√çDA`, 'importante');
            
            // Salvar altera√ß√µes
            localStorage.setItem('todasContas', JSON.stringify(todasContas));
        }
        function removerPessoaDeTodosOsMeses(nomeConta, nomePessoa) {
            adicionarLog(`üóëÔ∏è removerPessoaDeTodosOsMeses INICIADA`, 'importante');
            adicionarLog(`   Conta: ${nomeConta}, Pessoa: ${nomePessoa}`, 'info');
            
            let mesesProcessados = 0;
            let pessoasRemovidas = 0;
            
            // Percorrer TODOS os meses
            Object.keys(todasContas).forEach(chaveMes => {
                const contasMes = todasContas[chaveMes];
                const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                
                if (contaEncontrada) {
                    mesesProcessados++;
                    const qtdAntes = contaEncontrada.pessoas.length;
                    
                    // Remover a pessoa
                    contaEncontrada.pessoas = contaEncontrada.pessoas.filter(p => p.nome !== nomePessoa);
                    
                    if (contaEncontrada.pessoas.length < qtdAntes) {
                        pessoasRemovidas++;
                        adicionarLog(`      M√™s ${chaveMes}: Pessoa removida`, 'info');
                    }
                    
                    // Recalcular se a conta est√° totalmente paga
                    if (contaEncontrada.pessoas.length === 0) {
                        contaEncontrada.pago = false;
                    } else {
                        const todasPagas = contaEncontrada.pessoas.every(p => p.pago);
                        contaEncontrada.pago = todasPagas;
                    }
                }
            });
            
            adicionarLog(`   üìä Estat√≠sticas:`, 'info');
            adicionarLog(`      Meses processados: ${mesesProcessados}`, 'info');
            adicionarLog(`      Pessoas removidas: ${pessoasRemovidas}`, 'info');
            
            // Salvar altera√ß√µes
            localStorage.setItem('todasContas', JSON.stringify(todasContas));
            adicionarLog(`   ‚úÖ Altera√ß√µes salvas no localStorage`, 'success');
            adicionarLog(`‚úÖ removerPessoaDeTodosOsMeses CONCLU√çDA`, 'importante');
        }
        function excluirCompraDeTodosOsMeses(nomeConta, nomePessoa, idUnicoCompra) {
            adicionarLog(`üóëÔ∏è excluirCompraDeTodosOsMeses INICIADA`, 'importante');
            adicionarLog(`   Conta: ${nomeConta}, Pessoa: ${nomePessoa}`, 'info');
            adicionarLog(`   ID da compra: ${idUnicoCompra}`, 'info');
            
            let mesesProcessados = 0;
            let comprasRemovidas = 0;
            let pessoasRemovidas = 0;
            
            // Percorrer TODOS os meses (incluindo meses anteriores com parcelas pagas)
            Object.keys(todasContas).forEach(chaveMes => {
                const contasMes = todasContas[chaveMes];
                const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                
                if (contaEncontrada) {
                    mesesProcessados++;
                    
                    // Usar um array para armazenar √≠ndices a remover (de tr√°s para frente)
                    const pessoasParaRemover = [];
                    
                    contaEncontrada.pessoas.forEach((pessoa, pessoaIdx) => {
                        if (pessoa.nome === nomePessoa && pessoa.compras) {
                            const qtdComprasAntes = pessoa.compras.length;
                            
                            // Filtrar removendo a compra
                            pessoa.compras = pessoa.compras.filter(c => c.idUnico !== idUnicoCompra);
                            
                            if (pessoa.compras.length < qtdComprasAntes) {
                                comprasRemovidas++;
                                adicionarLog(`      M√™s ${chaveMes}: Compra removida`, 'info');
                            }
                            
                            // Recalcular valor da pessoa
                            if (pessoa.compras.length > 0) {
                                pessoa.valor = pessoa.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0);
                                pessoa.valorTotal = pessoa.compras.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                            } else {
                                // Se n√£o tem mais compras, marcar para remover
                                pessoasParaRemover.push(pessoaIdx);
                            }
                        }
                    });
                    
                    // Remover pessoas sem compras (de tr√°s para frente para n√£o afetar √≠ndices)
                    for (let i = pessoasParaRemover.length - 1; i >= 0; i--) {
                        contaEncontrada.pessoas.splice(pessoasParaRemover[i], 1);
                        pessoasRemovidas++;
                        adicionarLog(`      M√™s ${chaveMes}: Pessoa removida (sem compras)`, 'warning');
                    }
                    
                    // Se a conta ficou sem pessoas, recalcular status de pagamento
                    if (contaEncontrada.pessoas.length === 0) {
                        contaEncontrada.pago = false;
                    } else {
                        // Recalcular se a conta est√° totalmente paga
                        const todasPagas = contaEncontrada.pessoas.every(p => p.pago);
                        contaEncontrada.pago = todasPagas;
                    }
                }
                
                // N√ÉO remover contas vazias - apenas deixar sem pessoas
                // (contas devem permanecer mesmo sem parcelas ativas)
            });
            
            adicionarLog(`   üìä Estat√≠sticas:`, 'info');
            adicionarLog(`      Meses processados: ${mesesProcessados}`, 'info');
            adicionarLog(`      Compras removidas: ${comprasRemovidas}`, 'info');
            adicionarLog(`      Pessoas removidas: ${pessoasRemovidas}`, 'info');
            
            // Salvar altera√ß√µes
            localStorage.setItem('todasContas', JSON.stringify(todasContas));
            adicionarLog(`   ‚úÖ Altera√ß√µes salvas no localStorage`, 'success');
            adicionarLog(`‚úÖ excluirCompraDeTodosOsMeses CONCLU√çDA`, 'importante');
        }
        function propagarComprasParaTodosMeses(nomeConta, pessoasAtualizadas) {
            const chaveAtual = getChaveMes();
            const [anoAtual, mesAtualNum] = chaveAtual.split('-').map(Number);
            const dataAtualMes = new Date(anoAtual, mesAtualNum - 1);
            
            // Descobrir se √© recebimento ou pagamento
            const contaOriginal = contas.find(c => c.nome === nomeConta);
            const ehRecebimento = contaOriginal && contaOriginal.tipoTransacao === 'recebimento';
            
            // Percorrer todos os meses (futuros E j√° existentes)
            Object.keys(todasContas).forEach(chaveMes => {
                const [ano, mes] = chaveMes.split('-').map(Number);
                const dataMes = new Date(ano, mes - 1);
                
                // Se for m√™s futuro OU atual (mas n√£o o mesmo processamento)
                if (dataMes >= dataAtualMes) {
                    const contasMes = todasContas[chaveMes];
                    const indexConta = contasMes.findIndex(c => c.nome === nomeConta);
                    const diffMeses = (ano - anoAtual) * 12 + (mes - mesAtualNum);
                    
                    if (indexConta !== -1) {
                        const contaFutura = contasMes[indexConta];
                        
                        // Verificar cada pessoa atualizada
                        pessoasAtualizadas.forEach(pessoaAtualizada => {
                            // Para cada compra da pessoa
                            if (pessoaAtualizada.compras && pessoaAtualizada.compras.length > 0) {
                                pessoaAtualizada.compras.forEach(compra => {
                                    // Verificar se essa compra espec√≠fica j√° existe no m√™s futuro
                                    const jaExisteNoFuturo = contaFutura.pessoas.some(p => {
                                        if (p.nome !== pessoaAtualizada.nome) return false;
                                        if (!p.compras || p.compras.length === 0) return false;
                                        
                                        return p.compras.some(c => 
                                            c.idUnico === compra.idUnico ||
                                            (c.nome === compra.nome && c.dataCompra === compra.dataCompra)
                                        );
                                    });
                                    
                                    if (!jaExisteNoFuturo) {
                                        if (ehRecebimento) {
                                            // RECEBIMENTO: Propagar para todos os meses futuros independente de parcelas
                                            const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                            
                                            if (match) {
                                                // Recebimento parcelado
                                                const parcelaOriginal = parseInt(match[1]);
                                                const totalParcelas = parseInt(match[2]);
                                                const parcelaNoMesFuturo = parcelaOriginal + diffMeses;
                                                
                                                // Propagar todas as parcelas v√°lidas
                                                if (parcelaNoMesFuturo <= totalParcelas && parcelaNoMesFuturo > 0) {
                                                    contaFutura.pessoas.push({
                                                        nome: pessoaAtualizada.nome,
                                                        valor: compra.valorParcela,
                                                        valorTotal: compra.valorTotal,
                                                        parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`,
                                                        compras: [{
                                                            ...compra,
                                                            parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`
                                                        }],
                                                        pago: false
                                                    });
                                                }
                                            } else {
                                                // Recebimento sem parcelas - propagar para todos os meses futuros
                                                contaFutura.pessoas.push({
                                                    nome: pessoaAtualizada.nome,
                                                    valor: compra.valorParcela,
                                                    valorTotal: compra.valorTotal,
                                                    parcelas: '',
                                                    compras: [{...compra}],
                                                    pago: false
                                                });
                                            }
                                        } else {
                                            // PAGAMENTO: L√≥gica original
                                            const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                            
                                            if (match) {
                                                const parcelaOriginal = parseInt(match[1]);
                                                const totalParcelas = parseInt(match[2]);
                                                const parcelaNoMesFuturo = parcelaOriginal + diffMeses;
                                                
                                                // Se a parcela ainda √© v√°lida no m√™s futuro
                                                if (parcelaNoMesFuturo <= totalParcelas && parcelaNoMesFuturo > 0) {
                                                    contaFutura.pessoas.push({
                                                        nome: pessoaAtualizada.nome,
                                                        valor: compra.valorParcela,
                                                        valorTotal: compra.valorTotal,
                                                        parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`,
                                                        compras: [{
                                                            ...compra,
                                                            parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`
                                                        }],
                                                        pago: false
                                                    });
                                                }
                                            } else if (pessoaAtualizada.parcelas === 'recorrente') {
                                                // Adicionar recorrente
                                                contaFutura.pessoas.push({
                                                    nome: pessoaAtualizada.nome,
                                                    valor: compra.valorParcela,
                                                    valorTotal: compra.valorTotal,
                                                    parcelas: 'recorrente',
                                                    compras: [{...compra}],
                                                    pago: false
                                                });
                                            }
                                        }
                                    }
                                });
                            }
                        });
                    } else if (diffMeses > 0) {
                        // Conta n√£o existe neste m√™s futuro - criar ela com as parcelas apropriadas
                        if (contaOriginal) {
                            const novaConta = {
                                ...contaOriginal,
                                id: Date.now() + Math.random(),
                                pago: false,
                                pessoas: []
                            };
                            
                            pessoasAtualizadas.forEach(pessoaAtualizada => {
                                if (pessoaAtualizada.compras && pessoaAtualizada.compras.length > 0) {
                                    pessoaAtualizada.compras.forEach(compra => {
                                        if (ehRecebimento) {
                                            // RECEBIMENTO: Propagar para todos os meses futuros
                                            const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                            
                                            if (match) {
                                                const parcelaOriginal = parseInt(match[1]);
                                                const totalParcelas = parseInt(match[2]);
                                                const parcelaNoMesFuturo = parcelaOriginal + diffMeses;
                                                
                                                if (parcelaNoMesFuturo <= totalParcelas && parcelaNoMesFuturo > 0) {
                                                    novaConta.pessoas.push({
                                                        nome: pessoaAtualizada.nome,
                                                        valor: compra.valorParcela,
                                                        valorTotal: compra.valorTotal,
                                                        parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`,
                                                        compras: [{
                                                            ...compra,
                                                            parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`
                                                        }],
                                                        pago: false
                                                    });
                                                }
                                            } else {
                                                // Recebimento sem parcelas
                                                novaConta.pessoas.push({
                                                    nome: pessoaAtualizada.nome,
                                                    valor: compra.valorParcela,
                                                    valorTotal: compra.valorTotal,
                                                    parcelas: '',
                                                    compras: [{...compra}],
                                                    pago: false
                                                });
                                            }
                                        } else {
                                            // PAGAMENTO: L√≥gica original
                                            const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                            
                                            if (match) {
                                                const parcelaOriginal = parseInt(match[1]);
                                                const totalParcelas = parseInt(match[2]);
                                                const parcelaNoMesFuturo = parcelaOriginal + diffMeses;
                                                
                                                if (parcelaNoMesFuturo <= totalParcelas && parcelaNoMesFuturo > 0) {
                                                    novaConta.pessoas.push({
                                                        nome: pessoaAtualizada.nome,
                                                        valor: compra.valorParcela,
                                                        valorTotal: compra.valorTotal,
                                                        parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`,
                                                        compras: [{
                                                            ...compra,
                                                            parcelas: `${parcelaNoMesFuturo}/${totalParcelas}`
                                                        }],
                                                        pago: false
                                                    });
                                                }
                                            } else if (pessoaAtualizada.parcelas === 'recorrente') {
                                                novaConta.pessoas.push({
                                                    nome: pessoaAtualizada.nome,
                                                    valor: compra.valorParcela,
                                                    valorTotal: compra.valorTotal,
                                                    parcelas: 'recorrente',
                                                    compras: [{...compra}],
                                                    pago: false
                                                });
                                            }
                                        }
                                    });
                                }
                            });
                            
                            // SEMPRE adicionar conta (mesmo sem pessoas)
                            contasMes.push(novaConta);
                        }
                    }
                }
            });
            
            // Salvar altera√ß√µes
            localStorage.setItem('todasContas', JSON.stringify(todasContas));
        }
        
        // ========================================
        // SISTEMA DE DEBUG
        // ========================================
        
        function toggleDebug() {
            debugAtivo = !debugAtivo;
            const painel = document.getElementById('painelDebug');
            const btn = document.getElementById('btnDebug');
            
            if (debugAtivo) {
                painel.style.display = 'flex';
                btn.textContent = 'üêõ DEBUG ON';
                btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                
                // Renderizar todos os logs acumulados
                renderizarLogsAcumulados();
                
                adicionarLog('üü¢ DEBUG ABERTO', 'success');
            } else {
                painel.style.display = 'none';
                btn.textContent = 'üêõ DEBUG';
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }
        
        function renderizarLogsAcumulados() {
            const conteudo = document.getElementById('debugConteudo');
            conteudo.innerHTML = ''; // Limpar conte√∫do antigo
            
            if (debugLogs.length === 0) {
                conteudo.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhum log registrado ainda...</p>';
                return;
            }
            
            // Renderizar todos os logs acumulados
            debugLogs.forEach(log => {
                let cor = '#333';
                let icone = '‚ÑπÔ∏è';
                let background = '#e7f3ff';
                
                switch(log.tipo) {
                    case 'success':
                        cor = '#28a745';
                        icone = '‚úÖ';
                        background = '#d4edda';
                        break;
                    case 'error':
                        cor = '#dc3545';
                        icone = '‚ùå';
                        background = '#f8d7da';
                        break;
                    case 'warning':
                        cor = '#ffc107';
                        icone = '‚ö†Ô∏è';
                        background = '#fff3cd';
                        break;
                    case 'importante':
                        cor = '#764ba2';
                        icone = 'üî•';
                        background = '#e7d4ff';
                        break;
                }
                
                const logDiv = document.createElement('div');
                logDiv.style.cssText = `margin-bottom: 8px; padding: 8px; background: ${background}; border-left: 4px solid ${cor}; border-radius: 4px; word-wrap: break-word;`;
                logDiv.innerHTML = `
                    <div style="color: #666; font-size: 10px; margin-bottom: 4px;">${log.timestamp}</div>
                    <div style="color: ${cor}; font-weight: bold;">${icone} ${log.mensagem}</div>
                `;
                
                conteudo.appendChild(logDiv);
            });
            
            conteudo.scrollTop = conteudo.scrollHeight;
        }
        
        function fecharDebug() {
            debugAtivo = false;
            document.getElementById('painelDebug').style.display = 'none';
            document.getElementById('btnDebug').textContent = 'üêõ DEBUG';
            document.getElementById('btnDebug').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        function adicionarLog(mensagem, tipo = 'info') {
            // SEMPRE capturar logs, mesmo com debug fechado
            
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const log = {
                timestamp: timestamp,
                mensagem: mensagem,
                tipo: tipo
            };
            
            debugLogs.push(log);
            
            // S√≥ renderizar se o debug estiver aberto
            if (!debugAtivo) return;
            
            const conteudo = document.getElementById('debugConteudo');
            
            if (debugLogs.length === 1) {
                conteudo.innerHTML = '';
            }
            
            let cor = '#333';
            let icone = '‚ÑπÔ∏è';
            let background = '#e7f3ff';
            
            switch(tipo) {
                case 'success':
                    cor = '#28a745';
                    icone = '‚úÖ';
                    background = '#d4edda';
                    break;
                case 'error':
                    cor = '#dc3545';
                    icone = '‚ùå';
                    background = '#f8d7da';
                    break;
                case 'warning':
                    cor = '#ffc107';
                    icone = '‚ö†Ô∏è';
                    background = '#fff3cd';
                    break;
                case 'importante':
                    cor = '#764ba2';
                    icone = 'üî•';
                    background = '#e7d4ff';
                    break;
            }
            
            const logDiv = document.createElement('div');
            logDiv.style.cssText = `margin-bottom: 8px; padding: 8px; background: ${background}; border-left: 4px solid ${cor}; border-radius: 4px; word-wrap: break-word;`;
            logDiv.innerHTML = `
                <div style="color: #666; font-size: 10px; margin-bottom: 4px;">${timestamp}</div>
                <div style="color: ${cor}; font-weight: bold;">${icone} ${mensagem}</div>
            `;
            
            conteudo.appendChild(logDiv);
            conteudo.scrollTop = conteudo.scrollHeight;
        }
        
        function copiarLog() {
            let textoLog = '=== LOG DE DEBUG - GESTOR FINANCEIRO ===\n\n';
            
            debugLogs.forEach(log => {
                textoLog += `[${log.timestamp}] ${log.mensagem}\n`;
            });
            
            textoLog += '\n=== FIM DO LOG ===';
            
            // M√©todo alternativo para copiar (funciona em mais navegadores)
            const textarea = document.createElement('textarea');
            textarea.value = textoLog;
            textarea.style.position = 'fixed';
            textarea.style.top = '-9999px';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            try {
                textarea.select();
                textarea.setSelectionRange(0, 99999); // Para mobile
                
                const sucesso = document.execCommand('copy');
                
                if (sucesso) {
                    alert('‚úÖ Log copiado para a √°rea de transfer√™ncia!');
                } else {
                    // Se falhar, mostrar o log em um modal para copiar manualmente
                    mostrarLogParaCopiar(textoLog);
                }
            } catch (err) {
                // Se der erro, mostrar o log em um modal para copiar manualmente
                mostrarLogParaCopiar(textoLog);
            } finally {
                document.body.removeChild(textarea);
            }
        }
        
        function mostrarLogParaCopiar(textoLog) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const conteudo = document.createElement('div');
            conteudo.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 20px;
                max-width: 90%;
                max-height: 80vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            `;
            
            const titulo = document.createElement('h3');
            titulo.textContent = 'üìã Copie o log manualmente';
            titulo.style.cssText = 'margin-bottom: 10px; color: #333;';
            
            const textarea = document.createElement('textarea');
            textarea.value = textoLog;
            textarea.style.cssText = `
                width: 100%;
                height: 400px;
                font-family: 'Courier New', monospace;
                font-size: 11px;
                padding: 10px;
                border: 2px solid #667eea;
                border-radius: 6px;
                resize: none;
                margin-bottom: 10px;
            `;
            textarea.readOnly = true;
            
            const btnFechar = document.createElement('button');
            btnFechar.textContent = '‚úï Fechar';
            btnFechar.style.cssText = `
                background: #667eea;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            `;
            btnFechar.onclick = () => document.body.removeChild(modal);
            
            conteudo.appendChild(titulo);
            conteudo.appendChild(textarea);
            conteudo.appendChild(btnFechar);
            modal.appendChild(conteudo);
            document.body.appendChild(modal);
            
            // Selecionar todo o texto automaticamente
            textarea.select();
        }
        
        function limparLog() {
            debugLogs = [];
            document.getElementById('debugConteudo').innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Log limpo. Aguardando novas a√ß√µes...</p>';
            adicionarLog('üßπ Log limpo', 'warning');
        }
        // ========================================
        // TORNAR PAINEL DE DEBUG ARRAST√ÅVEL
        // ========================================
        let debugDragging = false;
        let debugStartX, debugStartY, debugInitialX, debugInitialY;

        document.addEventListener('DOMContentLoaded', function() {
            const debugPanel = document.getElementById('painelDebug');
            const debugHeader = document.getElementById('debugHeader');
            
            if (!debugHeader || !debugPanel) return;
            
            debugHeader.addEventListener('mousedown', startDragDebug);
            debugHeader.addEventListener('touchstart', startDragDebug);
            
            document.addEventListener('mousemove', dragDebug);
            document.addEventListener('touchmove', dragDebug);
            
            document.addEventListener('mouseup', stopDragDebug);
            document.addEventListener('touchend', stopDragDebug);
            
            function startDragDebug(e) {
                debugDragging = true;
                
                const rect = debugPanel.getBoundingClientRect();
                debugInitialX = rect.left;
                debugInitialY = rect.top;
                
                if (e.type === 'touchstart') {
                    debugStartX = e.touches[0].clientX;
                    debugStartY = e.touches[0].clientY;
                } else {
                    debugStartX = e.clientX;
                    debugStartY = e.clientY;
                }
                
                debugHeader.style.cursor = 'grabbing';
                e.preventDefault();
            }
            
            function dragDebug(e) {
                if (!debugDragging) return;
                
                let currentX, currentY;
                
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                } else {
                    currentX = e.clientX;
                    currentY = e.clientY;
                }
                
                const deltaX = currentX - debugStartX;
                const deltaY = currentY - debugStartY;
                
                const newX = debugInitialX + deltaX;
                const newY = debugInitialY + deltaY;
                
                // Limites da tela
                const maxX = window.innerWidth - debugPanel.offsetWidth;
                const maxY = window.innerHeight - debugPanel.offsetHeight;
                
                const boundedX = Math.max(0, Math.min(newX, maxX));
                const boundedY = Math.max(0, Math.min(newY, maxY));
                
                debugPanel.style.left = boundedX + 'px';
                debugPanel.style.top = boundedY + 'px';
                
                e.preventDefault();
            }
            
            function stopDragDebug() {
                if (debugDragging) {
                    debugDragging = false;
                    debugHeader.style.cursor = 'move';
                }
            }
        });
        function toggleMenuBackup() {
            const menu = document.getElementById('menuBackup');
            menu.classList.toggle('ativo');
        }

        function salvarBackup() {
            const agora = new Date();
            const dia = String(agora.getDate()).padStart(2, '0');
            const mes = String(agora.getMonth() + 1).padStart(2, '0');
            const ano = agora.getFullYear();
            const hora = String(agora.getHours()).padStart(2, '0');
            const minuto = String(agora.getMinutes()).padStart(2, '0');
            const segundo = String(agora.getSeconds()).padStart(2, '0');
            
            const nomeArquivo = `GF_${dia}-${mes}-${ano}_${hora}-${minuto}-${segundo}h.json`;
            
            const dadosBackup = {
                todasContas: todasContas,
                mesAtualSalvo: {
                    ano: mesAtual.getFullYear(),
                    mes: mesAtual.getMonth()
                },
                dataBackup: agora.toISOString(),
                versao: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dadosBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nomeArquivo;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            toggleMenuBackup();
            alert('‚úÖ Backup salvo com sucesso!\n\nüìÅ Arquivo: ' + nomeArquivo);
        }

        function carregarBackup(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosBackup = JSON.parse(e.target.result);
                    
                    // Validar estrutura do backup
                    if (!dadosBackup.todasContas || typeof dadosBackup.todasContas !== 'object') {
                        alert('‚ùå Erro: Arquivo de backup inv√°lido!');
                        return;
                    }
                    
                    // Se j√° existem dados, perguntar antes de substituir
                    if (Object.keys(todasContas).length > 0 && dataUltimaAtualizacao) {
                        const dataAtual = new Date(dataUltimaAtualizacao);
                        const dataFormatada = dataAtual.toLocaleDateString('pt-BR') + ' √†s ' + dataAtual.toLocaleTimeString('pt-BR');
                        
                        const confirmar = confirm(
                            `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                            `Voc√™ est√° prestes a SUBSTITUIR os dados atuais.\n\n` +
                            `üìä Dados atuais salvos em:\n${dataFormatada}\n\n` +
                            `Deseja continuar?`
                        );
                        
                        if (!confirmar) {
                            event.target.value = '';
                            toggleMenuBackup();
                            return;
                        }
                    }
                    
                    // Carregar o backup
                    todasContas = dadosBackup.todasContas;
                    localStorage.setItem('todasContas', JSON.stringify(todasContas));
                    
                    // Carregar o m√™s salvo no backup
                    if (dadosBackup.mesAtualSalvo) {
                        mesAtual = new Date(dadosBackup.mesAtualSalvo.ano, dadosBackup.mesAtualSalvo.mes);
                        localStorage.setItem('mesAtualSalvo', JSON.stringify(dadosBackup.mesAtualSalvo));
                    }
                    
                    // Atualizar visualiza√ß√£o
                    atualizarVisualizacao();
                    
                    toggleMenuBackup();
                    event.target.value = '';
                    
                    const dataBackup = new Date(dadosBackup.dataBackup);
                    const dataBackupFormatada = dataBackup.toLocaleDateString('pt-BR') + ' √†s ' + dataBackup.toLocaleTimeString('pt-BR');
                    
                    alert(`‚úÖ Backup carregado com sucesso!\n\nüìÖ Data do backup: ${dataBackupFormatada}`);
                    
                } catch (erro) {
                    alert('‚ùå Erro ao carregar backup: Arquivo corrompido ou inv√°lido!');
                    console.error('Erro:', erro);
                }
            };
            
            reader.readAsText(arquivo);
        }

        // Fechar menu de backup ao clicar fora
        document.addEventListener('click', function(event) {
            const menuBackup = document.getElementById('menuBackup');
            const btnBackup = document.querySelector('.btn-backup');
            
            if (menuBackup && btnBackup && 
                !menuBackup.contains(event.target) && 
                !btnBackup.contains(event.target)) {
                menuBackup.classList.remove('ativo');
            }
        });
function adicionarNovaCompra(contaId) {
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            contaEditando = conta;
            pessoasTemp = [];
            
            document.getElementById('modalTitulo').textContent = `Adicionar Compra em: ${conta.nome}`;
            document.getElementById('formConta').reset();
            document.getElementById('nomeConta').value = conta.nome;
            document.getElementById('nomeConta').disabled = true;
            document.getElementById('tipoTransacao').value = conta.tipoTransacao;
            document.getElementById('tipoTransacao').disabled = true;
            document.getElementById('tipoConta').value = conta.tipo;
            document.getElementById('tipoConta').disabled = true;
            document.getElementById('limiteTotal').value = conta.limiteTotal || '';
            document.getElementById('limiteTotal').disabled = true;
            document.getElementById('diaFechamento').value = conta.diaFechamento || '';
            document.getElementById('diaFechamento').disabled = true;
            document.getElementById('diaVencimento').value = conta.diaVencimento || '';
            document.getElementById('diaVencimento').disabled = true;
            
            atualizarFormulario();
            atualizarLabelValor();
            renderizarPessoasForm();
            document.getElementById('modal').classList.add('ativo');
        }
        function abrirModal(conta = null) {
            contaEditando = conta;
            pessoasTemp = conta ? [...conta.pessoas.filter(p => p.nome !== 'Eu')] : [];
            
            document.getElementById('modalTitulo').textContent = conta ? 'Editar Conta' : 'Adicionar Conta';
            
            if (conta) {
                document.getElementById('nomeConta').value = conta.nome;
                document.getElementById('tipoTransacao').value = conta.tipoTransacao || 'pagamento';
                document.getElementById('tipoConta').value = conta.tipo;
                document.getElementById('limiteTotal').value = conta.limiteTotal || '';
                document.getElementById('diaFechamento').value = conta.diaFechamento || '';
                document.getElementById('diaVencimento').value = conta.diaVencimento || '';
                document.getElementById('contaPaga').checked = conta.pago;
                document.getElementById('observacoes').value = conta.observacoes || '';
                
                const minhaPessoa = conta.pessoas.find(p => p.nome === 'Eu');
                if (minhaPessoa) {
                    // Limpar campos do "Meu Valor" ao editar (para adicionar apenas outras pessoas)
                    document.getElementById('meuValor').value = '';
                    document.getElementById('nomeCompra').value = '';
                    document.getElementById('numeroParcelas').value = '';
                    document.getElementById('contaRecorrente').checked = false;
                    document.getElementById('compraEmAndamento').checked = false;
                    document.getElementById('numeroParcelas').disabled = false;
                    document.getElementById('compraEmAndamento').disabled = false;
                    toggleParcelasEmAndamento();
                } else {
                    // Se n√£o existir "Eu", campos vazios tamb√©m
                    document.getElementById('meuValor').value = '';
                    document.getElementById('nomeCompra').value = '';
                    document.getElementById('numeroParcelas').value = '';
                }
            } else {
                document.getElementById('formConta').reset();
                pessoasTemp = [];
                document.getElementById('compraEmAndamento').checked = false;
                document.getElementById('contaRecorrente').checked = false;
                document.getElementById('nomeCompra').value = '';
                document.getElementById('numeroParcelas').disabled = false;
                document.getElementById('compraEmAndamento').disabled = false;
                toggleParcelasEmAndamento();
            }
            
            atualizarFormulario();
            renderizarPessoasForm();
            document.getElementById('modal').classList.add('ativo');
        }

        function fecharModal() {
            document.getElementById('modal').classList.remove('ativo');
            document.getElementById('nomeConta').disabled = false;
            document.getElementById('tipoTransacao').disabled = false;
            document.getElementById('tipoConta').disabled = false;
            document.getElementById('limiteTotal').disabled = false;
            document.getElementById('diaFechamento').disabled = false;
            document.getElementById('diaVencimento').disabled = false;
            contaEditando = null;
            pessoasTemp = [];
        }

        function atualizarFormulario() {
            const tipo = document.getElementById('tipoConta').value;
            const tipoTransacao = document.getElementById('tipoTransacao').value;
            const camposCartao = document.getElementById('camposCartao');
            const checkboxAndamento = document.getElementById('compraEmAndamento');
            const checkboxRecorrente = document.getElementById('contaRecorrente');
            const grupoAndamento = document.getElementById('grupoParcelasAndamento');
            const grupoObservacoes = document.getElementById('grupoObservacoes');
            const numeroParcelas = document.getElementById('numeroParcelas');
            
            // Esconder campos de cart√£o se for recebimento OU se n√£o for cart√£o
            if (tipoTransacao === 'recebimento' || tipo !== 'cartao') {
                camposCartao.style.display = 'none';
            } else {
                camposCartao.style.display = 'block';
            }
            
            // Se for recebimento
            if (tipoTransacao === 'recebimento') {
                // Esconder checkboxes de compra em andamento e recorrente
                checkboxAndamento.parentElement.parentElement.style.display = 'none';
                checkboxRecorrente.parentElement.parentElement.style.display = 'none';
                grupoAndamento.style.display = 'none';
                
                // Desmarcar e desabilitar
                checkboxAndamento.checked = false;
                checkboxAndamento.disabled = true;
                checkboxRecorrente.checked = false;
                checkboxRecorrente.disabled = true;
                
                // Habilitar campo de parcelas
                numeroParcelas.disabled = false;
                numeroParcelas.placeholder = '1 ou vazio';
            } else {
                // Mostrar checkboxes para pagamentos
                checkboxAndamento.parentElement.parentElement.style.display = 'block';
                checkboxRecorrente.parentElement.parentElement.style.display = 'block';
                
                // Habilitar
                checkboxAndamento.disabled = false;
                checkboxRecorrente.disabled = false;
            }
            
            // Campo de observa√ß√µes sempre vis√≠vel
            grupoObservacoes.style.display = 'block';
        }
        function atualizarLabelValor() {
            const tipoTransacao = document.getElementById('tipoTransacao').value;
            const label = document.getElementById('labelMeuValor');
            
            if (tipoTransacao === 'recebimento') {
                label.textContent = 'Valor Devedor:';
            } else {
                label.textContent = 'Meu Valor:';
            }
            
            // Chamar atualizarFormulario para ajustar campos de cart√£o
            atualizarFormulario();
        }

        function adicionarPessoa() {
            const tipoTransacao = document.getElementById('tipoTransacao').value;
            const tipoLabel = tipoTransacao === 'recebimento' ? 'Entrada' : 'Compra';
            
            document.getElementById('modalFormTitulo').textContent = `Adicionar Pessoa/${tipoLabel}`;
            
            let conteudo = '<form id="formAdicionarPessoa" onsubmit="salvarNovaPessoa(event)">';
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Nome da pessoa/descri√ß√£o:</label>';
            conteudo += '<input type="text" id="nomePessoaForm" required>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += `<label>Nome da ${tipoLabel.toLowerCase()}:</label>`;
            conteudo += '<input type="text" id="nomeCompraForm" required>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Valor Total:</label>';
            conteudo += '<input type="number" id="valorTotalForm" step="0.01" required>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>N√∫mero de Parcelas:</label>';
            conteudo += '<input type="number" id="numParcelasForm" min="1" value="1" required>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<div class="checkbox-group">';
            conteudo += '<input type="checkbox" id="compraEmAndamentoForm" onchange="toggleParcelasEmAndamentoForm()">';
            conteudo += '<label for="compraEmAndamentoForm" style="font-size: 12px;">Compra em andamento</label>';
            conteudo += '</div>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal" id="grupoParcelasAndamentoForm" style="display: none;">';
            conteudo += '<label>J√° pagas:</label>';
            conteudo += '<input type="number" id="parcelasJaPagasForm" min="0" placeholder="0">';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<div class="checkbox-group">';
            conteudo += '<input type="checkbox" id="contaRecorrenteForm" onchange="toggleContaRecorrenteForm()">';
            conteudo += '<label for="contaRecorrenteForm" style="font-size: 12px;">Conta recorrente (√°gua, luz, plano...)</label>';
            conteudo += '</div>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Observa√ß√µes:</label>';
            conteudo += '<textarea id="observacoesForm" placeholder="Ex: Pagamento quinzenal, PIX, etc...&#10;Pressione Enter para nova linha" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; resize: vertical; transition: border 0.3s;"></textarea>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-acoes-modal">';
            conteudo += '<button type="button" class="btn-cancelar-modal" onclick="fecharModalForm()">Cancelar</button>';
            conteudo += '<button type="submit" class="btn-salvar-modal">Salvar</button>';
            conteudo += '</div>';
            conteudo += '</form>';
            
            document.getElementById('modalFormConteudo').innerHTML = conteudo;
            document.getElementById('modalForm').classList.add('ativo');
        }

        function fecharModalForm() {
            document.getElementById('modalForm').classList.remove('ativo');
        }

        function salvarNovaPessoa(e) {
            e.preventDefault();
            
            const nome = document.getElementById('nomePessoaForm').value;
            const nomeCompra = document.getElementById('nomeCompraForm').value;
            const valorTotal = parseFloat(document.getElementById('valorTotalForm').value);
            const ehRecorrente = document.getElementById('contaRecorrenteForm').checked;
            const observacoes = document.getElementById('observacoesForm').value;
            
            let numParcelas, parcelaAtual, parcelasTexto, valorParcela, jaPagas;
            let parcelaBase = 1;
            const mesBase = getChaveMes();
            
            if (ehRecorrente) {
                numParcelas = 1;
                valorParcela = valorTotal;
                parcelasTexto = 'recorrente';
                jaPagas = 0;
            } else if (document.getElementById('compraEmAndamentoForm').checked) {
                jaPagas = parseInt(document.getElementById('parcelasJaPagasForm').value) || 0;
                numParcelas = parseInt(document.getElementById('numParcelasForm').value) || 1;
                parcelaAtual = jaPagas + 1;
                valorParcela = valorTotal / numParcelas;
                parcelasTexto = numParcelas > 1 ? `${parcelaAtual}/${numParcelas}` : '';
                parcelaBase = parcelaAtual;
            } else {
                numParcelas = parseInt(document.getElementById('numParcelasForm').value) || 1;
                valorParcela = valorTotal / numParcelas;
                parcelasTexto = numParcelas > 1 ? `1/${numParcelas}` : '';
                jaPagas = 0;
                parcelaBase = 1;
            }
            
            const dataCompraAtual = new Date().toISOString();
            
            const novaPessoa = {
                nome,
                valor: valorParcela,
                valorTotal: valorTotal,
                parcelas: parcelasTexto,
                observacoes: observacoes,
                compras: [{
                    nome: nomeCompra,
                    valorTotal: valorTotal,
                    valorParcela: valorParcela,
                    parcelas: parcelasTexto,
                    dataCompra: new Date().toLocaleDateString('pt-BR'),
                    idUnico: dataCompraAtual + '_' + nomeCompra,
                    observacoes: observacoes,
                    _parcelaBase: parcelaBase,
                    _mesBase: mesBase
                }],
                pago: false,
                parcelasJaPagas: jaPagas
            };
            
            pessoasTemp.push(novaPessoa);
            
            renderizarPessoasForm();
            fecharModalForm();
        }

        function removerPessoa(index) {
            pessoasTemp.splice(index, 1);
            renderizarPessoasForm();
        }
        
        function removerPessoaTemp(index) {
            const pessoaRemovida = pessoasTemp[index];
            
            // Verificar se est√° editando uma conta
            if (contaEditando) {
                // Remover de todos os meses
                removerPessoaDeTodosOsMeses(contaEditando.nome, pessoaRemovida.nome);
            }
            
            pessoasTemp.splice(index, 1);
            renderizarPessoasForm();
        }
        function excluirPessoaECompras(index) {
            const pessoaRemovida = pessoasTemp[index];
            
            adicionarLog(`üóëÔ∏è INICIANDO exclus√£o via modal de edi√ß√£o`, 'importante');
            adicionarLog(`   Pessoa: ${pessoaRemovida.nome}`, 'info');
            
            // Verificar se est√° editando uma conta
            if (contaEditando) {
                // Verificar se tem compras
                if (pessoaRemovida.compras && pessoaRemovida.compras.length > 0) {
                    const compra = pessoaRemovida.compras[0];
                    
                    adicionarLog(`   Compra encontrada: ${compra.nome}`, 'info');
                    adicionarLog(`   ID √önico: ${compra.idUnico}`, 'info');
                    
                    const confirmar = confirm(
                        '‚ö†Ô∏è ATEN√á√ÉO!\n\n' +
                        `Deseja excluir "${compra.nome}" de TODOS OS MESES?\n\n` +
                        'Esta a√ß√£o remover√° todas as parcelas desta compra em todos os meses.\n\n' +
                        'Continuar?'
                    );
                    
                    if (!confirmar) {
                        adicionarLog(`   ‚ùå Exclus√£o cancelada pelo usu√°rio`, 'warning');
                        return;
                    }
                    
                    adicionarLog(`   ‚úÖ Confirmado, iniciando exclus√£o de todos os meses...`, 'success');
                    
                    // Excluir de todos os meses usando a mesma l√≥gica do clique longo
                    excluirCompraDeTodosOsMeses(contaEditando.nome, pessoaRemovida.nome, compra.idUnico);
                    
                    adicionarLog(`   ‚úÖ excluirCompraDeTodosOsMeses() executada`, 'success');
                    
                    // Remover do pessoasTemp
                    pessoasTemp.splice(index, 1);
                    adicionarLog(`   ‚úÖ Removido do pessoasTemp`, 'success');
                    
                    // Atualizar a conta no array contas do m√™s atual
                    const indexContaAtual = contas.findIndex(c => c.id === contaEditando.id);
                    if (indexContaAtual !== -1) {
                        const pessoaNaContaAtual = contas[indexContaAtual].pessoas.find(p => p.nome === pessoaRemovida.nome);
                        if (pessoaNaContaAtual) {
                            pessoaNaContaAtual.compras = pessoaNaContaAtual.compras.filter(c => c.idUnico !== compra.idUnico);
                            
                            // Se n√£o tem mais compras, remover a pessoa da conta
                            if (pessoaNaContaAtual.compras.length === 0) {
                                contas[indexContaAtual].pessoas = contas[indexContaAtual].pessoas.filter(p => p.nome !== pessoaRemovida.nome);
                                adicionarLog(`   ‚úÖ Pessoa removida da conta atual (sem compras)`, 'success');
                            } else {
                                // Recalcular valores
                                pessoaNaContaAtual.valor = pessoaNaContaAtual.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0);
                                pessoaNaContaAtual.valorTotal = pessoaNaContaAtual.compras.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                                adicionarLog(`   ‚úÖ Valores recalculados da pessoa na conta atual`, 'success');
                            }
                        }
                    }
                    
                    // Atualizar a conta editando
                    const pessoaNaContaEditando = contaEditando.pessoas.find(p => p.nome === pessoaRemovida.nome);
                    if (pessoaNaContaEditando) {
                        pessoaNaContaEditando.compras = pessoaNaContaEditando.compras.filter(c => c.idUnico !== compra.idUnico);
                        
                        // Se n√£o tem mais compras, remover a pessoa da conta
                        if (pessoaNaContaEditando.compras.length === 0) {
                            contaEditando.pessoas = contaEditando.pessoas.filter(p => p.nome !== pessoaRemovida.nome);
                            adicionarLog(`   ‚úÖ Pessoa removida da contaEditando (sem compras)`, 'success');
                        } else {
                            // Recalcular valores
                            pessoaNaContaEditando.valor = pessoaNaContaEditando.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0);
                            pessoaNaContaEditando.valorTotal = pessoaNaContaEditando.compras.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
                            adicionarLog(`   ‚úÖ Valores recalculados da pessoa na contaEditando`, 'success');
                        }
                    }
                    
                    // Salvar altera√ß√µes IMEDIATAMENTE
                    adicionarLog(`   üíæ Salvando no storage...`, 'warning');
                    salvarNoStorage();
                    adicionarLog(`   ‚úÖ Salvo no storage`, 'success');
                    
                    // Recarregar do storage para garantir consist√™ncia
                    const dadosAtualizados = localStorage.getItem('todasContas');
                    if (dadosAtualizados) {
                        todasContas = JSON.parse(dadosAtualizados);
                        adicionarLog(`   ‚úÖ todasContas recarregado`, 'success');
                    }
                    
                    // Recarregar o m√™s atual
                    carregarContasMesAtual();
                    adicionarLog(`   ‚úÖ carregarContasMesAtual() executado`, 'success');
                    
                    // Renderizar apenas a lista de pessoas do formul√°rio
                    renderizarPessoasForm();
                    
                    // Renderizar as contas na tela principal
                    renderizarContas();
                    
                    adicionarLog(`‚úÖ EXCLUS√ÉO CONCLU√çDA COM SUCESSO!`, 'importante');
                    
                    alert('Compra exclu√≠da com sucesso de todos os meses! ‚úÖ\n\nO formul√°rio permanece aberto para novas edi√ß√µes.');
                } else {
                    // Se n√£o tem compras, usar a fun√ß√£o normal
                    adicionarLog(`   ‚ö†Ô∏è Pessoa sem compras detalhadas, usando remo√ß√£o normal`, 'warning');
                    removerPessoaTemp(index);
                }
            } else {
                // Se n√£o est√° editando, apenas remover do temp
                adicionarLog(`   ‚ÑπÔ∏è N√£o est√° editando conta, removendo apenas do temp`, 'info');
                pessoasTemp.splice(index, 1);
                renderizarPessoasForm();
            }
        }

        function editarPessoa(index) {
            const pessoa = pessoasTemp[index];
            const tipoTransacao = document.getElementById('tipoTransacao').value;
            const tipoLabel = tipoTransacao === 'recebimento' ? 'Entrada' : 'Compra';
            
            document.getElementById('modalFormTitulo').textContent = `Editar Pessoa/${tipoLabel}`;
            
            let conteudo = '<form id="formEditarPessoaTemp" onsubmit="salvarEdicaoPessoaTemp(event, ' + index + ')">';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Nome da pessoa/descri√ß√£o:</label>';
            conteudo += `<input type="text" id="nomePessoaEditTemp" value="${pessoa.nome}" required>`;
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += `<label>Nome da ${tipoLabel.toLowerCase()}:</label>`;
            const nomeCompra = pessoa.compras && pessoa.compras[0] ? pessoa.compras[0].nome : '';
            conteudo += `<input type="text" id="nomeCompraEditTemp" value="${nomeCompra}" required>`;
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Valor Total:</label>';
            // CORRE√á√ÉO: Usar sempre valorTotal da PRIMEIRA compra, n√£o o valor consolidado
            const valorTotalReal = pessoa.compras && pessoa.compras[0] ? pessoa.compras[0].valorTotal : (pessoa.valorTotal || pessoa.valor);
            conteudo += `<input type="number" id="valorTotalEditTemp" step="0.01" value="${valorTotalReal}" required>`;
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>N√∫mero de Parcelas:</label>';
            // CORRE√á√ÉO: Pegar o n√∫mero de parcelas da compra, n√£o da pessoa
            let parcelas = '1';
            if (pessoa.compras && pessoa.compras[0] && pessoa.compras[0].parcelas && pessoa.compras[0].parcelas !== 'recorrente') {
                const match = pessoa.compras[0].parcelas.match(/\/(\d+)/);
                if (match) {
                    parcelas = match[1];
                }
            } else if (pessoa.parcelas && pessoa.parcelas !== 'recorrente') {
                const match = pessoa.parcelas.match(/\/(\d+)/);
                if (match) {
                    parcelas = match[1];
                }
            }
            conteudo += `<input type="number" id="numParcelasEditTemp" min="1" value="${parcelas}" required>`;
            conteudo += '</div>';
            
            // Detectar automaticamente se tem parcelas j√° pagas
            const chaveAtual = getChaveMes();
            let parcelasJaPagasDetectadas = pessoa.parcelasJaPagas || 0;
            
            // CR√çTICO: Preservar parcela base e m√™s base
            let parcelaBasePreservada = null;
            let mesBasePreservado = null;
            
            if (pessoa.compras && pessoa.compras[0]) {
                parcelaBasePreservada = pessoa.compras[0]._parcelaBase;
                mesBasePreservado = pessoa.compras[0]._mesBase;
            }
            
            // Se n√£o tem salvo, tentar detectar nos meses anteriores
            if (parcelasJaPagasDetectadas === 0 && pessoa.compras && pessoa.compras[0]) {
                const compraRef = pessoa.compras[0];
                
                Object.keys(todasContas).sort().forEach(chaveMes => {
                    if (chaveMes < chaveAtual && contaEditando) {
                        const contasMes = todasContas[chaveMes];
                        const contaEncontrada = contasMes.find(c => c.nome === contaEditando.nome);
                        
                        if (contaEncontrada) {
                            contaEncontrada.pessoas.forEach(p => {
                                if (p.nome === pessoa.nome && p.compras && p.pago) {
                                    p.compras.forEach(c => {
                                        if (c.idUnico === compraRef.idUnico || (c.nome === compraRef.nome && c.dataCompra === compraRef.dataCompra)) {
                                            parcelasJaPagasDetectadas++;
                                        }
                                    });
                                }
                            });
                        }
                    }
                });
            }
            
            const temParcelasJaPagas = parcelasJaPagasDetectadas > 0;
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<div class="checkbox-group">';
            conteudo += `<input type="checkbox" id="compraEmAndamentoEditTemp" ${temParcelasJaPagas ? 'checked' : ''} onchange="toggleParcelasEmAndamentoEditTemp()">`;
            conteudo += '<label for="compraEmAndamentoEditTemp" style="font-size: 12px;">Compra em andamento</label>';
            conteudo += '</div>';
            conteudo += '</div>';
            
            conteudo += `<div class="form-grupo-modal" id="grupoParcelasAndamentoEditTemp" style="display: ${temParcelasJaPagas ? 'block' : 'none'};">`;
            conteudo += '<label>J√° pagas:</label>';
            conteudo += `<input type="number" id="parcelasJaPagasEditTemp" min="0" value="${parcelasJaPagasDetectadas}" placeholder="0">`;
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<div class="checkbox-group">';
            // CORRE√á√ÉO: Verificar se √© recorrente na compra tamb√©m
            let ehRecorrente = false;
            if (pessoa.compras && pessoa.compras[0] && pessoa.compras[0].parcelas === 'recorrente') {
                ehRecorrente = true;
            } else if (pessoa.parcelas === 'recorrente') {
                ehRecorrente = true;
            }
            conteudo += `<input type="checkbox" id="contaRecorrenteEditTemp" ${ehRecorrente ? 'checked' : ''} onchange="toggleContaRecorrenteEditTemp()">`;
            conteudo += '<label for="contaRecorrenteEditTemp" style="font-size: 12px;">Conta recorrente (√°gua, luz, plano...)</label>';
            conteudo += '</div>';
            conteudo += '</div>';
            
            conteudo += '<div class="form-grupo-modal">';
            conteudo += '<label>Observa√ß√µes:</label>';
            const observacoes = (pessoa.compras && pessoa.compras[0] && pessoa.compras[0].observacoes) ? pessoa.compras[0].observacoes : (pessoa.observacoes || '');
            conteudo += `<textarea id="observacoesEditTemp" placeholder="Ex: Pagamento quinzenal, PIX, etc...&#10;Pressione Enter para nova linha" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; resize: vertical; transition: border 0.3s;">${observacoes}</textarea>`;
            conteudo += '</div>';
            
            // ADICIONAR campos hidden para preservar parcela base e m√™s base
            conteudo += `<input type="hidden" id="parcelaBasePreservadaEditTemp" value="${parcelaBasePreservada || ''}">`;
            conteudo += `<input type="hidden" id="mesBasePreservadoEditTemp" value="${mesBasePreservado || ''}">`;
            
            conteudo += '<div class="form-acoes-modal">';
            conteudo += '<button type="button" class="btn-cancelar-modal" onclick="fecharModalForm()">Cancelar</button>';
            conteudo += '<button type="submit" class="btn-salvar-modal">Salvar</button>';
            conteudo += '</div>';
            conteudo += '</form>';
            
            document.getElementById('modalFormConteudo').innerHTML = conteudo;
            document.getElementById('modalForm').classList.add('ativo');
        }
        function salvarEdicaoPessoaTemp(e, index) {
            e.preventDefault();
            
            const nome = document.getElementById('nomePessoaEditTemp').value;
            const nomeCompra = document.getElementById('nomeCompraEditTemp').value;
            const valorTotal = parseFloat(document.getElementById('valorTotalEditTemp').value);
            const ehRecorrente = document.getElementById('contaRecorrenteEditTemp').checked;
            const observacoes = document.getElementById('observacoesEditTemp').value;
            
            let numParcelas, parcelaAtual, parcelasTexto, valorParcela, jaPagas;
            
            // Preservar informa√ß√µes de parcela base original
            const pessoaOriginal = pessoasTemp[index];
            
            // RECUPERAR parcela base e m√™s base dos campos hidden
            const parcelaBaseHidden = document.getElementById('parcelaBasePreservadaEditTemp').value;
            const mesBaseHidden = document.getElementById('mesBasePreservadoEditTemp').value;
            
            let parcelaBaseOriginal = parcelaBaseHidden ? parseInt(parcelaBaseHidden) : null;
            let mesBaseOriginal = mesBaseHidden || null;
            
            // Se n√£o encontrou nos campos hidden, tentar recuperar da pessoa original
            if (!parcelaBaseOriginal && pessoaOriginal.compras && pessoaOriginal.compras[0]) {
                parcelaBaseOriginal = pessoaOriginal.compras[0]._parcelaBase;
                mesBaseOriginal = pessoaOriginal.compras[0]._mesBase;
            }
            
            adicionarLog(`   üìã Dados preservados - Parcela Base: ${parcelaBaseOriginal}, M√™s Base: ${mesBaseOriginal}`, 'info');
            
            if (ehRecorrente) {
                numParcelas = 1;
                valorParcela = valorTotal;
                parcelasTexto = 'recorrente';
                jaPagas = 0;
            } else if (document.getElementById('compraEmAndamentoEditTemp').checked) {
                jaPagas = parseInt(document.getElementById('parcelasJaPagasEditTemp').value) || 0;
                numParcelas = parseInt(document.getElementById('numParcelasEditTemp').value) || 1;
                parcelaAtual = jaPagas + 1;
                valorParcela = valorTotal / numParcelas;
                parcelasTexto = numParcelas > 1 ? `${parcelaAtual}/${numParcelas}` : '';
                
                // CR√çTICO: Se usu√°rio mudou as parcelas j√° pagas, atualizar parcela base
                const jaPagasOriginais = pessoaOriginal.parcelasJaPagas || 0;
                if (jaPagas !== jaPagasOriginais) {
                    parcelaBaseOriginal = parcelaAtual;
                    mesBaseOriginal = getChaveMes();
                    adicionarLog(`   üîÑ PARCELAS J√Å PAGAS MUDARAM: ${jaPagasOriginais} ‚Üí ${jaPagas}`, 'warning');
                    adicionarLog(`   üîÑ RECALCULANDO Parcela Base: ${parcelaBaseOriginal}`, 'warning');
                }
            } else {
                numParcelas = parseInt(document.getElementById('numParcelasEditTemp').value) || 1;
                valorParcela = valorTotal / numParcelas;
                
                // Manter a parcela atual se existir
                if (pessoasTemp[index].parcelas && pessoasTemp[index].parcelas !== 'recorrente') {
                    const matchAtual = pessoasTemp[index].parcelas.match(/(\d+)\/(\d+)/);
                    if (matchAtual) {
                        const parcelaAtualNum = parseInt(matchAtual[1]);
                        parcelasTexto = numParcelas > 1 ? `${parcelaAtualNum}/${numParcelas}` : '';
                        
                        // Preservar parcela base se existir
                        if (!parcelaBaseOriginal) {
                            parcelaBaseOriginal = parcelaAtualNum;
                            mesBaseOriginal = getChaveMes();
                        }
                    } else {
                        parcelasTexto = numParcelas > 1 ? `1/${numParcelas}` : '';
                    }
                } else {
                    parcelasTexto = numParcelas > 1 ? `1/${numParcelas}` : '';
                }
                jaPagas = 0;
            }
            
            // SE AINDA n√£o tem parcela base, criar agora
            if (!parcelaBaseOriginal || !mesBaseOriginal) {
                parcelaBaseOriginal = jaPagas > 0 ? jaPagas + 1 : 1;
                mesBaseOriginal = getChaveMes();
                adicionarLog(`   ‚ö†Ô∏è CRIANDO parcela base: ${parcelaBaseOriginal}, M√™s base: ${mesBaseOriginal}`, 'warning');
            }
            
            const dataCompraAtual = pessoasTemp[index].compras && pessoasTemp[index].compras[0] 
                ? pessoasTemp[index].compras[0].idUnico 
                : (new Date().toISOString() + '_' + nomeCompra);
            
            const compraEditada = {
                nome: nomeCompra,
                valorTotal: valorTotal,
                valorParcela: valorParcela,
                parcelas: parcelasTexto,
                dataCompra: new Date().toLocaleDateString('pt-BR'),
                idUnico: dataCompraAtual,
                observacoes: observacoes,
                _parcelaBase: parcelaBaseOriginal,
                _mesBase: mesBaseOriginal
            };
            
            adicionarLog(`   ‚úÖ Compra editada com _parcelaBase: ${compraEditada._parcelaBase}, _mesBase: ${compraEditada._mesBase}`, 'success');
            
            pessoasTemp[index] = {
                nome,
                valor: valorParcela,
                valorTotal: valorTotal,
                parcelas: parcelasTexto,
                observacoes: observacoes,
                compras: [compraEditada],
                pago: pessoasTemp[index].pago,
                parcelasJaPagas: jaPagas
            };
            
            adicionarLog(`   üìù Pessoa atualizada em pessoasTemp com parcelas: ${parcelasTexto}`, 'info');
            
            // NOVO: Se est√° editando uma conta existente, propagar mudan√ßas
            if (contaEditando) {
                adicionarLog(`‚úèÔ∏è EDITANDO compra atrav√©s do menu de compras: ${nome}`, 'importante');
                adicionarLog(`   üìã Parcelas j√° pagas: ${jaPagas}`, 'info');
                adicionarLog(`   üìã Parcela Base: ${parcelaBaseOriginal}, M√™s Base: ${mesBaseOriginal}`, 'info');
                
                // Atualizar a pessoa na conta real
                const pessoaNaConta = contaEditando.pessoas.find(p => p.nome === nome);
                if (pessoaNaConta) {
                    pessoaNaConta.valor = valorParcela;
                    pessoaNaConta.valorTotal = valorTotal;
                    pessoaNaConta.parcelas = parcelasTexto;
                    pessoaNaConta.observacoes = observacoes;
                    pessoaNaConta.compras = [compraEditada];
                    pessoaNaConta.parcelasJaPagas = jaPagas;
                    
                    adicionarLog(`   ‚úÖ Pessoa atualizada na conta real com parcelas: ${parcelasTexto}`, 'success');
                }
                
                adicionarLog(`   üîÑ Iniciando propaga√ß√£o para todos os meses...`, 'info');
                
                // Propagar edi√ß√£o para todos os meses
                propagarEdicaoCompraParaTodosMeses(
                    contaEditando.nome,
                    nome,
                    compraEditada,
                    parcelaBaseOriginal,
                    mesBaseOriginal
                );
                
                adicionarLog(`   ‚úÖ Propaga√ß√£o conclu√≠da`, 'success');
                
                // Se aumentou as parcelas j√° pagas, adicionar meses retroativos extras
                if (jaPagas > 0) {
                    adicionarLog(`   üîÑ Adicionando ${jaPagas} meses retroativos extras...`, 'warning');
                    adicionarCompraEmAndamentoRetroativa(
                        contaEditando.nome,
                        [{
                            nome: nome,
                            valor: valorParcela,
                            valorTotal: valorTotal,
                            parcelas: parcelasTexto,
                            observacoes: observacoes,
                            compras: [compraEditada],
                            pago: false,
                            parcelasJaPagas: jaPagas
                        }],
                        jaPagas
                    );
                }
                
                // LIMPEZA FINAL: Remover pessoas vazias AP√ìS adicionar retroativos
                adicionarLog(`   üßπ LIMPEZA FINAL: Removendo pessoas vazias em TODOS os meses`, 'warning');
                let pessoasRemovidasFinal = 0;
                
                Object.keys(todasContas).forEach(chaveMes => {
                    const contasMes = todasContas[chaveMes];
                    const contaEncontrada = contasMes.find(c => c.nome === contaEditando.nome);
                    
                    if (contaEncontrada) {
                        const qtdAntes = contaEncontrada.pessoas.length;
                        
                        contaEncontrada.pessoas = contaEncontrada.pessoas.filter(p => {
                            if (p.nome !== nome) return true;
                            
                            const temCompras = p.compras && p.compras.length > 0;
                            const valorTotal = p.compras ? p.compras.reduce((sum, c) => sum + (c.valorParcela || 0), 0) : p.valor;
                            
                            const manter = temCompras && valorTotal > 0;
                            
                            if (!manter) {
                                adicionarLog(`      ‚ùå M√™s ${chaveMes}: Removendo "${p.nome}" (Compras: ${temCompras}, Valor: ${valorTotal})`, 'warning');
                            }
                            
                            return manter;
                        });
                        
                        if (contaEncontrada.pessoas.length < qtdAntes) {
                            pessoasRemovidasFinal++;
                        }
                    }
                });
                
                if (pessoasRemovidasFinal > 0) {
                    adicionarLog(`   ‚úÖ ${pessoasRemovidasFinal} pessoas vazias removidas`, 'success');
                } else {
                    adicionarLog(`   ‚ÑπÔ∏è Nenhuma pessoa vazia encontrada`, 'info');
                }
                
                // Salvar PRIMEIRO no localStorage via propaga√ß√£o
                localStorage.setItem('todasContas', JSON.stringify(todasContas));
                
                adicionarLog(`   üíæ For√ßando recarga do localStorage`, 'warning');
                
                // FOR√áAR recarga COMPLETA do localStorage
                const dadosAtualizadosAgora = localStorage.getItem('todasContas');
                if (dadosAtualizadosAgora) {
                    todasContas = JSON.parse(dadosAtualizadosAgora);
                    adicionarLog(`   ‚úÖ todasContas recarregado`, 'success');
                }
                
                // Recarregar o m√™s atual COM OS DADOS NOVOS
                carregarContasMesAtual();
                adicionarLog(`   ‚úÖ carregarContasMesAtual() executado`, 'success');
                
                // Renderizar interface
                renderizarContas();
                
                adicionarLog(`‚úÖ Edi√ß√£o salva com sucesso!`, 'success');
                
                // Fechar TODOS os modais abertos
                fecharModalForm();
                fecharModal();
                
                // Limpar vari√°veis tempor√°rias
                contaEditando = null;
                pessoasTemp = [];
                
                return; // Sair da fun√ß√£o
            }
            
            renderizarPessoasForm();
            fecharModalForm();
        }

        function renderizarPessoasForm() {
            const lista = document.getElementById('pessoasLista');
            if (pessoasTemp.length === 0) {
                lista.innerHTML = '<p style="color: #999; text-align: center; font-size: 12px;">Nenhuma pessoa/parcela adicionada</p>';
                return;
            }
            
            lista.innerHTML = pessoasTemp.map((p, i) => {
                // Verificar se a pessoa tem compras detalhadas
                const temCompras = p.compras && p.compras.length > 0;
                
                if (temCompras && p.compras.length === 1) {
                    // Se tem apenas 1 compra, mostrar bot√µes de editar e excluir diretos
                    return `
                        <div class="pessoa-item">
                            <span>${p.nome} ${p.parcelas ? `(${p.parcelas})` : ''}: R$ ${p.valor.toFixed(2)}</span>
                            <div>
                                <button type="button" class="btn-editar-pessoa" onclick="editarPessoa(${i})">‚úèÔ∏è</button>
                                <button type="button" class="btn-remover" onclick="excluirPessoaECompras(${i})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                } else if (temCompras && p.compras.length > 1) {
                    // Se tem m√∫ltiplas compras, mostrar apenas bot√£o de editar
                    return `
                        <div class="pessoa-item">
                            <span>${p.nome} ${p.parcelas ? `(${p.parcelas})` : ''}: R$ ${p.valor.toFixed(2)}</span>
                            <div>
                                <button type="button" class="btn-editar-pessoa" onclick="editarPessoa(${i})">‚úèÔ∏è</button>
                                <button type="button" class="btn-remover" onclick="removerPessoaTemp(${i})">‚úï</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Sem compras detalhadas, usar ‚úï
                    return `
                        <div class="pessoa-item">
                            <span>${p.nome} ${p.parcelas ? `(${p.parcelas})` : ''}: R$ ${p.valor.toFixed(2)}</span>
                            <div>
                                <button type="button" class="btn-editar-pessoa" onclick="editarPessoa(${i})">‚úèÔ∏è</button>
                                <button type="button" class="btn-remover" onclick="removerPessoaTemp(${i})">‚úï</button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function salvarConta(e) {
            e.preventDefault();
            
            const meuValor = parseFloat(document.getElementById('meuValor').value) || 0;
            
            const pessoas = [...pessoasTemp];
            
            if (meuValor > 0) {
                let numParcelas, parcelaAtual, parcelasTexto, valorParcela;
                const ehRecorrente = document.getElementById('contaRecorrente').checked;
                
                if (ehRecorrente) {
                    // Conta recorrente - sem parcelas
                    numParcelas = 1;
                    valorParcela = meuValor;
                    parcelasTexto = 'recorrente';
                } else if (document.getElementById('compraEmAndamento').checked) {
                    const jaPagas = parseInt(document.getElementById('parcelasJaPagas').value) || 0;
                    numParcelas = parseInt(document.getElementById('numeroParcelas').value) || 1;
                    parcelaAtual = jaPagas + 1;
                    valorParcela = meuValor / numParcelas;
                    parcelasTexto = numParcelas > 1 ? `${parcelaAtual}/${numParcelas}` : '';
                } else {
                    numParcelas = parseInt(document.getElementById('numeroParcelas').value) || 1;
                    valorParcela = meuValor / numParcelas;
                    parcelasTexto = numParcelas > 1 ? `1/${numParcelas}` : '';
                }
                
                const tipoTransacao = document.getElementById('tipoTransacao').value;
                const nomeCompraForm = document.getElementById('nomeCompra').value.trim();
                const nomeCompraInicial = nomeCompraForm || (tipoTransacao === 'recebimento' ? 'Recebimento inicial' : 'Compra inicial');
                const observacoesForm = document.getElementById('observacoes').value || '';
                
                const dataCompraAtual = new Date().toISOString();
                
                pessoas.unshift({
                    nome: 'Eu',
                    valor: valorParcela,
                    valorTotal: meuValor,
                    parcelas: parcelasTexto,
                    compras: [{
                        nome: nomeCompraInicial,
                        valorTotal: meuValor,
                        valorParcela: valorParcela,
                        parcelas: parcelasTexto,
                        dataCompra: new Date().toLocaleDateString('pt-BR'),
                        idUnico: dataCompraAtual + '_' + nomeCompraInicial,
                        observacoes: observacoesForm
                    }],
                    pago: false
                });
            }
            
            const nomeContaNovo = document.getElementById('nomeConta').value;
            const nomeContaAntigo = contaEditando ? contaEditando.nome : null;
            
            const conta = {
                id: contaEditando ? contaEditando.id : Date.now(),
                nome: nomeContaNovo,
                tipoTransacao: document.getElementById('tipoTransacao').value,
                tipo: document.getElementById('tipoConta').value,
                limiteTotal: parseFloat(document.getElementById('limiteTotal').value) || 0,
                diaFechamento: parseInt(document.getElementById('diaFechamento').value) || null,
                diaVencimento: parseInt(document.getElementById('diaVencimento').value) || null,
                observacoes: document.getElementById('observacoes').value || null,
                pessoas: pessoas,
                pago: document.getElementById('contaPaga').checked
            };
            
            // Verificar se h√° compra em andamento para adicionar meses retroativos
            const ehCompraEmAndamento = document.getElementById('compraEmAndamento').checked;
            const jaPagas = ehCompraEmAndamento ? (parseInt(document.getElementById('parcelasJaPagas').value) || 0) : 0;
            
            if (contaEditando) {
                const index = contas.findIndex(c => c.id === contaEditando.id);
                const contaExistente = contas[index];
                
                // ==========================================
                // VERIFICAR SE O NOME DA CONTA MUDOU
                // ==========================================
                if (nomeContaAntigo && nomeContaAntigo !== nomeContaNovo) {
                    adicionarLog(`üîÑ NOME DA CONTA MUDOU: "${nomeContaAntigo}" ‚Üí "${nomeContaNovo}"`, 'importante');
                    
                    // Atualizar nome em TODOS os meses
                    Object.keys(todasContas).forEach(chaveMes => {
                        const contasMes = todasContas[chaveMes];
                        const contaEncontrada = contasMes.find(c => c.nome === nomeContaAntigo);
                        
                        if (contaEncontrada) {
                            contaEncontrada.nome = nomeContaNovo;
                            adicionarLog(`   ‚úÖ M√™s ${chaveMes}: Nome atualizado`, 'success');
                        }
                    });
                }
                
                // ==========================================
                // ATUALIZAR PROPRIEDADES DA CONTA EM TODOS OS MESES
                // ==========================================
                Object.keys(todasContas).forEach(chaveMes => {
                    const contasMes = todasContas[chaveMes];
                    const contaEncontrada = contasMes.find(c => c.nome === nomeContaNovo);
                    
                    if (contaEncontrada) {
                        contaEncontrada.tipo = conta.tipo;
                        contaEncontrada.tipoTransacao = conta.tipoTransacao;
                        contaEncontrada.limiteTotal = conta.limiteTotal;
                        contaEncontrada.diaFechamento = conta.diaFechamento;
                        contaEncontrada.diaVencimento = conta.diaVencimento;
                        contaEncontrada.observacoes = conta.observacoes;
                    }
                });
                
                // N√ÉO preservar o estado de pagamento - ser√° recalculado ao final
                
                // ==========================================
                // AN√ÅLISE: O QUE O USU√ÅRIO EST√Å FAZENDO?
                // ==========================================
                
                const meuValorPreenchido = parseFloat(document.getElementById('meuValor').value) || 0;
                const temNovasPessoasTemp = pessoasTemp.length > 0;
                
                // Identificar pessoas que foram REMOVIDAS
                // CORRE√á√ÉO: Incluir todas as pessoas existentes que n√£o foram tocadas
                const pessoaEuExistia = contaExistente.pessoas.find(p => p.nome === 'Eu');
                const nomesPessoasNovas = [...pessoasTemp.map(p => p.nome)];
                
                // Se "Eu" j√° existia E n√£o preencheu meuValor, significa que n√£o est√° removendo, apenas n√£o est√° editando
                if (meuValorPreenchido > 0) {
                    nomesPessoasNovas.push('Eu');
                } else if (pessoaEuExistia) {
                    // Se "Eu" j√° existia e n√£o preencheu o campo, manter "Eu" na lista (n√£o remover)
                    nomesPessoasNovas.push('Eu');
                }
                
                const pessoasRemovidas = contaExistente.pessoas.filter(p => 
                    !nomesPessoasNovas.includes(p.nome)
                );
                
                // Remover apenas pessoas que foram REALMENTE deletadas de TODOS os meses
                pessoasRemovidas.forEach(pessoaRemovida => {
                    removerPessoaDeTodosOsMeses(nomeContaNovo, pessoaRemovida.nome);
                });
                
                // ==========================================
                // CONSTRUIR LISTA FINAL DE PESSOAS
                // ==========================================
                
                const pessoasFinais = [];
                
                // ==========================================
                // PROCESSAR "EU"
                // ==========================================
                
                const pessoaEuExistente = contaExistente.pessoas.find(p => p.nome === 'Eu');
                
                if (meuValorPreenchido > 0) {
                    // Usu√°rio PREENCHEU "Meu Valor" = Quer EDITAR ou ADICIONAR "Eu"
                    const pessoaEuNova = conta.pessoas.find(p => p.nome === 'Eu');
                    
                    if (pessoaEuExistente) {
                        // "Eu" J√Å EXISTIA = EDI√á√ÉO
                        
                        // Remover compras antigas de "Eu" de todos os meses
                        if (pessoaEuExistente.compras && pessoaEuExistente.compras.length > 0) {
                            pessoaEuExistente.compras.forEach(compraAntiga => {
                                excluirCompraDeTodosOsMeses(nomeContaNovo, 'Eu', compraAntiga.idUnico);
                            });
                        }
                        
                        // Adicionar novas compras de "Eu" em todos os meses
                        if (pessoaEuNova && pessoaEuNova.compras && pessoaEuNova.compras.length > 0) {
                            propagarComprasParaTodosMeses(nomeContaNovo, [pessoaEuNova]);
                        }
                        
                        pessoasFinais.push(pessoaEuNova);
                        
                        // Se tem parcelas j√° pagas, adicionar retroativo
                        const ehCompraEmAndamento = document.getElementById('compraEmAndamento').checked;
                        const jaPagas = ehCompraEmAndamento ? (parseInt(document.getElementById('parcelasJaPagas').value) || 0) : 0;
                        if (jaPagas > 0 && pessoaEuNova) {
                            adicionarCompraEmAndamentoRetroativa(nomeContaNovo, [pessoaEuNova], jaPagas);
                        }
                        
                    } else {
                        // "Eu" N√ÉO EXISTIA = NOVA ADI√á√ÉO
                        pessoasFinais.push(pessoaEuNova);
                        
                        if (pessoaEuNova && pessoaEuNova.compras && pessoaEuNova.compras.length > 0) {
                            propagarComprasParaTodosMeses(nomeContaNovo, [pessoaEuNova]);
                        }
                        
                        if (pessoaEuNova && pessoaEuNova.parcelasJaPagas && pessoaEuNova.parcelasJaPagas > 0) {
                            adicionarCompraEmAndamentoRetroativa(nomeContaNovo, [pessoaEuNova], pessoaEuNova.parcelasJaPagas);
                        }
                    }
                    
                } else {
                    // Usu√°rio N√ÉO preencheu "Meu Valor"
                    
                    if (pessoaEuExistente) {
                        // "Eu" existe e n√£o foi tocado = MANTER COMO EST√Å
                        pessoasFinais.push(pessoaEuExistente);
                    }
                    // Se n√£o existe "Eu" e n√£o preencheu = n√£o adicionar
                }
                
                // ==========================================
                // PROCESSAR OUTRAS PESSOAS (pessoasTemp)
                // ==========================================
                
                pessoasTemp.forEach(novaPessoa => {
                    const pessoaExistente = contaExistente.pessoas.find(p => p.nome === novaPessoa.nome);
                    
                    adicionarLog(`üîç Processando pessoa: ${novaPessoa.nome}`, 'info');
                    if (novaPessoa.parcelasJaPagas) {
                        adicionarLog(`   üìã Possui ${novaPessoa.parcelasJaPagas} parcelas j√° pagas`, 'warning');
                    }
                    
                    if (pessoaExistente) {
                        // Pessoa J√Å EXISTIA = Verificar se foi REALMENTE editada
                    adicionarLog(`üîç Processando pessoa: ${novaPessoa.nome}`, 'info');
                        if (novaPessoa.compras && novaPessoa.compras[0]) {
                            adicionarLog(`   üìã Parcela Base: ${novaPessoa.compras[0]._parcelaBase}, M√™s Base: ${novaPessoa.compras[0]._mesBase}`, 'info');
                            if (novaPessoa.parcelasJaPagas) {
                                adicionarLog(`   üìã Possui ${novaPessoa.parcelasJaPagas} parcelas j√° pagas`, 'info');
                            }
                        }
                        
                        // Comparar se as compras mudaram OU se parcelas j√° pagas mudaram
                        let foiEditada = false;
                        
                        // FOR√áAR LOG DETALHADO
                        adicionarLog(`   üîé Comparando dados antigos vs novos:`, 'info');
                        
                        if (pessoaExistente.compras && novaPessoa.compras) {
                            // Comparar IDs das compras
                            const idsAntigos = pessoaExistente.compras.map(c => c.idUnico).sort().join(',');
                            const idsNovos = novaPessoa.compras.map(c => c.idUnico).sort().join(',');
                            
                            adicionarLog(`      IDs antigos: ${idsAntigos}`, 'info');
                            adicionarLog(`      IDs novos: ${idsNovos}`, 'info');
                            
                            if (idsAntigos !== idsNovos) {
                                foiEditada = true;
                                adicionarLog(`   üìù IDs das compras mudaram`, 'warning');
                            }
                            
                            // COMPARAR TAMB√âM O CONTE√öDO DAS COMPRAS
                            pessoaExistente.compras.forEach((compraAntiga, idx) => {
                                const compraNova = novaPessoa.compras.find(c => c.idUnico === compraAntiga.idUnico);
                                
                                if (compraNova) {
                                    if (compraAntiga.nome !== compraNova.nome) {
                                        foiEditada = true;
                                        adicionarLog(`      Nome mudou: "${compraAntiga.nome}" ‚Üí "${compraNova.nome}"`, 'warning');
                                    }
                                    
                                    if (compraAntiga.valorTotal !== compraNova.valorTotal) {
                                        foiEditada = true;
                                        adicionarLog(`      Valor total mudou: R$ ${compraAntiga.valorTotal} ‚Üí R$ ${compraNova.valorTotal}`, 'warning');
                                    }
                                    
                                    const parcelasAntigas = compraAntiga.parcelas || '';
                                    const parcelasNovas = compraNova.parcelas || '';
                                    
                                    if (parcelasAntigas !== parcelasNovas) {
                                        const matchAntigo = parcelasAntigas.match(/\/(\d+)/);
                                        const matchNovo = parcelasNovas.match(/\/(\d+)/);
                                        
                                        const totalAntigo = matchAntigo ? parseInt(matchAntigo[1]) : 1;
                                        const totalNovo = matchNovo ? parseInt(matchNovo[1]) : 1;
                                        
                                        if (totalAntigo !== totalNovo) {
                                            foiEditada = true;
                                            adicionarLog(`      N√∫mero de parcelas mudou: ${totalAntigo} ‚Üí ${totalNovo}`, 'warning');
                                        }
                                    }
                                    
                                    if (compraAntiga._parcelaBase !== compraNova._parcelaBase) {
                                        foiEditada = true;
                                        adicionarLog(`      Parcela base mudou: ${compraAntiga._parcelaBase} ‚Üí ${compraNova._parcelaBase}`, 'warning');
                                    }
                                }
                            });
                        }
                        
                        // Verificar mudan√ßa em parcelas j√° pagas
                        const parcelasJaPagasAntigas = pessoaExistente.parcelasJaPagas || 0;
                        const parcelasJaPagasNovas = novaPessoa.parcelasJaPagas || 0;
                        
                        adicionarLog(`      Parcelas j√° pagas antigas: ${parcelasJaPagasAntigas}`, 'info');
                        adicionarLog(`      Parcelas j√° pagas novas: ${parcelasJaPagasNovas}`, 'info');
                        
                        if (parcelasJaPagasAntigas !== parcelasJaPagasNovas) {
                            foiEditada = true;
                            adicionarLog(`   üìù Parcelas j√° pagas mudaram: ${parcelasJaPagasAntigas} ‚Üí ${parcelasJaPagasNovas}`, 'warning');
                        }
                        
                        // Verificar mudan√ßa no valor total
                        const valorTotalAntigo = pessoaExistente.valorTotal || pessoaExistente.valor;
                        const valorTotalNovo = novaPessoa.valorTotal || novaPessoa.valor;
                        
                        if (valorTotalAntigo !== valorTotalNovo) {
                            foiEditada = true;
                            adicionarLog(`   üìù Valor total mudou: R$ ${valorTotalAntigo} ‚Üí R$ ${valorTotalNovo}`, 'warning');
                        }
                        
                        adicionarLog(`   üéØ Resultado: ${foiEditada ? 'FOI EDITADA' : 'N√ÉO foi editada'}`, foiEditada ? 'importante' : 'info');
                        
                        if (foiEditada) {
                            adicionarLog(`‚úèÔ∏è Pessoa foi REALMENTE editada: ${novaPessoa.nome}`, 'warning');
                            
                            // Remover compras antigas
                            if (pessoaExistente.compras && pessoaExistente.compras.length > 0) {
                                adicionarLog(`   üóëÔ∏è Removendo ${pessoaExistente.compras.length} compras antigas`, 'info');
                                pessoaExistente.compras.forEach(compraAntiga => {
                                    excluirCompraDeTodosOsMeses(nomeContaNovo, novaPessoa.nome, compraAntiga.idUnico);
                                });
                            }
                            
                            // Remover parcelas retroativas antigas
                            if (parcelasJaPagasAntigas > 0) {
                                adicionarLog(`   üóëÔ∏è Removendo ${parcelasJaPagasAntigas} parcelas retroativas antigas`, 'warning');
                            }
                            
                            // PRIMEIRO: Adicionar parcelas retroativas
                            if (novaPessoa.parcelasJaPagas && novaPessoa.parcelasJaPagas > 0) {
                                adicionarLog(`   üîÑ Processando ${novaPessoa.parcelasJaPagas} parcelas retroativas`, 'warning');
                                adicionarCompraEmAndamentoRetroativa(nomeContaNovo, [novaPessoa], novaPessoa.parcelasJaPagas);
                            }
                            
                            // DEPOIS: Propagar para meses futuros
                            if (novaPessoa.compras && novaPessoa.compras.length > 0) {
                                adicionarLog(`   üì§ Propagando ${novaPessoa.compras.length} compras para meses futuros`, 'info');
                                propagarComprasParaTodosMeses(nomeContaNovo, [novaPessoa]);
                            }
                        } else {
                            adicionarLog(`‚úì Pessoa n√£o foi editada, mantendo: ${novaPessoa.nome}`, 'info');
                        }
                        
                        // Usar dados corretos
                        const pessoaFinal = foiEditada ? novaPessoa : pessoaExistente;
                        
                        // GARANTIR que parcelasJaPagas est√° presente
                        if (!pessoaFinal.parcelasJaPagas && novaPessoa.parcelasJaPagas) {
                            pessoaFinal.parcelasJaPagas = novaPessoa.parcelasJaPagas;
                        }
                        
                        // GARANTIR _parcelaBase e _mesBase nas compras
                        if (pessoaFinal.compras && pessoaFinal.compras.length > 0) {
                            pessoaFinal.compras.forEach(compra => {
                                if (!compra._parcelaBase || !compra._mesBase) {
                                    const chaveAtual = getChaveMes();
                                    compra._parcelaBase = pessoaFinal.parcelasJaPagas 
                                        ? (pessoaFinal.parcelasJaPagas + 1) 
                                        : (compra.parcelas && compra.parcelas.match(/(\d+)\//) 
                                            ? parseInt(compra.parcelas.match(/(\d+)\//)[1]) 
                                            : 1);
                                    compra._mesBase = chaveAtual;
                                }
                            });
                        }
                        
                        // IMPORTANTE: Sempre garantir que parcelasJaPagas est√° presente
                        if (!pessoaFinal.parcelasJaPagas && novaPessoa.parcelasJaPagas) {
                            pessoaFinal.parcelasJaPagas = novaPessoa.parcelasJaPagas;
                        }
                        
                        // GARANTIR que _parcelaBase e _mesBase estejam presentes nas compras
                        if (pessoaFinal.compras && pessoaFinal.compras.length > 0) {
                            pessoaFinal.compras.forEach(compra => {
                                if (!compra._parcelaBase || !compra._mesBase) {
                                    const chaveAtual = getChaveMes();
                                    compra._parcelaBase = pessoaFinal.parcelasJaPagas 
                                        ? (pessoaFinal.parcelasJaPagas + 1) 
                                        : (compra.parcelas && compra.parcelas.match(/(\d+)\//) 
                                            ? parseInt(compra.parcelas.match(/(\d+)\//)[1]) 
                                            : 1);
                                    compra._mesBase = chaveAtual;
                                }
                            });
                        }
                        
                        pessoasFinais.push(pessoaFinal);
                        
                    } else {
                        // Pessoa N√ÉO EXISTIA = NOVA
                        adicionarLog(`‚ûï Adicionando nova pessoa: ${novaPessoa.nome}`, 'success');
                        
                        pessoasFinais.push(novaPessoa);
                        
                        // PRIMEIRO: Adicionar parcelas retroativas (ANTES de propagar)
                        if (novaPessoa.parcelasJaPagas && novaPessoa.parcelasJaPagas > 0) {
                            adicionarLog(`   üîÑ Processando ${novaPessoa.parcelasJaPagas} parcelas retroativas ANTES de propagar`, 'warning');
                            adicionarCompraEmAndamentoRetroativa(nomeContaNovo, [novaPessoa], novaPessoa.parcelasJaPagas);
                        }
                        
                        // DEPOIS: Propagar para meses futuros
                        if (novaPessoa.compras && novaPessoa.compras.length > 0) {
                            adicionarLog(`   üì§ Propagando ${novaPessoa.compras.length} compras para meses futuros`, 'info');
                            propagarComprasParaTodosMeses(nomeContaNovo, [novaPessoa]);
                        }
                        
                        conta.pago = false;
                    }
                });
                
                // ==========================================
                // ADICIONAR PESSOAS QUE N√ÉO FORAM TOCADAS
                // ==========================================
                
                contaExistente.pessoas.forEach(pessoaExistente => {
                    // Se n√£o √© "Eu" e n√£o est√° em pessoasTemp e n√£o foi removida
                    if (pessoaExistente.nome !== 'Eu' && 
                        !pessoasTemp.some(p => p.nome === pessoaExistente.nome) &&
                        !pessoasRemovidas.some(p => p.nome === pessoaExistente.nome)) {
                        
                        // Verificar se j√° n√£o foi adicionada
                        if (!pessoasFinais.some(p => p.nome === pessoaExistente.nome)) {
                            pessoasFinais.push(pessoaExistente);
                        }
                    }
                });
                
                // ==========================================
                // FINALIZAR
                // ==========================================
                
                conta.pessoas = pessoasFinais;
                contas[index] = conta;
                
            } else {
                contas.push(conta);
                adicionarLog(`üÜï NOVA CONTA CRIADA: ${conta.nome}`, 'importante');
                adicionarLog(`   Pessoas adicionadas: ${conta.pessoas.map(p => p.nome).join(', ')}`, 'info');
                
                // PRIMEIRO: Propagar para meses futuros (cria estrutura base)
                adicionarLog(`üì§ Propagando compras para meses futuros...`, 'info');
                propagarComprasParaTodosMeses(conta.nome, conta.pessoas);
                
                // DEPOIS: Adicionar parcelas retroativas (sobrescreve/adiciona nos meses passados)
                // Se for compra em andamento DO MEU VALOR, adicionar aos meses anteriores
                if (ehCompraEmAndamento && jaPagas > 0) {
                    adicionarLog(`üîÑ Processando "Eu" com ${jaPagas} parcelas j√° pagas`, 'warning');
                    const pessoaEu = conta.pessoas.find(p => p.nome === 'Eu');
                    if (pessoaEu) {
                        adicionarCompraEmAndamentoRetroativa(conta.nome, [pessoaEu], jaPagas);
                    }
                }
                
                // Processar parcelas retroativas de TODAS as pessoasTemp
                pessoasTemp.forEach(pessoaTemp => {
                    if (pessoaTemp.parcelasJaPagas && pessoaTemp.parcelasJaPagas > 0) {
                        adicionarLog(`üîÑ Processando "${pessoaTemp.nome}" com ${pessoaTemp.parcelasJaPagas} parcelas j√° pagas`, 'warning');
                        adicionarCompraEmAndamentoRetroativa(conta.nome, [pessoaTemp], pessoaTemp.parcelasJaPagas);
                    }
                });
                
                adicionarLog(`‚úÖ CONTA SALVA COM SUCESSO!`, 'success');
            }
            
            // ========================================
            // RECALCULAR STATUS DE PAGAMENTO DA CONTA
            // ========================================
            // A conta s√≥ est√° paga se TODAS as pessoas est√£o pagas
            const todasPessoasPagas = conta.pessoas.length > 0 && conta.pessoas.every(p => p.pago);
            conta.pago = todasPessoasPagas;
            // Limpar pessoas com valor zero em TODOS os meses antes de salvar
            Object.keys(todasContas).forEach(chaveMes => {
                todasContas[chaveMes].forEach(contaMes => {
                    contaMes.pessoas = contaMes.pessoas.filter(p => {
                        const temValor = p.valor > 0;
                        const temCompras = p.compras && p.compras.length > 0 && p.compras.some(c => c.valorParcela > 0);
                        return temValor || temCompras;
                    });
                });
            });
            
            // Salvar SEMPRE, independente do fluxo
            salvarNoStorage();
            // Salvar SEMPRE, independente do fluxo
            salvarNoStorage();
            
            // FOR√áAR recarga completa do localStorage
            const dadosAtualizados = localStorage.getItem('todasContas');
            if (dadosAtualizados) {
                todasContas = JSON.parse(dadosAtualizados);
            }
            
            // Recarregar para garantir consist√™ncia
            carregarContasMesAtual();
            
            // Renderizar com dados atualizados
            renderizarContas();
            
            // Fechar modal
            fecharModal();
        }

        function excluirConta(id) {
            const conta = contas.find(c => c.id === id);
            const confirmacao = confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja realmente excluir a conta "${conta.nome}" de TODOS OS MESES?\n\nEsta a√ß√£o n√£o pode ser desfeita!`);
            if (!confirmacao) return;
            
            const nomeConta = conta.nome;
            
            // Excluir de todos os meses
            Object.keys(todasContas).forEach(chaveMes => {
                todasContas[chaveMes] = todasContas[chaveMes].filter(c => c.nome !== nomeConta);
            });
            
            // Remover do m√™s atual tamb√©m
            contas = contas.filter(c => c.id !== id);
            
            // Salvar altera√ß√µes
            localStorage.setItem('todasContas', JSON.stringify(todasContas));
            renderizarContas();
        }

        function togglePagoConta(id) {
            const conta = contas.find(c => c.id === id);
            
            if (conta.pago) {
                // Se est√° pago e quer desmarcar, perguntar confirma√ß√£o
                const confirmar = confirm(`‚ö†Ô∏è Desmarcar Pagamento\n\nDesmarcar "${conta.nome}" como paga?\n\nIsso desmarcar√° TODAS as pessoas/compras desta conta.`);
                if (!confirmar) {
                    return;
                }
                
                // Desmarcar tudo
                conta.pago = false;
                conta.pessoas.forEach(p => p.pago = false);
            } else {
                // Se n√£o est√° pago e quer marcar, marcar tudo
                conta.pago = true;
                conta.pessoas.forEach(p => p.pago = true);
            }
            
            // CR√çTICO: Salvar IMEDIATAMENTE
            salvarNoStorage();
            
            // Recarregar do storage para garantir consist√™ncia
            carregarContasMesAtual();
            
            // Renderizar com dados atualizados
            renderizarContas();
        }

        function togglePagoPessoa(contaId, pessoaIndex) {
            const conta = contas.find(c => c.id === contaId);
            const pessoa = conta.pessoas[pessoaIndex];
            
            if (pessoa.pago) {
                let nomePessoa = pessoa.nome;
                if (pessoa.nome === 'Eu' && conta.tipoTransacao === 'recebimento') {
                    nomePessoa = 'Devedor';
                }
                
                const confirmar = confirm(`‚ö†Ô∏è Reverter Pagamento\n\nDesmarcar "${nomePessoa}" como pago?\n\nValor: R$ ${pessoa.valor.toFixed(2)}`);
                if (!confirmar) {
                    return;
                }
            }
            
            // Alternar status de pago
            conta.pessoas[pessoaIndex].pago = !conta.pessoas[pessoaIndex].pago;
            
            // ========================================
            // RECALCULAR STATUS DA CONTA
            // ========================================
            // A conta s√≥ est√° paga se TODAS as pessoas est√£o pagas
            const todasPagas = conta.pessoas.every(p => p.pago);
            conta.pago = todasPagas;
            
            // CR√çTICO: Salvar IMEDIATAMENTE antes de renderizar
            salvarNoStorage();
            
            // Recarregar do storage para garantir consist√™ncia
            carregarContasMesAtual();
            
            // Renderizar com dados atualizados
            renderizarContas();
        }

        function calcularTotal(conta) {
            return conta.pessoas.reduce((sum, p) => sum + p.valor, 0);
        }

        function calcularLimiteDisponivel(conta) {
            if (!conta.limiteTotal) return 0;
            
            const chaveAtual = getChaveMes();
            let totalOcupadoGeral = 0;
            let totalLiberadoPorPagamentos = 0;
            
            // Percorrer TODOS os meses para calcular o total ocupado e o total liberado
            Object.keys(todasContas).forEach(chaveMes => {
                const contasMes = todasContas[chaveMes];
                const contaEncontrada = contasMes.find(c => c.nome === conta.nome);
                
                if (contaEncontrada) {
                    contaEncontrada.pessoas.forEach(pessoa => {
                        if (pessoa.compras && pessoa.compras.length > 0) {
                            pessoa.compras.forEach(compra => {
                                // Verificar se a compra ainda n√£o foi totalmente paga
                                const parcelaMatch = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                
                                if (parcelaMatch) {
                                    const parcelaAtual = parseInt(parcelaMatch[1]);
                                    const totalParcelas = parseInt(parcelaMatch[2]);
                                    
                                    // Se for a primeira parcela, adiciona o valor total ao ocupado
                                    if (parcelaAtual === 1) {
                                        totalOcupadoGeral += compra.valorTotal;
                                    }
                                } else if (!compra.parcelas) {
                                    // Compra sem parcelamento
                                    totalOcupadoGeral += compra.valorTotal;
                                }
                                
                                // Se foi pago, adiciona ao total liberado
                                if (pessoa.pago) {
                                    totalLiberadoPorPagamentos += compra.valorParcela;
                                }
                            });
                        } else {
                            // Pessoa sem compras detalhadas
                            const parcelaMatch = pessoa.parcelas ? pessoa.parcelas.match(/(\d+)\/(\d+)/) : null;
                            
                            if (parcelaMatch) {
                                const parcelaAtual = parseInt(parcelaMatch[1]);
                                
                                if (parcelaAtual === 1) {
                                    totalOcupadoGeral += pessoa.valorTotal || pessoa.valor;
                                }
                            } else {
                                totalOcupadoGeral += pessoa.valorTotal || pessoa.valor;
                            }
                            
                            if (pessoa.pago) {
                                totalLiberadoPorPagamentos += pessoa.valor;
                            }
                        }
                    });
                }
            });
            
            return conta.limiteTotal - totalOcupadoGeral + totalLiberadoPorPagamentos;
        }
        function mostrarDetalhesPessoa(contaId, pessoaIndex) {
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const pessoa = conta.pessoas[pessoaIndex];
            if (!pessoa || !pessoa.compras) return;
            
            let nomePessoa = pessoa.nome;
            if (pessoa.nome === 'Eu' && conta.tipoTransacao === 'recebimento') {
                nomePessoa = 'Devedor';
            }
            
            const ehRecebimento = conta.tipoTransacao === 'recebimento';
            const tipoLabel = ehRecebimento ? 'RECEBIMENTOS' : 'COMPRAS';
            const icone = ehRecebimento ? 'üí∞' : 'üõí';
            const labelParcela = ehRecebimento ? 'Valor a receber este m√™s' : 'Valor deste m√™s';
            
            // T√≠tulo e subt√≠tulo
            document.getElementById('modalDetalhesTitulo').innerHTML = `üìä ${nomePessoa}`;
            document.getElementById('modalDetalhesSubtitulo').textContent = conta.nome;
            
            // Conte√∫do
            let conteudoHTML = '';
            
            // Resumo do m√™s atual
            conteudoHTML += `
                <div class="modal-detalhes-resumo ${ehRecebimento ? 'recebimento' : ''}">
                    <div class="modal-detalhes-resumo-label">${labelParcela}</div>
                    <div class="modal-detalhes-resumo-valor">R$ ${pessoa.valor.toFixed(2)}</div>
                </div>
            `;
            
            // Se√ß√£o de compras
            conteudoHTML += `
                <div class="modal-detalhes-secao">
                    <div class="modal-detalhes-secao-titulo">${icone} ${tipoLabel}</div>
            `;
            
            let totalGeral = 0;
            pessoa.compras.forEach((compra, idx) => {
                const nomeCompra = compra.nome || 'Sem nome';
                const dataCompra = compra.dataCompra || 'Data n√£o registrada';
                const valorTotal = compra.valorTotal || 0;
                const valorParcela = compra.valorParcela || 0;
                const parcelas = compra.parcelas || '';
                const observacoes = compra.observacoes || '';
                
                totalGeral += valorTotal;
                
                conteudoHTML += `
                    <div class="detalhes-compra-card ${ehRecebimento ? 'recebimento' : ''}">
                        <div class="detalhes-compra-nome">
                            <span>${idx + 1}. ${nomeCompra}</span>
                            ${parcelas ? `<span class="detalhes-compra-badge ${ehRecebimento ? 'recebimento' : ''}">${parcelas}</span>` : ''}
                        </div>
                        <div class="detalhes-compra-info">
                            <div class="detalhes-compra-info-item">
                                <div class="detalhes-compra-info-label">üìÖ Data</div>
                                <div>${dataCompra}</div>
                            </div>
                            <div class="detalhes-compra-info-item">
                                <div class="detalhes-compra-info-label">üí∞ Valor Total</div>
                                <div class="detalhes-compra-info-valor ${ehRecebimento ? 'recebimento' : ''}">R$ ${valorTotal.toFixed(2)}</div>
                            </div>
                            <div class="detalhes-compra-info-item" style="grid-column: 1 / -1;">
                                <div class="detalhes-compra-info-label">${labelParcela}</div>
                                <div class="detalhes-compra-info-valor ${ehRecebimento ? 'recebimento' : ''}">R$ ${valorParcela.toFixed(2)}</div>
                            </div>
                            ${observacoes ? `
                            <div class="detalhes-compra-info-item" style="grid-column: 1 / -1;">
                                <div class="detalhes-compra-info-label">üìù Observa√ß√µes</div>
                                <div style="color: #666; font-size: 12px; white-space: pre-wrap; word-break: break-word;">${observacoes}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            conteudoHTML += `</div>`;
            
            // Total geral
            conteudoHTML += `
                <div class="modal-detalhes-total ${ehRecebimento ? 'recebimento' : ''}">
                    <div class="modal-detalhes-total-label">TOTAL ${ehRecebimento ? 'A RECEBER' : 'DAS COMPRAS'}</div>
                    <div class="modal-detalhes-total-valor">R$ ${totalGeral.toFixed(2)}</div>
                </div>
            `;
            
            document.getElementById('modalDetalhesConteudo').innerHTML = conteudoHTML;
            document.getElementById('modalDetalhes').classList.add('ativo');
        }

        function mostrarDetalhesTotal() {
            // Calcular apenas os gastos da pessoa "Eu"
            const totalPagamentos = contas
                .filter(c => c.tipoTransacao !== 'recebimento')
                .reduce((sum, c) => {
                    const minhasCompras = c.pessoas
                        .filter(p => p.nome === 'Eu')
                        .reduce((total, p) => total + p.valor, 0);
                    return sum + minhasCompras;
                }, 0);
            
            // Calcular apenas os recebimentos da pessoa "Eu" (ou "Devedor")
            const totalRecebimentos = contas
                .filter(c => c.tipoTransacao === 'recebimento')
                .reduce((sum, c) => {
                    const meusRecebimentos = c.pessoas
                        .filter(p => p.nome === 'Eu')
                        .reduce((total, p) => total + p.valor, 0);
                    return sum + meusRecebimentos;
                }, 0);
            
            const saldo = totalRecebimentos - totalPagamentos;
            const saldoPositivo = saldo >= 0;
            
            // Contar quantidades
            const qtdPagamentos = contas.filter(c => c.tipoTransacao !== 'recebimento').length;
            const qtdRecebimentos = contas.filter(c => c.tipoTransacao === 'recebimento').length;
            
            // Contar quantas contas est√£o pagas
            const contasPagas = contas.filter(c => c.pago).length;
            const contasPendentes = contas.length - contasPagas;
            
            // Calcular totais gerais (todas as pessoas) para informa√ß√£o adicional
            const totalGeralPagamentos = contas
                .filter(c => c.tipoTransacao !== 'recebimento')
                .reduce((sum, c) => sum + calcularTotal(c), 0);
            
            const totalGeralRecebimentos = contas
                .filter(c => c.tipoTransacao === 'recebimento')
                .reduce((sum, c) => sum + calcularTotal(c), 0);
            
            let conteudoHTML = '';
            
            // Card de Gastos (apenas "Eu")
            conteudoHTML += `
                <div class="resumo-card">
                    <div class="resumo-card-label">üí∏ Meus Gastos</div>
                    <div class="resumo-card-valor">R$ ${totalPagamentos.toFixed(2)}</div>
                    ${qtdPagamentos > 0 ? `<div style="font-size: 12px; opacity: 0.9; margin-top: 8px;">${qtdPagamentos} ${qtdPagamentos === 1 ? 'conta' : 'contas'} de pagamento</div>` : ''}
                    ${totalGeralPagamentos !== totalPagamentos ? `<div style="font-size: 11px; opacity: 0.95; margin-top: 4px; color: #ffffff; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px;">Total geral (com outras pessoas): R$ ${totalGeralPagamentos.toFixed(2)}</div>` : ''}
                </div>
            `;
            
            // Card de Recebimentos (apenas "Eu")
            conteudoHTML += `
                <div class="resumo-card recebimentos">
                    <div class="resumo-card-label">üí∞ Meus Recebimentos</div>
                    <div class="resumo-card-valor">R$ ${totalRecebimentos.toFixed(2)}</div>
                    ${qtdRecebimentos > 0 ? `<div style="font-size: 12px; opacity: 0.9; margin-top: 8px;">${qtdRecebimentos} ${qtdRecebimentos === 1 ? 'conta' : 'contas'} de recebimento</div>` : ''}
                    ${totalGeralRecebimentos !== totalRecebimentos ? `<div style="font-size: 11px; opacity: 0.95; margin-top: 4px; color: #ffffff; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px;">Total geral (com outras pessoas): R$ ${totalGeralRecebimentos.toFixed(2)}</div>` : ''}
                </div>
            `;
            
            // Divisor
            conteudoHTML += `<hr class="resumo-divisor">`;
            
            // Saldo Final (baseado apenas em "Eu")
            conteudoHTML += `
                <div class="resumo-saldo">
                    <div class="resumo-saldo-header">
                        <div class="resumo-icone-grande">${saldoPositivo ? 'üíö' : 'üî¥'}</div>
                        <div class="resumo-saldo-label">Meu Saldo do M√™s</div>
                        <div class="resumo-saldo-valor ${saldoPositivo ? 'positivo' : 'negativo'}">
                            R$ ${Math.abs(saldo).toFixed(2)}
                        </div>
                        <div class="resumo-saldo-badge ${saldoPositivo ? 'positivo' : 'negativo'}">
                            ${saldoPositivo ? '‚úÖ Saldo Positivo' : '‚ö†Ô∏è Saldo Negativo'}
                        </div>
                    </div>
                    
                    <div class="resumo-detalhes">
                        <div class="resumo-detalhes-item">
                            <span class="resumo-detalhes-label">‚úÖ Contas Pagas</span>
                            <span class="resumo-detalhes-valor">${contasPagas} de ${contas.length}</span>
                        </div>
                        <div class="resumo-detalhes-item">
                            <span class="resumo-detalhes-label">‚è≥ Contas Pendentes</span>
                            <span class="resumo-detalhes-valor">${contasPendentes}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Informa√ß√£o adicional
            if (saldoPositivo && saldo > 0) {
                conteudoHTML += `
                    <div class="resumo-info-box">
                        üí° Voc√™ tem R$ ${saldo.toFixed(2)} dispon√≠vel ap√≥s pagar todas as suas contas deste m√™s!
                    </div>
                `;
            } else if (!saldoPositivo) {
                conteudoHTML += `
                    <div class="resumo-info-box" style="background: #ffebee; border-left-color: #f44336; color: #c62828;">
                        ‚ö†Ô∏è Aten√ß√£o: Seus gastos excedem seus recebimentos em R$ ${Math.abs(saldo).toFixed(2)} neste m√™s.
                    </div>
                `;
            }
            
            // Informa√ß√£o sobre outras pessoas (se houver)
            const temOutrasPessoas = contas.some(c => c.pessoas.some(p => p.nome !== 'Eu'));
            if (temOutrasPessoas) {
                const totalOutrasPessoas = totalGeralPagamentos - totalPagamentos;
                if (totalOutrasPessoas > 0) {
                    conteudoHTML += `
                        <div class="resumo-info-box" style="background: #e3f2fd; border-left-color: #2196F3; color: #1565C0;">
                            üë• Outras pessoas t√™m R$ ${totalOutrasPessoas.toFixed(2)} em compras/despesas cadastradas neste m√™s.
                        </div>
                    `;
                }
            }
            
            document.getElementById('modalResumoConteudo').innerHTML = conteudoHTML;
            document.getElementById('modalResumo').classList.add('ativo');
        }

        function verificarPendenciasConta(nomeConta) {
            const chaveAtual = getChaveMes();
            const [anoAtual, mesAtual] = chaveAtual.split('-').map(Number);
            const dataAtualMes = new Date(anoAtual, mesAtual - 1);
            
            let pendencias = [];
            
            // Determinar se √© recebimento ou pagamento
            const contaAtualRef = contas.find(c => c.nome === nomeConta);
            const ehRecebimento = contaAtualRef && contaAtualRef.tipoTransacao === 'recebimento';
            
            if (ehRecebimento) {
                // ==========================================
                // L√ìGICA PARA RECEBIMENTOS
                // ==========================================
                
                const recebimentosInfo = new Map();
                
                // PRIMEIRA PASSADA: Coletar informa√ß√µes sobre todos os recebimentos
                Object.keys(todasContas).sort().forEach(chaveMes => {
                    const [ano, mes] = chaveMes.split('-').map(Number);
                    const dataMes = new Date(ano, mes - 1);
                    
                    if (dataMes <= dataAtualMes) {
                        const contasMes = todasContas[chaveMes];
                        const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                        
                        if (contaEncontrada) {
                            contaEncontrada.pessoas.forEach(pessoa => {
                                if (pessoa.compras && pessoa.compras.length > 0) {
                                    pessoa.compras.forEach(compra => {
                                        const idCompra = compra.idUnico || (compra.nome + '_' + compra.dataCompra);
                                        
                                        if (!recebimentosInfo.has(idCompra)) {
                                            let totalParcelas = 1;
                                            const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                            if (match) {
                                                totalParcelas = parseInt(match[2]);
                                            }
                                            
                                            recebimentosInfo.set(idCompra, {
                                                totalParcelas: totalParcelas,
                                                parcelasPagas: 0,
                                                maiorParcelaVista: 0,
                                                mesesDetalhados: [],
                                                recorrente: compra.parcelas === 'recorrente',
                                                ehParcelaUnica: !compra.parcelas || compra.parcelas === '',
                                                valorParcela: compra.valorParcela,
                                                valorTotal: compra.valorTotal,
                                                nome: compra.nome,
                                                nomePessoa: pessoa.nome === 'Eu' ? 'Devedor' : pessoa.nome,
                                                mesOrigem: chaveMes
                                            });
                                        }
                                        
                                        const info = recebimentosInfo.get(idCompra);
                                        
                                        // Rastrear qual √© a maior parcela vista at√© agora
                                        const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                                        if (match) {
                                            const parcelaNum = parseInt(match[1]);
                                            if (parcelaNum > info.maiorParcelaVista) {
                                                info.maiorParcelaVista = parcelaNum;
                                            }
                                        }
                                        
                                        // Registrar detalhes deste m√™s
                                        info.mesesDetalhados.push({
                                            mes: chaveMes,
                                            pago: pessoa.pago,
                                            parcela: compra.parcelas
                                        });
                                        
                                        // Contar se foi pago
                                        if (pessoa.pago) {
                                            info.parcelasPagas++;
                                        }
                                    });
                                } else {
                                    // Pessoa sem compras detalhadas
                                    const idGenerico = pessoa.nome + '_' + pessoa.valor + '_' + (pessoa.parcelas || 'unico');
                                    
                                    if (!recebimentosInfo.has(idGenerico)) {
                                        let totalParcelas = 1;
                                        const match = pessoa.parcelas ? pessoa.parcelas.match(/(\d+)\/(\d+)/) : null;
                                        if (match) {
                                            totalParcelas = parseInt(match[2]);
                                        }
                                        
                                        recebimentosInfo.set(idGenerico, {
                                            totalParcelas: totalParcelas,
                                            parcelasPagas: 0,
                                            maiorParcelaVista: 0,
                                            mesesDetalhados: [],
                                            recorrente: pessoa.parcelas === 'recorrente',
                                            ehParcelaUnica: !pessoa.parcelas || pessoa.parcelas === '',
                                            valorParcela: pessoa.valor,
                                            valorTotal: pessoa.valorTotal || pessoa.valor,
                                            nome: 'Valor direto',
                                            nomePessoa: pessoa.nome === 'Eu' ? 'Devedor' : pessoa.nome,
                                            mesOrigem: chaveMes
                                        });
                                    }
                                    
                                    const info = recebimentosInfo.get(idGenerico);
                                    
                                    const match = pessoa.parcelas ? pessoa.parcelas.match(/(\d+)\/(\d+)/) : null;
                                    if (match) {
                                        const parcelaNum = parseInt(match[1]);
                                        if (parcelaNum > info.maiorParcelaVista) {
                                            info.maiorParcelaVista = parcelaNum;
                                        }
                                    }
                                    
                                    info.mesesDetalhados.push({
                                        mes: chaveMes,
                                        pago: pessoa.pago,
                                        parcela: pessoa.parcelas
                                    });
                                    
                                    if (pessoa.pago) {
                                        info.parcelasPagas++;
                                    }
                                }
                            });
                        }
                    }
                });
                
                // SEGUNDA PASSADA: Criar pend√™ncias baseado nas informa√ß√µes coletadas
                recebimentosInfo.forEach((info, idCompra) => {
                    let quantidadePendencias = 0;
                    
                    if (info.recorrente) {
                        // Recorrente: cada m√™s n√£o pago √© uma pend√™ncia
                        quantidadePendencias = info.mesesDetalhados.filter(m => !m.pago).length;
                    } else if (info.ehParcelaUnica) {
                        // *** CORRE√á√ÉO PRINCIPAL: Parcela √∫nica ***
                        // Se N√ÉO foi pago em nenhum m√™s anterior (exceto atual), √© pend√™ncia
                        const foiPagoEmMesAnterior = info.mesesDetalhados.some(m => m.mes !== chaveAtual && m.pago);
                        if (!foiPagoEmMesAnterior && info.mesOrigem !== chaveAtual) {
                            quantidadePendencias = 1;
                        }
                    } else {
                        // Parcelado: maior parcela vista - parcelas pagas
                        const parcelasQueJaPassaram = Math.min(info.maiorParcelaVista, info.totalParcelas);
                        quantidadePendencias = parcelasQueJaPassaram - info.parcelasPagas;
                    }
                    
                    if (quantidadePendencias > 0) {
                        // Adicionar pend√™ncias para os meses n√£o pagos (exceto o atual)
                        let pendenciasAdicionadas = 0;
                        
                        info.mesesDetalhados
                            .filter(m => m.mes !== chaveAtual && !m.pago)
                            .forEach(mesInfo => {
                                if (pendenciasAdicionadas < quantidadePendencias) {
                                    pendencias.push({
                                        mes: mesInfo.mes,
                                        nomePessoa: info.nomePessoa,
                                        nomeCompra: info.nome,
                                        valor: info.valorParcela,
                                        valorTotal: info.valorTotal,
                                        parcelas: mesInfo.parcela,
                                        tipoTransacao: 'recebimento',
                                        idCompra: idCompra
                                    });
                                    pendenciasAdicionadas++;
                                }
                            });
                    }
                });
                
            } else {
                // ==========================================
                // L√ìGICA PARA PAGAMENTOS (ORIGINAL)
                // ==========================================
                
                Object.keys(todasContas).sort().forEach(chaveMes => {
                    const [ano, mes] = chaveMes.split('-').map(Number);
                    const dataMes = new Date(ano, mes - 1);
                    
                    if (dataMes <= dataAtualMes) {
                        const contasMes = todasContas[chaveMes];
                        const contaEncontrada = contasMes.find(c => c.nome === nomeConta);
                        
                        if (contaEncontrada) {
                            contaEncontrada.pessoas.forEach(pessoa => {
                                if (pessoa.compras && pessoa.compras.length > 0) {
                                    pessoa.compras.forEach(compra => {
                                        const idCompra = compra.idUnico || (compra.nome + '_' + compra.dataCompra);
                                        
                                        if (!pessoa.pago) {
                                            if (compra.parcelas === 'recorrente' || pessoa.parcelas === 'recorrente') {
                                                if (chaveMes !== chaveAtual) {
                                                    const jaAdicionado = pendencias.some(p => 
                                                        p.idCompra === idCompra && p.mes === chaveMes
                                                    );
                                                    
                                                    if (!jaAdicionado) {
                                                        pendencias.push({
                                                            mes: chaveMes,
                                                            nomePessoa: pessoa.nome,
                                                            nomeCompra: compra.nome,
                                                            valor: compra.valorParcela,
                                                            valorTotal: compra.valorTotal,
                                                            parcelas: compra.parcelas || pessoa.parcelas,
                                                            tipoTransacao: contaEncontrada.tipoTransacao,
                                                            idCompra: idCompra
                                                        });
                                                    }
                                                }
                                            } else {
                                                if (chaveMes !== chaveAtual) {
                                                    const jaAdicionado = pendencias.some(p => 
                                                        p.idCompra === idCompra && p.mes === chaveMes
                                                    );
                                                    
                                                    if (!jaAdicionado) {
                                                        pendencias.push({
                                                            mes: chaveMes,
                                                            nomePessoa: pessoa.nome,
                                                            nomeCompra: compra.nome,
                                                            valor: compra.valorParcela,
                                                            valorTotal: compra.valorTotal,
                                                            parcelas: compra.parcelas || pessoa.parcelas,
                                                            tipoTransacao: contaEncontrada.tipoTransacao,
                                                            idCompra: idCompra
                                                        });
                                                    }
                                                }
                                            }
                                        }
                                    });
                                } else {
                                    const idGenerico = pessoa.nome + '_' + pessoa.valor + '_' + (pessoa.parcelas || 'unico');
                                    
                                    if (!pessoa.pago) {
                                        if (pessoa.parcelas === 'recorrente') {
                                            if (chaveMes !== chaveAtual) {
                                                const jaAdicionado = pendencias.some(p => 
                                                    p.idCompra === idGenerico && p.mes === chaveMes
                                                );
                                                
                                                if (!jaAdicionado) {
                                                    pendencias.push({
                                                        mes: chaveMes,
                                                        nomePessoa: pessoa.nome,
                                                        nomeCompra: 'Valor direto',
                                                        valor: pessoa.valor,
                                                        valorTotal: pessoa.valorTotal || pessoa.valor,
                                                        parcelas: pessoa.parcelas,
                                                        tipoTransacao: contaEncontrada.tipoTransacao,
                                                        idCompra: idGenerico
                                                    });
                                                }
                                            }
                                        } else {
                                            if (chaveMes !== chaveAtual) {
                                                const jaAdicionado = pendencias.some(p => 
                                                    p.idCompra === idGenerico && p.mes === chaveMes
                                                );
                                                
                                                if (!jaAdicionado) {
                                                    pendencias.push({
                                                        mes: chaveMes,
                                                        nomePessoa: pessoa.nome,
                                                        nomeCompra: 'Valor direto',
                                                        valor: pessoa.valor,
                                                        valorTotal: pessoa.valorTotal || pessoa.valor,
                                                        parcelas: pessoa.parcelas,
                                                        tipoTransacao: contaEncontrada.tipoTransacao,
                                                        idCompra: idGenerico
                                                    });
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }
                });
            }
            
            return pendencias;
        }
        
        function mostrarPendenciasConta(nomeConta) {
            const pendencias = verificarPendenciasConta(nomeConta);
            
            document.getElementById('modalPendenciasTitulo').innerHTML = `‚ö†Ô∏è PEND√äNCIAS - ${nomeConta}`;
            
            if (pendencias.length === 0) {
                document.getElementById('modalPendenciasSubtitulo').textContent = '';
                document.getElementById('modalPendenciasConteudo').innerHTML = `
                    <div class="pendencia-sem-resultado">
                        <div class="pendencia-sem-resultado-icone">‚úÖ</div>
                        <div class="pendencia-sem-resultado-texto">Nenhuma pend√™ncia encontrada</div>
                        <div class="pendencia-sem-resultado-sub">Todos os pagamentos est√£o em dia! üéâ</div>
                    </div>
                `;
                document.getElementById('modalPendencias').classList.add('ativo');
                return;
            }
            
            document.getElementById('modalPendenciasSubtitulo').textContent = 
                `Total de ${pendencias.length} ${pendencias.length === 1 ? 'pagamento atrasado' : 'pagamentos atrasados'}`;
            
            // Agrupar por m√™s
            const porMes = {};
            pendencias.forEach(p => {
                if (!porMes[p.mes]) porMes[p.mes] = [];
                porMes[p.mes].push(p);
            });
            
            let conteudoHTML = '';
            
            Object.keys(porMes).sort().forEach(mes => {
                const [ano, mesNum] = mes.split('-');
                const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const mesesCurtos = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                
                conteudoHTML += `<div class="pendencia-mes">`;
                conteudoHTML += `<div class="pendencia-mes-titulo">üìÖ ${mesesCurtos[parseInt(mesNum) - 1]}/${ano}</div>`;
                
                // Agrupar por pessoa dentro do m√™s
                const porPessoa = {};
                porMes[mes].forEach(p => {
                    if (!porPessoa[p.nomePessoa]) porPessoa[p.nomePessoa] = [];
                    porPessoa[p.nomePessoa].push(p);
                });
                
                Object.keys(porPessoa).forEach(nomePessoa => {
                    const comprasDaPessoa = porPessoa[nomePessoa];
                    const icone = comprasDaPessoa[0].tipoTransacao === 'recebimento' ? 'üí∞' : 'üí∏';
                    
                    conteudoHTML += `<div class="pendencia-pessoa">`;
                    conteudoHTML += `<div class="pendencia-pessoa-nome">${icone} ${nomePessoa}</div>`;
                    
                    comprasDaPessoa.forEach(compra => {
                        conteudoHTML += `<div class="pendencia-compra">`;
                        conteudoHTML += `<div class="pendencia-compra-nome">‚Ä¢ ${compra.nomeCompra}</div>`;
                        conteudoHTML += `<div class="pendencia-compra-valor">R$ ${compra.valor.toFixed(2)}`;
                        
                        if (compra.parcelas && compra.parcelas !== 'recorrente') {
                            conteudoHTML += ` <span style="font-size: 12px; font-weight: normal;">(${compra.parcelas})</span>`;
                        } else if (compra.parcelas === 'recorrente') {
                            conteudoHTML += ` <span style="font-size: 12px; font-weight: normal;">(Recorrente)</span>`;
                        }
                        
                        conteudoHTML += `</div>`;
                        
                        if (compra.valorTotal && compra.valorTotal !== compra.valor) {
                            conteudoHTML += `<div class="pendencia-compra-info">Valor total: R$ ${compra.valorTotal.toFixed(2)}</div>`;
                        }
                        
                        conteudoHTML += `</div>`;
                    });
                    
                    conteudoHTML += `</div>`;
                });
                
                conteudoHTML += `</div>`;
            });
            
            const totalPendente = pendencias.reduce((sum, p) => sum + p.valor, 0);
            
            conteudoHTML += `
                <div class="pendencia-total">
                    <div class="pendencia-total-titulo">TOTAL PENDENTE</div>
                    <div class="pendencia-total-valor">R$ ${totalPendente.toFixed(2)}</div>
                </div>
            `;
            
            document.getElementById('modalPendenciasConteudo').innerHTML = conteudoHTML;
            document.getElementById('modalPendencias').classList.add('ativo');
        }

function mostrarDetalhesValor(contaId) {
            const conta = contas.find(c => c.id === contaId);
            if (!conta) return;
            
            const totalMensal = calcularTotal(conta);
            const ehRecebimento = conta.tipoTransacao === 'recebimento';
            
            let totalCompleto = 0;
            let totalJaPago = 0;
            
            const chaveAtual = getChaveMes();
            const [anoAtual, mesAtualNum] = chaveAtual.split('-').map(Number);
            
            conta.pessoas.forEach(pessoa => {
                if (pessoa.compras && pessoa.compras.length > 0) {
                    pessoa.compras.forEach(compra => {
                        const match = compra.parcelas ? compra.parcelas.match(/(\d+)\/(\d+)/) : null;
                        
                        if (match) {
                            const parcelaAtual = parseInt(match[1]);
                            const totalParcelas = parseInt(match[2]);
                            
                            totalCompleto += compra.valorTotal;
                            
                            Object.keys(todasContas).forEach(chaveMes => {
                                const [ano, mes] = chaveMes.split('-').map(Number);
                                const dataMes = new Date(ano, mes - 1);
                                const dataAtualMes = new Date(anoAtual, mesAtualNum - 1);
                                
                                if (dataMes < dataAtualMes) {
                                    const contasMes = todasContas[chaveMes];
                                    const contaEncontrada = contasMes.find(c => c.nome === conta.nome);
                                    
                                    if (contaEncontrada) {
                                        contaEncontrada.pessoas.forEach(p => {
                                            if (p.compras && p.pago) {
                                                p.compras.forEach(c => {
                                                    if (c.idUnico === compra.idUnico || 
                                                        (c.nome === compra.nome && c.valorTotal === compra.valorTotal)) {
                                                        totalJaPago += c.valorParcela;
                                                    }
                                                });
                                            }
                                        });
                                    }
                                }
                            });
                            
                            if (pessoa.pago) {
                                totalJaPago += compra.valorParcela;
                            }
                            
                        } else if (compra.parcelas === 'recorrente') {
                            totalCompleto += compra.valorTotal;
                            if (pessoa.pago) {
                                totalJaPago += compra.valorParcela;
                            }
                        } else {
                            totalCompleto += compra.valorTotal;
                            if (pessoa.pago) {
                                totalJaPago += compra.valorTotal;
                            }
                        }
                    });
                } else {
                    const match = pessoa.parcelas ? pessoa.parcelas.match(/(\d+)\/(\d+)/) : null;
                    
                    if (match) {
                        const parcelaAtual = parseInt(match[1]);
                        const totalParcelas = parseInt(match[2]);
                        
                        totalCompleto += pessoa.valorTotal || (pessoa.valor * totalParcelas);
                        
                        Object.keys(todasContas).forEach(chaveMes => {
                            const [ano, mes] = chaveMes.split('-').map(Number);
                            const dataMes = new Date(ano, mes - 1);
                            const dataAtualMes = new Date(anoAtual, mesAtualNum - 1);
                            
                            if (dataMes < dataAtualMes) {
                                const contasMes = todasContas[chaveMes];
                                const contaEncontrada = contasMes.find(c => c.nome === conta.nome);
                                
                                if (contaEncontrada) {
                                    contaEncontrada.pessoas.forEach(p => {
                                        if (p.nome === pessoa.nome && p.pago) {
                                            totalJaPago += p.valor;
                                        }
                                    });
                                }
                            }
                        });
                        
                        if (pessoa.pago) {
                            totalJaPago += pessoa.valor;
                        }
                        
                    } else if (pessoa.parcelas === 'recorrente') {
                        totalCompleto += pessoa.valor;
                        if (pessoa.pago) {
                            totalJaPago += pessoa.valor;
                        }
                    } else {
                        totalCompleto += pessoa.valor;
                        if (pessoa.pago) {
                            totalJaPago += pessoa.valor;
                        }
                    }
                }
            });
            
            const totalRestante = totalCompleto - totalJaPago;
            const percentualPago = totalCompleto > 0 ? (totalJaPago / totalCompleto) * 100 : 0;
            
            // Montar o modal
            const icone = ehRecebimento ? 'üí∞' : 'üí≥';
            document.getElementById('modalValorTitulo').innerHTML = `${icone} ${conta.nome}`;
            document.getElementById('modalValorSubtitulo').textContent = `Detalhamento financeiro completo`;
            
            let conteudoHTML = '';
            
            // Card do valor mensal
            conteudoHTML += `
                <div class="modal-valor-card ${ehRecebimento ? 'recebimento' : ''}">
                    <div class="modal-valor-card-label">${ehRecebimento ? 'üíµ Valor a Receber Este M√™s' : 'üí∏ Valor a Pagar Este M√™s'}</div>
                    <div class="modal-valor-card-valor ${ehRecebimento ? 'recebimento' : ''}">R$ ${totalMensal.toFixed(2)}</div>
                </div>
            `;
            
            // Informa√ß√µes detalhadas
            if (totalMensal !== totalCompleto) {
                conteudoHTML += `
                    <div class="modal-valor-info ${ehRecebimento ? 'recebimento' : ''}">
                        <div class="modal-valor-info-row">
                            <span class="modal-valor-info-label">üí∞ Valor Total (todas parcelas)</span>
                            <span class="modal-valor-info-valor">R$ ${totalCompleto.toFixed(2)}</span>
                        </div>
                        <div class="modal-valor-info-row">
                            <span class="modal-valor-info-label">‚úÖ J√° ${ehRecebimento ? 'Recebido' : 'Pago'}</span>
                            <span class="modal-valor-info-valor">R$ ${totalJaPago.toFixed(2)}</span>
                        </div>
                        <div class="modal-valor-info-row">
                            <span class="modal-valor-info-label">‚è≥ Restante</span>
                            <span class="modal-valor-info-valor">R$ ${totalRestante.toFixed(2)}</span>
                        </div>
                        <div class="modal-valor-info-row">
                            <span class="modal-valor-info-label">üìä Progresso</span>
                            <span class="modal-valor-info-valor">${percentualPago.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }
            
            // Mensagem de status
            if (totalMensal === totalCompleto && totalRestante === 0) {
                conteudoHTML += `
                    <div class="modal-valor-destaque">
                        <div class="modal-valor-destaque-texto">
                            ‚úÖ <strong>Pagamento √önico ou Parcela Final</strong><br>
                            Esta conta foi totalmente ${ehRecebimento ? 'recebida' : 'paga'}. N√£o h√° valores pendentes.
                        </div>
                    </div>
                `;
            } else if (totalMensal === totalCompleto && totalRestante > 0) {
                conteudoHTML += `
                    <div class="modal-valor-destaque alerta">
                        <div class="modal-valor-destaque-texto">
                            ‚ö†Ô∏è <strong>Pagamento √önico ou Parcela Final</strong><br>
                            Este √© o valor total a ${ehRecebimento ? 'receber' : 'pagar'} neste m√™s.
                        </div>
                    </div>
                `;
            } else {
                conteudoHTML += `
                    <div class="modal-valor-destaque">
                        <div class="modal-valor-destaque-texto">
                            üí° <strong>Pagamento Parcelado em Andamento</strong><br>
                            Voc√™ j√° ${ehRecebimento ? 'recebeu' : 'pagou'} R$ ${totalJaPago.toFixed(2)} de um total de R$ ${totalCompleto.toFixed(2)}. 
                            Faltam R$ ${totalRestante.toFixed(2)} para finalizar.
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalValorConteudo').innerHTML = conteudoHTML;
            document.getElementById('modalValor').classList.add('ativo');
        }
        function renderizarContas() {
            const lista = document.getElementById('listaContas');
            
            adicionarLog(`üé® renderizarContas() - Total de contas: ${contas.length}`, 'info');
            contas.forEach(c => {
                adicionarLog(`   ${c.nome}: ${c.pessoas.length} pessoas`, 'info');
            });
            
            if (contas.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Nenhuma conta cadastrada. Clique em "Adicionar Conta" para come√ßar.</p>';
                document.getElementById('totalValor').textContent = 'R$ 0,00';
                return;
            }
            
            lista.innerHTML = contas.map(conta => {
                const total = calcularTotal(conta);
                const limiteDisp = calcularLimiteDisponivel(conta);
                
                return `
                    <div class="conta ${conta.pago ? 'pago' : ''} ${conta.tipoTransacao === 'recebimento' ? 'recebimento' : ''}">
                        <div class="conta-header">
                            <div>
                                <span class="conta-nome">${conta.tipoTransacao === 'recebimento' ? 'üí∞' : '‚û°Ô∏è'} ${conta.nome}</span>
                                ${conta.pago ? '<span class="status-badge badge-pago">‚úÖ PAGO</span>' : '<span class="status-badge badge-pendente">‚è≥ Pendente</span>'}
                            </div>
                            <span class="conta-valor" style="cursor: pointer; white-space: nowrap;" onclick="mostrarDetalhesValor(${conta.id})" title="Clique para ver detalhes">R$ ${total.toFixed(2)}</span>
                        </div>
                        
                        ${conta.pessoas && conta.pessoas.length > 0 ? `
                            <div style="margin: 10px 0;">
                                ${[...conta.pessoas].sort((a, b) => a.nome === 'Eu' ? -1 : b.nome === 'Eu' ? 1 : 0).map((p) => {
                                    const i = conta.pessoas.indexOf(p);
                                    let nomePessoa = p.nome;
                                    if (p.nome === 'Eu' && conta.tipoTransacao === 'recebimento') {
                                        nomePessoa = 'Devedor';
                                    }
                                    const temCompras = p.compras && p.compras.length > 0;
                                    return `
                                        <div class="pessoa ${p.pago ? 'pago' : ''}" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                            <span 
                                                onclick="togglePagoPessoa(${conta.id}, ${i})" 
                                                ontouchstart="iniciarLongPress(${conta.id}, ${i}, event)"
                                                ontouchend="cancelarLongPress()"
                                                ontouchmove="cancelarLongPress()"
                                                style="flex: 1; user-select: none;">
                                                ${nomePessoa}: R$ ${p.valor.toFixed(2)} ${p.pago ? '‚úì' : ''}
                                            </span>
                                            ${temCompras ? `<span onclick="mostrarDetalhesPessoa(${conta.id}, ${i})" style="color: #667eea; font-size: 11px; margin-left: 8px; white-space: nowrap;" title="Ver detalhes">‚ÑπÔ∏è detalhes</span>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<p style="color: #999; font-size: 12px; margin: 10px 0; text-align: center;">Nenhum item cadastrado ainda</p>'}
                        
                        ${conta.tipo === 'cartao' ? `
                            <div class="info-conta">
                                ${conta.diaFechamento ? `‚óâ Fecha: ${conta.diaFechamento}` : ''} 
                                ${conta.diaVencimento ? `/ ‚óâ Venc: ${conta.diaVencimento}` : ''}
                                ${conta.limiteTotal ? `<br>‚óâ <span class="limite">(Limite disp: ${limiteDisp.toLocaleString('pt-BR', {minimumFractionDigits: 2})})</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="acoes">
                            <button class="btn-pequeno btn-pagar" onclick="togglePagoConta(${conta.id})">
                                ${conta.pago ? '‚Ü©Ô∏è Desfazer' : '‚úÖ Marcar Pago'}
                            </button>
                            <button class="btn-pequeno" onclick="mostrarPendenciasConta('${conta.nome.replace(/'/g, "\\'")}')" style="background: ${verificarPendenciasConta(conta.nome).length > 0 ? '#dc3545' : '#6c757d'}; color: white;">
                                üìã Pend√™ncias ${verificarPendenciasConta(conta.nome).length > 0 ? `(${verificarPendenciasConta(conta.nome).length})` : ''}
                            </button>
                            <button class="btn-pequeno btn-editar" onclick='abrirModal(${JSON.stringify(conta).replace(/'/g, "&apos;")})'>‚úèÔ∏è Editar</button>
                            <button class="btn-pequeno btn-excluir" onclick="excluirConta(${conta.id})">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Calcular total de pagamentos (excluindo recebimentos)
            const totalPagamentos = contas
                .filter(c => c.tipoTransacao !== 'recebimento')
                .reduce((sum, c) => sum + calcularTotal(c), 0);
            
            document.getElementById('totalValor').textContent = `R$ ${totalPagamentos.toFixed(2)}`;
        }

        inicializar();
        
        // Prevenir sa√≠da acidental ao recarregar ou fechar
        window.addEventListener('beforeunload', function (e) {
            if (contas.length > 0) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
        
        // Prevenir uso do bot√£o voltar
        history.pushState(null, null, location.href);
        window.addEventListener('popstate', function () {
            if (contas.length > 0) {
                if (confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ tem contas cadastradas. Deseja realmente sair?\n\nTodos os dados n√£o salvos ser√£o perdidos!')) {
                    history.back();
                } else {
                    history.pushState(null, null, location.href);
                }
            }
        });
        
        // ===== PREVENIR SUBMIT COM ENTER NO TEXTAREA =====
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keydown', function(e) {
                // Se o elemento focado √© um textarea e a tecla pressionada √© Enter
                if (e.target.tagName === 'TEXTAREA' && e.key === 'Enter') {
                    // N√£o fazer nada, deixar o Enter funcionar normalmente no textarea
                    return;
                }
            });
            
            // Prevenir submit do formul√°rio ao pressionar Enter em qualquer campo
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('keydown', function(e) {
                    // Se a tecla √© Enter E n√£o √© um textarea
                    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        return false;
                    }
                });
            });
        });
        
        // ===== PWA: REGISTRAR SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('‚úÖ Service Worker registrado:', reg.scope))
                    .catch(err => console.error('‚ùå Erro ao registrar SW:', err));
            });
        }
        
        // ===== PWA: PROMPT DE INSTALA√á√ÉO =====
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('üì± PWA instal√°vel detectado');
            
            // Opcional: Mostrar bot√£o de instala√ß√£o personalizado
            // (Voc√™ pode adicionar um bot√£o no HTML se desejar)
        });
    </script>
</body>
</html>
